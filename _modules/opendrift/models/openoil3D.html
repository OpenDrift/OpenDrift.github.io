

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>opendrift.models.openoil3D &mdash; OpenDrift  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> OpenDrift
          

          
            
            <img src="../../../_static/opendrift_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction to OpenDrift</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installing OpenDrift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory/index.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../choosing_a_model.html">How to choose which model to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writing_a_new_model.html">How to write a new module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oil_types.html">Oil types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interaction_with_coastline.html">Interaction with coastline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OpenDrift</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../opendrift.html">opendrift</a> &raquo;</li>
        
      <li>opendrift.models.openoil3D</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for opendrift.models.openoil3D</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of OpenDrift.</span>
<span class="c1">#</span>
<span class="c1"># OpenDrift is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 2</span>
<span class="c1">#</span>
<span class="c1"># OpenDrift is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with OpenDrift.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2015, Knut-Frode Dagestad, MET Norway</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">opendrift.models.openoil</span> <span class="kn">import</span> <span class="n">OpenOil</span><span class="p">,</span> <span class="n">Oil</span>
<span class="kn">from</span> <span class="nn">opendrift.models.opendrift3D</span> <span class="kn">import</span> <span class="n">OpenDrift3DSimulation</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">basestring</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span>


<span class="c1"># Defining the oil element properties</span>
<div class="viewcode-block" id="Oil3D"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.Oil3D">[docs]</a><span class="k">class</span> <span class="nc">Oil3D</span><span class="p">(</span><span class="n">Oil</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defining properties of an oil object/particles.&quot;&quot;&quot;</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="n">Oil</span><span class="o">.</span><span class="n">add_variables</span><span class="p">([</span>
        <span class="c1"># Entrainment length scale, see Tkalich and Chan (2002)</span>
        <span class="p">(</span><span class="s1">&#39;entrainment_length_scale&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                      <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;diameter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>  <span class="c1"># Particle diameter</span>
                      <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">})</span>
        <span class="p">])</span></div>


<div class="viewcode-block" id="OpenOil3D"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D">[docs]</a><span class="k">class</span> <span class="nc">OpenOil3D</span><span class="p">(</span><span class="n">OpenDrift3DSimulation</span><span class="p">,</span> <span class="n">OpenOil</span><span class="p">):</span>  <span class="c1"># Multiple inheritance</span>
    <span class="sd">&quot;&quot;&quot;Open source oil trajectory model based on the OpenDrift framework.</span>

<span class="sd">        The OpenOil oil drift model is described e.g. in </span>
<span class="sd">	Rohrs, J., Dagestad, K.-F., Asbjornsen, H., Nordam, T., Skancke, J.,</span>
<span class="sd">	Jones, C. E., and Brekke, C.: The effect of vertical mixing on the </span>
<span class="sd">	horizontal drift of oil spills, Ocean Sci., 14, 1581-1601,</span>
<span class="sd">	https://doi.org/10.5194/os-14-1581-2018, 2018.</span>
<span class="sd">	</span>
<span class="sd">        Example usage:</span>
<span class="sd">	</span>
<span class="sd">	.. code-block:: python</span>
<span class="sd">	</span>
<span class="sd">	   from opendrift.models.openoil3D import OpenOil3D</span>
<span class="sd">	   o = OpenOil3D()</span>
<span class="sd">	</span>
<span class="sd">	Normal text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ElementType</span> <span class="o">=</span> <span class="n">Oil3D</span>

    <span class="n">required_variables</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;x_sea_water_velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;y_sea_water_velocity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_significant_height&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_x_velocity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_y_velocity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_period_at_variance_spectral_density_maximum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_mean_period_from_variance_spectral_density_second_frequency_moment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_ice_area_fraction&#39;</span><span class="p">,</span>
        <span class="s1">&#39;x_wind&#39;</span><span class="p">,</span> <span class="s1">&#39;y_wind&#39;</span><span class="p">,</span> <span class="s1">&#39;land_binary_mask&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ocean_vertical_diffusivity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_water_salinity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;upward_sea_water_velocity&#39;</span>
        <span class="p">]</span>

    <span class="c1"># Desired variables do not require initialisation of Lazy readers</span>
    <span class="n">desired_variables</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;sea_surface_wave_significant_height&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_x_velocity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_y_velocity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_period_at_variance_spectral_density_maximum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_mean_period_from_variance_spectral_density_second_frequency_moment&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sea_ice_area_fraction&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ocean_vertical_diffusivity&#39;</span><span class="p">,</span>
        <span class="s1">&#39;upward_sea_water_velocity&#39;</span>
        <span class="p">]</span>

    <span class="n">required_profiles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;sea_water_salinity&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;ocean_vertical_diffusivity&#39;</span><span class="p">]</span>
    <span class="c1"># The depth range (in m) which profiles shall cover</span>
    <span class="n">required_profiles_z_range</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">fallback_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">#&#39;x_sea_water_velocity&#39;: 0,</span>
        <span class="c1">#&#39;y_sea_water_velocity&#39;: 0,</span>
        <span class="s1">&#39;sea_surface_wave_significant_height&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_x_velocity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_y_velocity&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_period_at_variance_spectral_density_maximum&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;sea_surface_wave_mean_period_from_variance_spectral_density_second_frequency_moment&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;sea_ice_area_fraction&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="c1">#&#39;x_wind&#39;: 0, &#39;y_wind&#39;: 0,</span>
        <span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="s1">&#39;ocean_vertical_diffusivity&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>  <span class="c1"># m2s-1</span>
        <span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>
        <span class="s1">&#39;sea_water_salinity&#39;</span><span class="p">:</span> <span class="mf">34.</span><span class="p">,</span>
        <span class="s1">&#39;upward_sea_water_velocity&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>

    <span class="n">max_speed</span> <span class="o">=</span> <span class="mf">1.3</span>  <span class="c1"># m/s</span>

    <span class="c1"># Read oil types from file (presently only for illustrative effect)</span>
    <span class="n">oil_types</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span>
                    <span class="s1">&#39;/oil_types.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">default_oil</span> <span class="o">=</span> <span class="n">oil_types</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Configuration</span>
    <span class="n">configspecOO3D</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        [input]</span>
<span class="s1">            [[spill]]</span>
<span class="s1">                oil_type = option(</span><span class="si">%s</span><span class="s1">, default=</span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">                droplet_diameter_min_subsea = float(min=1e-8, max=1, default=0.0005)</span>
<span class="s1">                droplet_diameter_max_subsea = float(min=1e-8, max=1, default=0.005)</span>
<span class="s1">        [drift]</span>
<span class="s1">            wind_drift_depth = float(min=0, max=10, default=0.1)</span>
<span class="s1">            verticaladvection = boolean(default=False)</span>
<span class="s1">        [wave_entrainment]</span>
<span class="s1">            droplet_size_distribution = option(&#39;Exponential&#39;, &#39;Johansen et al. (2015)&#39;, &#39;Li et al. (2017)&#39;, default=&#39;Johansen et al. (2015)&#39;)</span>
<span class="s1">            entrainment_rate = option(&#39;Tkalich &amp; Chan (2002)&#39;, &#39;Li et al. (2017)&#39;, default=&#39;Li et al. (2017)&#39;)</span>
<span class="s1">        [turbulentmixing]</span>
<span class="s1">            droplet_diameter_min_wavebreaking = float(default=1e-5, min=1e-8, max=1)</span>
<span class="s1">            droplet_diameter_max_wavebreaking = float(default=2e-3, min=1e-8, max=1)</span>
<span class="s1">            droplet_size_exponent = float(default=0, min=-10, max=10)</span>
<span class="s1">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oil_types</span><span class="p">,</span> <span class="n">default_oil</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># Read oil properties from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oiltype_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> \
            <span class="s1">&#39;/oilprop.dat&#39;</span>
        <span class="n">oiltypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">linenumbers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                    <span class="n">oiltype</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">oiltypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oiltype</span><span class="p">)</span>
                    <span class="n">linenumbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">oiltypes</span><span class="p">,</span> <span class="n">linenumbers</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">oiltypes</span><span class="p">,</span> <span class="n">linenumbers</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span> <span class="o">=</span> <span class="n">oiltypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes_linenumbers</span> <span class="o">=</span> <span class="n">linenumbers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_configstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configspecOO3D</span><span class="p">)</span>

        <span class="c1"># Calling general constructor of parent class</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpenOil3D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="OpenOil3D.seed_elements"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.seed_elements">[docs]</a>    <span class="k">def</span> <span class="nf">seed_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">seed_json</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">:{},</span> <span class="s1">&#39;end&#39;</span><span class="p">:{}}</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kw</span><span class="p">],</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">]:</span>
                    <span class="n">pointer</span> <span class="o">=</span> <span class="n">seed_json</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
                    <span class="n">pointer2</span> <span class="o">=</span> <span class="n">seed_json</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pointer</span> <span class="o">=</span> <span class="n">seed_json</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_&#39;</span> <span class="o">+</span> <span class="n">kw</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">pointer</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kw</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_&#39;</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">+</span> <span class="s1">&#39;_start&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kw</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_&#39;</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">+</span> <span class="s1">&#39;_end&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kw</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">pointer</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">pointer2</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1">#self.logger.info(&#39;Not adding array %s to metadata&#39; % kw)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_&#39;</span> <span class="o">+</span> <span class="n">kw</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">seed_json</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;diameter&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Droplet diameter is provided, and will &#39;</span>
                         <span class="s1">&#39;be kept constant during simulation&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_droplet_diameter</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_droplet_diameter</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">basestring</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;seafloor&#39;</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>  <span class="c1"># Convert scalar z to array</span>
        <span class="n">subsea</span> <span class="o">=</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subsea</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;diameter&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># Droplet min and max for particles seeded below sea surface</span>
            <span class="n">sub_dmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;input:spill:droplet_diameter_min_subsea&#39;</span><span class="p">)</span>
            <span class="n">sub_dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;input:spill:droplet_diameter_max_subsea&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using particle diameters between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> m for &#39;</span>
                         <span class="s1">&#39;elements seeded below sea surface.&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">sub_dmin</span><span class="p">,</span> <span class="n">sub_dmax</span><span class="p">))</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">sub_dmin</span><span class="p">,</span> <span class="n">sub_dmax</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OpenOil3D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Add oil metadata</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_oil_density&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">get_density</span><span class="p">())</span>
            <span class="n">seed_json</span><span class="p">[</span><span class="s1">&#39;oil_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">get_density</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_oil_density&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">density_at_temp</span><span class="p">(</span><span class="mi">283</span><span class="p">))</span>
                <span class="n">seed_json</span><span class="p">[</span><span class="s1">&#39;oil_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">density_at_temp</span><span class="p">(</span><span class="mi">283</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_oil_viscosity&#39;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">get_viscosity</span><span class="p">(</span><span class="mi">283</span><span class="p">))</span>
            <span class="n">seed_json</span><span class="p">[</span><span class="s1">&#39;oil_viscosity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">get_viscosity</span><span class="p">(</span><span class="mi">283</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_oil_viscosity&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">kvis_at_temp</span><span class="p">(</span><span class="mi">283</span><span class="p">))</span>
                <span class="n">seed_json</span><span class="p">[</span><span class="s1">&#39;oil_viscosity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">kvis_at_temp</span><span class="p">(</span><span class="mi">283</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;seed_json&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed_json</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed_json</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">MyEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>  <span class="c1"># Serialisation of json</span>
            <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_json&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed_json</span><span class="p">,</span>
                                            <span class="bp">cls</span><span class="o">=</span><span class="n">MyEncoder</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenOil3D.prepare_run"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.prepare_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpenOil3D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">prepare_run</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenOil3D.particle_radius"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.particle_radius">[docs]</a>    <span class="k">def</span> <span class="nf">particle_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate radius of entained particles.</span>

<span class="sd">        Per now a fixed radius, should later use a distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Delvigne and Sweeney (1988)</span>
        <span class="c1"># rmax = 1818*np.power(self.wave_energy_dissipation(), -0.5)* \</span>
        <span class="c1">#             np.power(self.elements.viscosity, 0.34) / 1000000</span>

        <span class="c1"># r = np.random.uniform(0, rmax, self.num_elements_active())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span><span class="o">/</span><span class="mf">2.0</span>  <span class="c1"># Hardcoded diameter</span></div>

<div class="viewcode-block" id="OpenOil3D.update_terminal_velocity"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.update_terminal_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">update_terminal_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tprofiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">Sprofiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate terminal velocity for oil droplets</span>

<span class="sd">        according to</span>
<span class="sd">        Tkalich et al. (2002): Vertical mixing of oil droplets</span>
<span class="sd">                               by breaking waves</span>
<span class="sd">        Marine Pollution Bulletin 44, 1219-1229</span>

<span class="sd">        If profiles of temperature and salt are passed into this function,</span>
<span class="sd">        they will be interpolated from the profiles.</span>
<span class="sd">        if not, T,S will be fetched from reader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>  <span class="c1"># ms-2</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_radius</span><span class="p">()</span><span class="o">*</span><span class="mf">2.0</span>

        <span class="c1"># prepare interpolation of temp, salt</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Tprofiles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Sprofiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">z_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z_i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># evtl. move out of loop</span>
                <span class="c1"># evtl. move out of loop</span>
                <span class="n">z_index</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
                                   <span class="n">z_i</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="n">z_index</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">upper</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">weight_upper</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">zi</span> <span class="o">-</span> <span class="n">upper</span><span class="p">)</span>

        <span class="c1"># do interpolation of temp, salt if profiles were passed into</span>
        <span class="c1"># this function, if not, use reader by calling self.environment</span>
        <span class="k">if</span> <span class="n">Tprofiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="n">Tprofiles</span><span class="p">[</span><span class="n">upper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="n">weight_upper</span> <span class="o">+</span> \
                <span class="n">Tprofiles</span><span class="p">[</span><span class="n">lower</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight_upper</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Sprofiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">S0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_salinity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">S0</span> <span class="o">=</span> <span class="n">Sprofiles</span><span class="p">[</span><span class="n">upper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Sprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="n">weight_upper</span> <span class="o">+</span> \
                <span class="n">Sprofiles</span><span class="p">[</span><span class="n">lower</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Sprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight_upper</span><span class="p">)</span>

        <span class="n">rho_oil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span>
        <span class="n">rho_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="n">S0</span><span class="p">)</span>

        <span class="c1"># dynamic water viscosity</span>
        <span class="n">my_w</span> <span class="o">=</span> <span class="mf">0.001</span><span class="o">*</span><span class="p">(</span><span class="mf">1.7915</span> <span class="o">-</span> <span class="mf">0.0538</span><span class="o">*</span><span class="n">T0</span> <span class="o">+</span> <span class="mf">0.007</span><span class="o">*</span><span class="p">(</span><span class="n">T0</span><span class="o">**</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.0023</span><span class="o">*</span><span class="n">S0</span><span class="p">)</span>
        <span class="c1"># ~0.0014 kg m-1 s-1</span>
        <span class="c1"># kinemativ water viscosity</span>
        <span class="n">ny_w</span> <span class="o">=</span> <span class="n">my_w</span> <span class="o">/</span> <span class="n">rho_water</span>
        <span class="n">rhopr</span> <span class="o">=</span> <span class="n">rho_oil</span><span class="o">/</span><span class="n">rho_water</span>

        <span class="c1"># terminal velocity for low Reynolds numbers</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rhopr</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="n">ny_w</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">kw</span> <span class="o">*</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># check if we are in a high Reynolds number regime</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">W</span><span class="o">/</span><span class="n">ny_w</span>
        <span class="n">highRe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Re</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>

        <span class="c1"># Terminal velocity in high Reynolds numbers</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rhopr</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">W2</span> <span class="o">=</span> <span class="n">kw</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="n">W</span><span class="p">[</span><span class="n">highRe</span><span class="p">]</span> <span class="o">=</span> <span class="n">W2</span><span class="p">[</span><span class="n">highRe</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">terminal_velocity</span> <span class="o">=</span> <span class="n">W</span></div>

<div class="viewcode-block" id="OpenOil3D.oil_wave_entrainment_rate"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.oil_wave_entrainment_rate">[docs]</a>    <span class="k">def</span> <span class="nf">oil_wave_entrainment_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">er</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;wave_entrainment:entrainment_rate&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">er</span> <span class="o">==</span> <span class="s1">&#39;Tkalich &amp; Chan (2002)&#39;</span><span class="p">:</span>
            <span class="n">entrainment_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_wave_entrainment_rate_tkalich2002</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">er</span> <span class="o">==</span> <span class="s1">&#39;Li et al. (2017)&#39;</span><span class="p">:</span>
            <span class="n">entrainment_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_wave_entrainment_rate_li2017</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">entrainment_rate</span></div>

<div class="viewcode-block" id="OpenOil3D.oil_wave_entrainment_rate_li2017"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.oil_wave_entrainment_rate_li2017">[docs]</a>    <span class="k">def</span> <span class="nf">oil_wave_entrainment_rate_li2017</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Z. Li, M.L. Spaulding, D. French McCay, J. Mar. Pollut. Bull. (2016):</span>
        <span class="c1"># An algorithm for modeling entrainment and naturally and chemically dispersed</span>
        <span class="c1"># oil droplet size distribution under surface breaking wave conditions</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>
        <span class="n">interfacial_tension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span>
        <span class="n">delta_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span>
        <span class="n">d_o</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">interfacial_tension</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta_rho</span><span class="o">*</span><span class="n">g</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">we</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">()</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span> <span class="o">*</span> <span class="n">d_o</span> <span class="p">)</span> <span class="o">/</span> <span class="n">interfacial_tension</span>
        <span class="n">oh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">interfacial_tension</span> <span class="o">*</span> <span class="n">d_o</span> <span class="p">)</span><span class="o">**-</span><span class="mf">0.5</span> <span class="c1"># From kin. to dyn. viscosity by * density</span>
        <span class="n">entrainment_rate</span> <span class="o">=</span> <span class="mf">4.604e-10</span> <span class="o">*</span> <span class="n">we</span><span class="o">**</span><span class="mf">1.805</span> <span class="o">*</span><span class="n">oh</span><span class="o">**-</span><span class="mf">1.023</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_surface_wave_breaking_fraction</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">entrainment_rate</span></div>

<div class="viewcode-block" id="OpenOil3D.oil_wave_entrainment_rate_tkalich2002"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.oil_wave_entrainment_rate_tkalich2002">[docs]</a>    <span class="k">def</span> <span class="nf">oil_wave_entrainment_rate_tkalich2002</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Tkalich P. and Chan E.S.  </span>
        <span class="c1"># Vertical mixing of oil droplets by breaking waves</span>
        <span class="c1"># Marine Pollution Bulletin. 2002, V.44 (11), pp. 1219-1229</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_period</span><span class="p">()</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_damping_coefficient</span><span class="p">()</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="n">Low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">entrainment_length_scale</span>
        <span class="n">entrainment_rate</span> <span class="o">=</span> \
            <span class="n">kb</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">gamma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span> <span class="o">/</span> \
            <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="n">Low</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">entrainment_rate</span></div>

<div class="viewcode-block" id="OpenOil3D.prepare_vertical_mixing"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.prepare_vertical_mixing">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_vertical_mixing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate entrainment probability before main loop&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_entrainment_probability</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">oil_wave_entrainment_rate</span><span class="p">()</span><span class="o">*</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:timestep&#39;</span><span class="p">)</span>
        <span class="c1"># Calculate a random droplet diameter for each particle,</span>
        <span class="c1"># to be used if this particle gets entrained</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">droplet_diameter_if_entrained</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_wave_breaking_droplet_diameter</span><span class="p">()</span></div>
        <span class="c1"># Uncomment lines below to plot droplet size distribution at each step</span>
        <span class="c1">#import matplotlib.pyplot as plt</span>
        <span class="c1">#plt.hist(self.droplet_diameter_if_entrained, 200)</span>
        <span class="c1">#plt.gca().set_xscale(&quot;log&quot;)</span>
        <span class="c1">#plt.gca().set_yscale(&quot;log&quot;)</span>
        <span class="c1">#plt.show()</span>

<div class="viewcode-block" id="OpenOil3D.surface_wave_mixing"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.surface_wave_mixing">[docs]</a>    <span class="k">def</span> <span class="nf">surface_wave_mixing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_step_seconds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mix surface oil into water column.&quot;&quot;&quot;</span>
        <span class="c1"># Entrain oil into uppermost layer (whitecapping from waves)</span>
        <span class="c1"># TODO: optimise this by only calculate for surface elements</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">random_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
        <span class="n">entrained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span>
                        <span class="n">random_number</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">oil_entrainment_probability</span><span class="p">)</span>

        <span class="c1"># Intrusion depth for wave entrainment from Delvigne and Sweeney (1988), Li et al. (2017):</span>
        <span class="k">if</span> <span class="n">entrained</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entraining </span><span class="si">%i</span><span class="s1"> of </span><span class="si">%i</span><span class="s1"> surface elements&#39;</span> <span class="o">%</span>
						  <span class="p">(</span><span class="n">entrained</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">surface</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
            <span class="n">zb</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span> <span class="c1"># between 0 and zb</span>
            <span class="n">intrusion_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">zb</span><span class="p">),</span> <span class="n">entrained</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">entrained</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">intrusion_depth</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_droplet_diameter</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># Give entrained elements a random diameter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span><span class="p">[</span><span class="n">entrained</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">droplet_diameter_if_entrained</span><span class="p">[</span><span class="n">entrained</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenOil3D.surface_stick"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.surface_stick">[docs]</a>    <span class="k">def</span> <span class="nf">surface_stick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set surfaced particles to exactly zero depth to let them form a slick &quot;&quot;&quot;</span>
        
        <span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span></div>

<div class="viewcode-block" id="OpenOil3D.get_wave_breaking_droplet_diameter"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.get_wave_breaking_droplet_diameter">[docs]</a>    <span class="k">def</span> <span class="nf">get_wave_breaking_droplet_diameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;wave_entrainment:droplet_size_distribution&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dm</span> <span class="o">==</span> <span class="s1">&#39;Johansen et al. (2015)&#39;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wave_breaking_droplet_diameter_johansen2015</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dm</span> <span class="o">==</span> <span class="s1">&#39;Li et al. (2017)&#39;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wave_breaking_droplet_diameter_liz2017</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dm</span> <span class="o">==</span> <span class="s1">&#39;Exponential&#39;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wave_breaking_droplet_diameter_exponential</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="OpenOil3D.get_wave_breaking_droplet_diameter_exponential"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.get_wave_breaking_droplet_diameter_exponential">[docs]</a>    <span class="k">def</span> <span class="nf">get_wave_breaking_droplet_diameter_exponential</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;droplet_spectrum_pdf&#39;</span><span class="p">):</span>
            <span class="c1"># Generate droplet spectrum, if not already done</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generating wave breaking droplet size spectrum&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:droplet_size_exponent&#39;</span><span class="p">)</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:droplet_diameter_max_wavebreaking&#39;</span><span class="p">)</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:droplet_diameter_min_wavebreaking&#39;</span><span class="p">)</span>
            <span class="c1"># Note: a long array of diameters is required for </span>
            <span class="c1"># sufficient resolution at both ends of logarithmic scale.</span>
            <span class="c1"># Could perhaps use logspace instead of linspace(?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="o">**</span><span class="n">s</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">,</span>
                                <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span>
                                <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenOil3D.get_wave_breaking_droplet_diameter_liz2017"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.get_wave_breaking_droplet_diameter_liz2017">[docs]</a>    <span class="k">def</span> <span class="nf">get_wave_breaking_droplet_diameter_liz2017</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Li,Zhengkai, M. Spaulding, D. French-McCay, D. Crowley, J.R. Payne: &quot;Development of a unified oil droplet size distribution model </span>
        <span class="c1"># with application to surface breaking waves and subsea blowout releases considering dispersant effects&quot; Mar. Pol. Bul.</span>
        <span class="c1"># DOI: 10.1016/j.marpolbul.2016.09.008</span>
        <span class="c1"># Should be prefered when the oil film thickness is unknown.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;droplet_spectrum_pdf&#39;</span><span class="p">):</span>
            <span class="c1"># Generate droplet spectrum as in Li (Zhengkai) et al. (2017)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generating wave breaking droplet size spectrum&#39;</span><span class="p">)</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:droplet_diameter_max_wavebreaking&#39;</span><span class="p">)</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:droplet_diameter_min_wavebreaking&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>
            <span class="n">interfacial_tension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span>
            <span class="n">delta_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span>
            <span class="n">d_o</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">interfacial_tension</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta_rho</span><span class="o">*</span><span class="n">g</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">we</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">()</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span> <span class="o">*</span> <span class="n">d_o</span> <span class="p">)</span> <span class="o">/</span> <span class="n">interfacial_tension</span>
            <span class="n">oh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">interfacial_tension</span> <span class="o">*</span> <span class="n">d_o</span> <span class="p">)</span><span class="o">**-</span><span class="mf">0.5</span> <span class="c1"># From kin. to dyn. viscosity by * density</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mf">1.791</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mf">0.460</span>
            <span class="n">q</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.518</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">d_o</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="n">oh</span><span class="p">)</span><span class="o">**</span><span class="n">p</span> <span class="o">*</span> <span class="n">we</span><span class="o">**</span><span class="n">q</span> <span class="c1"># median droplet diameter in volume distribution</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1"># log standard deviation in log10 units</span>
            <span class="n">Sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span><span class="n">sd</span> <span class="c1"># log standard deviation in natural log units</span>
            <span class="c1"># TODO: calculation below with scalars, but we have arrays, with varying oil properties</span>
            <span class="c1"># treat all particle in one go:</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dV_50</span><span class="p">)</span> <span class="c1"># mean log diameter</span>
            <span class="n">dN_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dV_50</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">Sd</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="c1"># convert number distribution to volume distribution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Droplet distribution median diameter dV_50: </span><span class="si">%f</span><span class="s1">, dN_50: </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span><span class="p">(</span> <span class="n">dV_50</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dN_50</span><span class="p">)))</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dV_50</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">*</span> <span class="n">Sd</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not update droplet diameters.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span>
                                    <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil3D.get_wave_breaking_droplet_diameter_johansen2015"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.get_wave_breaking_droplet_diameter_johansen2015">[docs]</a>    <span class="k">def</span> <span class="nf">get_wave_breaking_droplet_diameter_johansen2015</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Johansen O, Reed M, Bodsberg NR, Natural dispersion revisited</span>
        <span class="c1"># DOI: 10.1016/j.marpolbul.2015.02.026</span>
        <span class="c1"># requires oil film thickness</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;droplet_spectrum_pdf&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:update_oilfilm_thickness&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Generate droplet spectrum as in Johansen et al. (2015)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generating wave breaking droplet size spectrum&#39;</span><span class="p">)</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:droplet_diameter_max_wavebreaking&#39;</span><span class="p">)</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;turbulentmixing:droplet_diameter_min_wavebreaking&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>
            <span class="n">interfacial_tension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span>
            <span class="c1">#</span>
            <span class="c1">#A = self.significant_wave_height()/2. # wave amplitude</span>
            <span class="c1">#re = (self.elements.density*self.elements.oil_film_thickness*(2*g*A)**0.5) / (self.elements.viscosity*self.elements.density) # Reyolds number</span>
            <span class="c1">#we = (self.elements.density*self.elements.oil_film_thickness*2*g*A) / interfacial_tension # Weber number</span>
            <span class="c1">#</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span> <span class="c1"># fall height = 2 * wave amplitude</span>
            <span class="c1"># Reyolds number (Eq. 7a from Johansen et al. 2015)</span>
            <span class="n">re</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">H</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">)</span> 
            <span class="c1"># Weber number (Eq. 7b from Johansen et al.2015)</span>
            <span class="n">we</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="o">*</span><span class="n">g</span><span class="o">*</span><span class="n">H</span><span class="p">)</span> <span class="o">/</span> <span class="n">interfacial_tension</span> <span class="c1"># Weber number</span>
            <span class="n">A</span> <span class="o">=</span> <span class="mf">2.251</span> <span class="c1"># parameters from Johansen et al. 2015</span>
            <span class="n">Bp</span> <span class="o">=</span> <span class="mf">0.027</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">Bp</span>  
            <span class="n">dN_50</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="o">*</span><span class="n">we</span><span class="o">**-</span><span class="mf">0.6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="o">*</span> <span class="n">re</span><span class="o">**-</span><span class="mf">0.6</span><span class="p">)</span> <span class="c1"># median droplet diameter in number distribution</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="c1"># log standard deviation in log10 units</span>
            <span class="n">Sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span><span class="n">sd</span> <span class="c1"># log standard deviation in natural log units</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dN_50</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">Sd</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="c1"># convert number distribution to volume distribution</span>
            <span class="c1"># TODO: calculation below with scalars, but we have</span>
            <span class="c1"># arrays, with varying oil properties</span>
            <span class="c1"># treat all particle in one go:</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dV_50</span><span class="p">)</span> <span class="c1"># mean log diameter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Droplet distribution median diameter dV_50: </span><span class="si">%f</span><span class="s1">, dN_50: </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span><span class="p">(</span> <span class="n">dV_50</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dN_50</span><span class="p">)))</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dV_50</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">*</span> <span class="n">Sd</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not update droplet diameters.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span>
                                    <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenOil3D.resurface_elements"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.resurface_elements">[docs]</a>    <span class="k">def</span> <span class="nf">resurface_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Oil elements reaching surface (or above) form slick, not droplet&quot;&quot;&quot;</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpenOil3D.update"><a class="viewcode-back" href="../../../autoapi/opendrift/models/openoil3D/index.html#opendrift.models.openoil3D.OpenOil3D.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update positions and properties of oil particles.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:update_oilfilm_thickness&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_surface_oilfilm_thickness</span><span class="p">()</span>

        <span class="c1"># Oil weathering (inherited from OpenOil)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering</span><span class="p">()</span>

        <span class="c1"># Turbulent Mixing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:turbulentmixing&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_terminal_velocity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_mixing</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span>

        <span class="c1"># Vertical advection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:verticaladvection&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_advection</span><span class="p">()</span>

        <span class="c1"># Horizontal advection (inherited from OpenOil)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advect_oil</span><span class="p">()</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Knut-Frode Dagestad et. al.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>