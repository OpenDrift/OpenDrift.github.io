<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>opendrift.models.openoil.openoil &mdash; OpenDrift  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/theme_overrides.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            OpenDrift
              <img src="../../../../_static/opendrift_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../index.html">Introduction to OpenDrift</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../history_link.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installing OpenDrift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../performance.html">Performance in OpenDrift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../theory/index.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../theory/index.html#drift-in-the-ocean">Drift in the Ocean</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../choosing_a_model.html">How to choose which model to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../writing_a_new_model.html">How to write a new module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oil_types.html">Oil types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../interaction_with_coastline.html">Interaction with coastline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docker.html">Using OpenDrift in a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gui.html">Graphical User Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../references.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../services.html">Services using OpenDrift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">OpenDrift</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../opendrift.html">opendrift</a></li>
      <li class="breadcrumb-item active">opendrift.models.openoil.openoil</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for opendrift.models.openoil.openoil</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of OpenDrift.</span>
<span class="c1">#</span>
<span class="c1"># OpenDrift is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 2</span>
<span class="c1">#</span>
<span class="c1"># OpenDrift is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with OpenDrift.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2015, Knut-Frode Dagestad, MET Norway</span>
<span class="c1"># Copyright 2021, Gaute Hope, MET Norway</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">OpenOil is a 3D oil drift module bundled within the OpenDrift framework.</span>

<span class="sd">The oil weathering calculations is based on the NOAA-ERR-ERD OilLibrary</span>
<span class="sd">package, which is installed as a dependency. The code for evaporation and</span>
<span class="sd">emulsification in OpenOil is borrowed from the NOAA PyGnome code, and adapted</span>
<span class="sd">to the OpenDrift architecture.</span>

<span class="sd">Example of ship leaking oil along the coast of Northern Norway</span>
<span class="sd">##############################################################</span>

<span class="sd">.. image:: https://dl.dropboxusercontent.com/s/ty6dmqf0oohewky/oilspill_tromsoe.gif?dl=0</span>

<span class="sd">Simulation of Deepwater Horizon (Macondo) accident, initiated from satellite images</span>
<span class="sd">###################################################################################</span>

<span class="sd">.. image:: https://dl.dropboxusercontent.com/s/ghi7crtmwpyjgto/macondo_simulation.gif?dl=0</span>

<span class="sd">Satellite images provided by Prof. Chuanmin Hu, and ocean model output provided by Prof. Vassiliki Kourafalou</span>

<span class="sd">Example oil budget for a simulation</span>
<span class="sd">###################################</span>

<span class="sd">.. image:: https://dl.dropboxusercontent.com/s/pb0h6tlev9pnoh3/oil_budget_draugen.png?dl=0</span>

<span class="sd">Oil properties affecting the drift</span>
<span class="sd">***********************************</span>
<span class="sd">The vertical (and thus indirectly also the horizontal) motion of oil (droplets) is affected by oil density and droplet diameters.</span>

<span class="sd">When using the NOAA oil weathering model (``o = OpenOil(weathering_model=&#39;noaa&#39;)``), which is the default, the density is obtained from the NOAA database according to the oiltype selected when seeding. This value can not be overridden by the user, and it will also change during the simulation due to oil weathering processes (evaporation and emulsification).</span>

<span class="sd">The droplet diameter may be given explicitly when seeding, e.g.:</span>

<span class="sd">.. testcode::</span>


<span class="sd">    o = OpenOil()</span>
<span class="sd">    o.set_config(&#39;environment:constant:x_wind&#39;, 0)</span>
<span class="sd">    o.set_config(&#39;environment:constant:y_wind&#39;, 0)</span>
<span class="sd">    o.set_config(&#39;environment:constant:x_sea_water_velocity&#39;, 0)</span>
<span class="sd">    o.set_config(&#39;environment:constant:y_sea_water_velocity&#39;, 0)</span>
<span class="sd">    o.seed_elements(4, 60, number=100, time=datetime.now(), diameter=1e-5)</span>

<span class="sd">In this case, the diameter will not change during the simulation, which is useful e.g. for sensitivity tests. The same diameter will be used for all elements for this example, but an array of the same length as the number of elements may also be provided.</span>

<span class="sd">If a constant droplet diameter is not given by the user, it will be chosen randomly within given config limits for a subsea spill (&#39;blowout&#39;), and modified after any later wave breaking event. Oil droplets seeded under sea surface (z&lt;0) will be assigned initial diameters between the following limits, typical for a subsea blowout (Johansen, 2000)::</span>

<span class="sd">.. code::</span>

<span class="sd">    o.set_config(&#39;seed:droplet_diameter_min_subsea&#39;, 0.0005)  # 0.5 mm</span>
<span class="sd">    o.set_config(&#39;seed:droplet_diameter_max_subsea&#39;, 0.005)   # 5 mm</span>

<span class="sd">Alternatively, the user can specify normal or lognormal initial subsea droplet size distributions, which are later modified by wave breaking events. In these cases the user must specify the mean and standard deviation of the distribution::</span>

<span class="sd">.. code::</span>

<span class="sd">    o.set_config(&#39;seed:droplet_size_distribution&#39;,&#39;lognormal&#39;)</span>
<span class="sd">    o.set_config(&#39;seed:droplet_diameter_mu&#39;,0.001)  # 1 mm</span>
<span class="sd">    o.set_config(&#39;seed:droplet_diameter_sigma&#39;,0.0008) # 0.8 mm</span>

<span class="sd">Note that these config settings must be adjusted before the seeding call.</span>
<span class="sd">After each wave breaking event, a new droplet diameter will be chosen based on the config setting for droplet size distribution.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="nb">open</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">resources</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">opendrift.models.oceandrift</span> <span class="kn">import</span> <span class="n">OceanDrift</span><span class="p">,</span> <span class="n">Lagrangian3DArray</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">noaa_oil_weathering</span> <span class="k">as</span> <span class="n">noaa</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">adios</span>
<span class="kn">from</span> <span class="nn">adios_db.computation.physical_properties</span> <span class="kn">import</span> <span class="n">KinematicViscosity</span><span class="p">,</span> <span class="n">Density</span>
<span class="kn">from</span> <span class="nn">adios_db.computation</span> <span class="kn">import</span> <span class="n">gnome_oil</span>

<span class="kn">from</span> <span class="nn">opendrift.models.physics_methods</span> <span class="kn">import</span> <span class="n">oil_wave_entrainment_rate_li2017</span>
<span class="kn">from</span> <span class="nn">opendrift.config</span> <span class="kn">import</span> <span class="n">CONFIG_LEVEL_ESSENTIAL</span><span class="p">,</span> <span class="n">CONFIG_LEVEL_BASIC</span><span class="p">,</span> <span class="n">CONFIG_LEVEL_ADVANCED</span>


<span class="c1"># Defining the oil element properties</span>
<div class="viewcode-block" id="Oil">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.Oil">[docs]</a>
<span class="k">class</span> <span class="nc">Oil</span><span class="p">(</span><span class="n">Lagrangian3DArray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extending LagrangianArray with variables relevant for oil particles.&quot;&quot;&quot;</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="n">Lagrangian3DArray</span><span class="o">.</span><span class="n">add_variables</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;mass_oil&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}),</span>
        <span class="p">(</span>
            <span class="s1">&#39;viscosity&#39;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m2/s&#39;</span><span class="p">,</span>
                <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Taken from NOAA database</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Kinematic viscosity of oil (emulsion)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.005</span>
            <span class="p">}),</span>
        <span class="p">(</span>
            <span class="s1">&#39;density&#39;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg/m^3&#39;</span><span class="p">,</span>
                <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Taken from NOAA database</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">880</span>
            <span class="p">}),</span>
        <span class="p">(</span>
            <span class="s1">&#39;wind_drift_factor&#39;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>  <span class="c1"># TODO: inherit from</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span>
                <span class="s1">&#39;%&#39;</span><span class="p">,</span>  <span class="c1"># OceanDrift</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Elements at the ocean surface are moved by &#39;</span>
                <span class="s1">&#39;this fraction of the wind vector, in addition to &#39;</span>
                <span class="s1">&#39;currents and Stokes drift&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="mf">0.03</span>
            <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;bulltime&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;interfacial_area&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;mass_dispersed&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;mass_evaporated&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;mass_biodegraded&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;kg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;biodegradation_half_time_droplet&#39;</span><span class="p">,</span>  <span class="c1"># Note: if unit is &quot;days&quot;, Xarray tries to decode as datetime with error</span>
                <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;Days&#39;</span><span class="p">,</span> <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Biodegradation half time in days for submerged oil droplets&#39;</span><span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;biodegradation_half_time_slick&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;Days&#39;</span><span class="p">,</span> <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                 <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Biodegradation half time in days for surface oil slick&#39;</span><span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;fraction_evaporated&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>  <span class="c1"># TODO: should be fraction and not percent</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;water_fraction&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
            <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;oil_film_thickness&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.001</span>
        <span class="p">}),</span>
        <span class="p">(</span>
            <span class="s1">&#39;diameter&#39;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>  <span class="c1"># Particle diameter</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
                <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.</span>
            <span class="p">})</span>
    <span class="p">])</span></div>



<div class="viewcode-block" id="OpenOil">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil">[docs]</a>
<span class="k">class</span> <span class="nc">OpenOil</span><span class="p">(</span><span class="n">OceanDrift</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open source oil trajectory model based on the OpenDrift framework.</span>

<span class="sd">        Developed at MET Norway based on oil weathering parameterisations</span>
<span class="sd">        found in open/published litterature.</span>

<span class="sd">        Under construction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ElementType</span> <span class="o">=</span> <span class="n">Oil</span>

    <span class="n">required_variables</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;x_sea_water_velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">},</span>
        <span class="s1">&#39;y_sea_water_velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">},</span>
        <span class="s1">&#39;x_wind&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">},</span>
        <span class="s1">&#39;y_wind&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_surface_height&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s1">&#39;upward_sea_water_velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_surface_wave_significant_height&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_x_velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_surface_wave_stokes_drift_y_velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_surface_wave_period_at_variance_spectral_density_maximum&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_surface_wave_mean_period_from_variance_spectral_density_second_frequency_moment&#39;</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_ice_area_fraction&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_ice_x_velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_ice_y_velocity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;profiles&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_water_salinity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">34</span><span class="p">,</span>
            <span class="s1">&#39;profiles&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">},</span>
        <span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">10000</span>
        <span class="p">},</span>
        <span class="s1">&#39;ocean_vertical_diffusivity&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;profiles&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">},</span>
        <span class="s1">&#39;land_binary_mask&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">},</span>
        <span class="s1">&#39;ocean_mixed_layer_thickness&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;fallback&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">},</span>
    <span class="p">}</span>


    <span class="c1"># Default colors for plotting</span>
    <span class="n">status_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
        <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
        <span class="s1">&#39;missing_data&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stranded&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
        <span class="s1">&#39;evaporated&#39;</span><span class="p">:</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dispersed&#39;</span><span class="p">:</span> <span class="s1">&#39;magenta&#39;</span>
    <span class="p">}</span>

    <span class="n">duplicate_oils</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ALVHEIM BLEND, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;DRAUGEN, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;EKOFISK BLEND 2000&#39;</span><span class="p">,</span> <span class="s1">&#39;EKOFISK BLEND, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;EKOFISK, CITGO&#39;</span><span class="p">,</span> <span class="s1">&#39;EKOFISK, EXXON&#39;</span><span class="p">,</span> <span class="s1">&#39;EKOFISK, PHILLIPS&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;EKOFISK, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;ELDFISK&#39;</span><span class="p">,</span> <span class="s1">&#39;ELDFISK B&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;GLITNE, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;GOLIAT BLEND, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;GRANE BLEND, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;GUDRUN BLEND, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;GULLFAKS A, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;GULLFAKS C, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;GULLFAKS, SHELL OIL&#39;</span><span class="p">,</span> <span class="s1">&#39;GULLFAKS SOR&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;GULLFAKS, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;HEIDRUN, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;NJORD, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;NORNE, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;OSEBERG BLEND, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;OSEBERG EXXON&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;OSEBERG, PHILLIPS&#39;</span><span class="p">,</span> <span class="s1">&#39;OSEBERG, SHELL OIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;SLEIPNER CONDENSATE, STATOIL&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;STATFJORD BLEND, STATOIL&#39;</span><span class="p">,</span> <span class="s1">&#39;VARG, STATOIL&#39;</span><span class="p">]</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weathering_model</span><span class="o">=</span><span class="s1">&#39;noaa&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">=</span> <span class="n">weathering_model</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>  <span class="c1"># Currently the only option</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span> <span class="o">=</span> <span class="n">adios</span><span class="o">.</span><span class="n">get_oil_names</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

            <span class="c1"># Update config with oiltypes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">adios</span><span class="o">.</span><span class="n">oil_name_alias</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Sort alphabetically, but put GENERIC oils first</span>
            <span class="n">generic_oiltypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GENERIC&#39;</span><span class="p">]</span>
            <span class="n">other_oiltypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;GENERIC&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">generic_oiltypes</span><span class="p">])</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">other_oiltypes</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ot</span> <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span> <span class="k">if</span> <span class="n">ot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_oils</span><span class="p">]</span>

            <span class="c1"># For Norwegian oils, max water fraction from Sintef is overriding NOAA value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_water_fraction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Weathering model unknown: &#39;</span> <span class="o">+</span> <span class="n">weathering_model</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Calling general constructor of parent class</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpenOil</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_config</span><span class="p">({</span>
            <span class="s1">&#39;seed:m3_per_hour&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">1e10</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m3 per hour&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;The amount (volume) of oil released per hour (or total amount if release is instantaneous)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_ESSENTIAL</span>
            <span class="p">},</span>
            <span class="s1">&#39;seed:droplet_size_distribution&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">],</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="s1">&#39;uniform&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span>
                <span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Droplet size distribution used for subsea release.&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;seed:droplet_diameter_mu&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;The mean diameter of oil droplet for a subsea release, used in normal/lognormal distributions.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;seed:droplet_diameter_sigma&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.0005</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;The standard deviation in diameter of oil droplet for a subsea release, used in normal/lognormal distributions.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;seed:droplet_diameter_min_subsea&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.0005</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;The minimum diameter of oil droplet for a subsea release, used in unifrom distribution.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;seed:droplet_diameter_max_subsea&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;The maximum diameter of oil droplet for a subsea release, used in uniform distribution.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;processes:dispersion&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Oil is removed from simulation (dispersed), if entrained as very small droplets.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;processes:evaporation&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Surface oil is evaporated.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;processes:emulsification&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Surface oil is emulsified, i.e. water droplets are mixed into oil due to wave mixing, with resulting increas of viscosity.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;processes:biodegradation&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Oil mass is biodegraded (eaten by bacteria).&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_BASIC</span>
            <span class="p">},</span>
            <span class="s1">&#39;biodegradation:method&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Adcroft&#39;</span><span class="p">,</span> <span class="s1">&#39;half_time&#39;</span><span class="p">],</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;Adcroft&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Alogorithm to be used for biodegradation of oil&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;processes:update_oilfilm_thickness&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Oil film thickness is calculated at each time step. The alternative is that oil film thickness is kept constant with value provided at seeding.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">CONFIG_LEVEL_ADVANCED</span>
            <span class="p">},</span>
            <span class="s1">&#39;wave_entrainment:droplet_size_distribution&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Johansen et al. (2015)&#39;</span><span class="p">,</span> <span class="s1">&#39;Li et al. (2017)&#39;</span><span class="p">],</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Johansen et al. (2015)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span>
                <span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Algorithm to be used for calculating oil droplet size spectrum after entrainment by breaking waves.&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;wave_entrainment:entrainment_rate&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Li et al. (2017)&#39;</span><span class="p">],</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Li et al. (2017)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span>
                <span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Algorithm to be used for calculating the entrainment rate of oil due to wave breaking.&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;seed:oil_type&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">,</span>
                <span class="s1">&#39;enum&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oiltypes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span>
                <span class="n">CONFIG_LEVEL_ESSENTIAL</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Oil type to be used for the simulation, from the NOAA ADIOS database.&#39;</span>
            <span class="p">},</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_default</span><span class="p">(</span><span class="s1">&#39;drift:vertical_advection&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_default</span><span class="p">(</span><span class="s1">&#39;drift:vertical_mixing&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_default</span><span class="p">(</span><span class="s1">&#39;drift:current_uncertainty&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_default</span><span class="p">(</span><span class="s1">&#39;drift:wind_uncertainty&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_config_default</span><span class="p">(</span><span class="s1">&#39;drift:max_speed&#39;</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span>

<div class="viewcode-block" id="OpenOil.update_surface_oilfilm_thickness">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.update_surface_oilfilm_thickness">[docs]</a>
    <span class="k">def</span> <span class="nf">update_surface_oilfilm_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;The mass of oil is summed within a grid of 100x100</span>
<span class="sd">        cells covering the oil at a given time. Each oil particle</span>
<span class="sd">        within each cell is given a film thickness as the amount of</span>
<span class="sd">        oil divided by the cell area.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binned_statistic_2d</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No oil at surface, no film thickness to update&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Updating oil film thickness for </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> elements at surface&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()))</span>
        <span class="n">meanlon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">meanlat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># Using stereographic coordinates to get regular X and Y</span>
        <span class="n">psproj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="s1">&#39;+proj=stere +lat_0=</span><span class="si">%s</span><span class="s1"> +lat_ts=</span><span class="si">%s</span><span class="s1"> +lon_0=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">meanlat</span><span class="p">,</span> <span class="n">meanlat</span><span class="p">,</span> <span class="n">meanlon</span><span class="p">))</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">psproj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">surface</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">surface</span><span class="p">])</span>
        <span class="n">mass_bin</span><span class="p">,</span> <span class="n">x_edge</span><span class="p">,</span> <span class="n">y_edge</span><span class="p">,</span> <span class="n">binnumber</span> <span class="o">=</span> <span class="n">binned_statistic_2d</span><span class="p">(</span>
            <span class="n">X</span><span class="p">,</span>
            <span class="n">Y</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span><span class="p">[</span><span class="n">surface</span><span class="p">],</span>
            <span class="n">expand_binnumbers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">bin_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">oil_density</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># ok approximation here</span>
        <span class="n">film_thickness</span> <span class="o">=</span> <span class="p">(</span><span class="n">mass_bin</span> <span class="o">/</span> <span class="n">oil_density</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_area</span>
        <span class="c1"># Postulating min and max film thickness</span>
        <span class="n">max_thickness</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># 1 cm</span>
        <span class="n">min_thickness</span> <span class="o">=</span> <span class="mf">1e-9</span>  <span class="c1"># 1 nanometer</span>
        <span class="k">if</span> <span class="n">film_thickness</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_thickness</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Warning: decreasing thickness to </span><span class="si">%s</span><span class="s1">m for </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> bins&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">max_thickness</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">film_thickness</span> <span class="o">&gt;</span> <span class="n">max_thickness</span><span class="p">),</span>
                 <span class="n">film_thickness</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">film_thickness</span><span class="p">[</span><span class="n">film_thickness</span> <span class="o">&gt;</span> <span class="n">max_thickness</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_thickness</span>
        <span class="n">num_too_thin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">film_thickness</span> <span class="o">&lt;</span> <span class="n">min_thickness</span><span class="p">)</span>
                              <span class="o">&amp;</span> <span class="p">(</span><span class="n">film_thickness</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">num_too_thin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Warning: increasing thickness to </span><span class="si">%s</span><span class="s1">m for </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> bins&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">min_thickness</span><span class="p">,</span> <span class="n">num_too_thin</span><span class="p">,</span> <span class="n">film_thickness</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">film_thickness</span><span class="p">[</span><span class="n">film_thickness</span> <span class="o">&lt;</span> <span class="n">min_thickness</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_thickness</span>

        <span class="c1"># https://github.com/scipy/scipy/issues/7010</span>
        <span class="n">binnumber</span> <span class="o">=</span> <span class="n">binnumber</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">bx</span> <span class="o">=</span> <span class="n">binnumber</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">by</span> <span class="o">=</span> <span class="n">binnumber</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="c1"># Update thickness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="p">[</span>
            <span class="n">surface</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">film_thickness</span><span class="p">[</span><span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">]</span></div>


<div class="viewcode-block" id="OpenOil.biodegradation">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.biodegradation">[docs]</a>
    <span class="k">def</span> <span class="nf">biodegradation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:biodegradation&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;biodegradation:method&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating: biodegradation (</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Adcroft&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biodegradation_adcroft</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;half_time&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">biodegradation_half_time</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpenOil.biodegradation_half_time">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.biodegradation_half_time">[docs]</a>
    <span class="k">def</span> <span class="nf">biodegradation_half_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Oil biodegradation with exponential decay&#39;&#39;&#39;</span>

        <span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># of active elements</span>
        <span class="n">age0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>  <span class="c1"># days</span>

        <span class="n">half_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">biodegradation_half_time_droplet</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">half_time</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">biodegradation_half_time_slick</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span>

        <span class="n">fraction_biodegraded</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">age0</span> <span class="o">/</span> <span class="n">half_time</span><span class="p">))</span>
        <span class="n">biodegraded_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">*</span> <span class="n">fraction_biodegraded</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_biodegraded</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_biodegraded</span> <span class="o">+</span> <span class="n">biodegraded_now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">-</span> <span class="n">biodegraded_now</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fraction_biodegraded</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span></div>


<div class="viewcode-block" id="OpenOil.biodegradation_adcroft">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.biodegradation_adcroft">[docs]</a>
    <span class="k">def</span> <span class="nf">biodegradation_adcroft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Oil biodegradation function based on the article:</span>
<span class="sd">        Adcroft et al. (2010), Simulations of underwater plumes of</span>
<span class="sd">        dissolved oil in the Gulf of Mexico.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">swt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">swt</span><span class="p">[</span><span class="n">swt</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">273.15</span>  <span class="c1"># K to C</span>
        <span class="n">age0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>

        <span class="c1"># Decay rate in days (temperature in Celsius)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span><span class="o">**</span><span class="p">((</span><span class="mi">20</span> <span class="o">-</span> <span class="n">swt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>

        <span class="n">fraction_biodegraded</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">age0</span> <span class="o">/</span> <span class="n">tau</span><span class="p">))</span>
        <span class="n">biodegraded_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">*</span> <span class="n">fraction_biodegraded</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_biodegraded</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_biodegraded</span> <span class="o">+</span> <span class="n">biodegraded_now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">-</span> <span class="n">biodegraded_now</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fraction_biodegraded</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span></div>


<div class="viewcode-block" id="OpenOil.disperse">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.disperse">[docs]</a>
    <span class="k">def</span> <span class="nf">disperse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:dispersion&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;   Calculating: dispersion&#39;</span><span class="p">)</span>
            <span class="n">windspeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">x_wind</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">y_wind</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># From NOAA PyGnome model:</span>
            <span class="c1"># https://github.com/NOAA-ORR-ERD/PyGnome/</span>
            <span class="n">v_entrain</span> <span class="o">=</span> <span class="mf">3.9E-8</span>
            <span class="n">sea_water_density</span> <span class="o">=</span> <span class="mi">1028</span>
            <span class="n">fraction_breaking_waves</span> <span class="o">=</span> <span class="mf">0.02</span>
            <span class="n">wave_significant_height</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span>
            <span class="n">wave_significant_height</span><span class="p">[</span><span class="n">wave_significant_height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
                <span class="mf">0.0246</span><span class="o">*</span><span class="n">windspeed</span><span class="p">[</span><span class="n">wave_significant_height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">dissipation_wave_energy</span> <span class="o">=</span> \
                <span class="p">(</span><span class="mf">0.0034</span><span class="o">*</span><span class="n">sea_water_density</span><span class="o">*</span><span class="mf">9.81</span><span class="o">*</span><span class="n">wave_significant_height</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">c_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dissipation_wave_energy</span><span class="p">,</span> <span class="mf">0.57</span><span class="p">)</span> <span class="o">*</span> \
                <span class="n">fraction_breaking_waves</span>
            <span class="c1"># Roy&#39;s constant</span>
            <span class="n">C_Roy</span> <span class="o">=</span> <span class="mf">2400.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">73.682</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">))</span>

            <span class="n">q_disp</span> <span class="o">=</span> <span class="n">C_Roy</span> <span class="o">*</span> <span class="n">c_disp</span> <span class="o">*</span> <span class="n">v_entrain</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span>

            <span class="n">oil_mass_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_disp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">-=</span> <span class="n">oil_mass_loss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_dispersed</span> <span class="o">+=</span> <span class="n">oil_mass_loss</span></div>


            <span class="c1">#self.elements.z = \</span>
            <span class="c1">#    self.environment.sea_surface_wave_significant_height</span>

            <span class="c1">## Marks R. (1987), Marine aerosols and whitecaps in the</span>
            <span class="c1">## North Atlantic and Greenland sea regions</span>
            <span class="c1">## Deutsche Hydrografische Zeitschrift, Vol 40, Issue 2 , pp 71-79</span>
            <span class="c1">#whitecap_coverage = (2.54E-4)*np.power(windspeed, 3.58)</span>

            <span class="c1">## Martinsen et al. (1994), The operational</span>
            <span class="c1">## oil drift system at DNMI</span>
            <span class="c1">## DNMI Technical report No 125, 51</span>
            <span class="c1">#wave_period = 3.85*np.sqrt(</span>
            <span class="c1">#    self.environment.sea_surface_wave_significant_height)  # sec</span>

            <span class="c1">#time_between_breaking_events = 3.85/whitecap_coverage  # TBC</span>

            <span class="c1">#rho_w = 1025  # kg/m3</span>
            <span class="c1">#wave_period[wave_period == 0] = 5  # NB: temporal fix for no waves</span>
            <span class="c1">#dissipation_energy = 0.0034*rho_w*9.81*(wave_period**2)</span>
            <span class="c1">#dsize_coeff = 2100  # Wettre et al., Appendix A</span>
            <span class="c1">#c_oil = dsize_coeff*np.power(self.elements.viscosity, -0.4)</span>
            <span class="c1">## Random numbers between 0 and 1:</span>
            <span class="c1">#p = np.random.rand(self.num_elements_active(), )</span>
            <span class="c1">#oil_per_unit_surface = 1</span>
            <span class="c1">#droplet_size = np.power((p*oil_per_unit_surface)/(c_oil *</span>
            <span class="c1">#                        np.power(dissipation_energy, 0.57)),</span>
            <span class="c1">#                        1/1.17)</span>
            <span class="c1">#self.deactivate_elements(droplet_size &lt; 5E-7, reason=&#39;dispersed&#39;)</span>

<div class="viewcode-block" id="OpenOil.oil_weathering">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.oil_weathering">[docs]</a>
    <span class="k">def</span> <span class="nf">oil_weathering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping oil weathering for backwards run&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;main loop:updating elements:oil weathering&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_noaa</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;main loop:updating elements:oil weathering&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.prepare_run">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.prepare_run">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Populate with seeded mass spread on oiltype.mass_fraction</span>
            <span class="n">mass_oil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">mass_oil</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_oil</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mass_oil</span> <span class="o">=</span> <span class="n">mass_oil</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">mass_fraction</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">mass_oil</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_evaporated&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">oil_water_surface_tension</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Oil-water surface tension is </span><span class="si">%f</span><span class="s1"> Nm&#39;</span> <span class="o">%</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">max_water_fractions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resources</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s1">&#39;opendrift.models.openoil.adios&#39;</span><span class="p">,</span> <span class="s1">&#39;max_water_fraction.json&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span> <span class="ow">in</span> <span class="n">max_water_fractions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_water_fraction</span> <span class="o">=</span> <span class="n">max_water_fractions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span><span class="p">]</span>
                <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_water_fraction</span><span class="p">[</span><span class="s1">&#39;temperatures&#39;</span><span class="p">]</span>
                <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_water_fraction</span><span class="p">[</span><span class="s1">&#39;max_water_fraction&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using max water fractions </span><span class="si">{</span><span class="n">wf</span><span class="si">}</span><span class="s1"> for temperatures </span><span class="si">{</span><span class="n">T</span><span class="si">}</span><span class="s1"> for oiltype </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Corresponding max water fraction from GNOME is &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">gnome_oil</span><span class="p">[</span><span class="s2">&quot;emulsion_water_fraction_max&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max water fraction not available for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span><span class="si">}</span><span class="s1">, using default&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not load max water content file&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OpenOil</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">prepare_run</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpenOil.oil_weathering_noaa">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.oil_weathering_noaa">[docs]</a>
    <span class="k">def</span> <span class="nf">oil_weathering_noaa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Oil weathering scheme adopted from NOAA PyGNOME model:</span>
<span class="sd">        https://github.com/NOAA-ORR-ERD/PyGnome</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;NOAA oil weathering&#39;</span><span class="p">)</span>
        <span class="c1"># C to K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">273.15</span>

        <span class="c1">#########################################################</span>
        <span class="c1"># Update density and viscosity according to temperature</span>
        <span class="c1">#########################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span>
            <span class="s1">&#39;main loop:updating elements:oil weathering:updating viscosities&#39;</span><span class="p">)</span>
        <span class="n">oil_viscosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KinematicViscosity</span><span class="o">.</span><span class="n">at_temp</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span>
            <span class="s1">&#39;main loop:updating elements:oil weathering:updating viscosities&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span>
            <span class="s1">&#39;main loop:updating elements:oil weathering:updating densities&#39;</span><span class="p">)</span>
        <span class="n">oil_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Density</span><span class="o">.</span><span class="n">at_temp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span>
            <span class="s1">&#39;main loop:updating elements:oil weathering:updating densities&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate emulsion density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">water_fraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">()</span> <span class="o">+</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">water_fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">oil_density</span><span class="p">)</span>

        <span class="c1"># Calculate emulsion viscosity</span>
        <span class="n">visc_f_ref</span> <span class="o">=</span> <span class="mf">0.84</span>  <span class="c1"># From PyGNOME</span>
        <span class="n">visc_curvfit_param</span> <span class="o">=</span> <span class="mf">1.5e3</span>  <span class="c1"># units are sec^0.5 / m</span>
        <span class="n">fw_d_fref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">water_fraction</span> <span class="o">/</span> <span class="n">visc_f_ref</span>
        <span class="n">kv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">oil_viscosity</span><span class="p">)</span> <span class="o">*</span> <span class="n">visc_curvfit_param</span>
        <span class="n">kv1</span><span class="p">[</span><span class="n">kv1</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">kv1</span><span class="p">[</span><span class="n">kv1</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1"># NB: neglecting dispersed and biodegraded in calculation of fraction_evaporated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">fraction_evaporated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_evaporated</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_evaporated</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">oil_viscosity</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kv1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">fraction_evaporated</span><span class="p">)</span> <span class="o">*</span> 
                <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">fw_d_fref</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.187</span> <span class="o">-</span> <span class="n">fw_d_fref</span><span class="p">)))</span><span class="o">**</span><span class="mf">2.49</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:evaporation&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:evaporation&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaporation_noaa</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:evaporation&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:emulsification&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:emulsification&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emulsification_noaa</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:emulsification&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:dispersion&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:dispersion&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disperse_noaa</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:dispersion&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:biodegradation&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:biodegradation&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biodegradation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span>
                <span class="s1">&#39;main loop:updating elements:oil weathering:biodegradation&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Should not happen</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;NEGATIVE OIL MASS!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.disperse_noaa">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.disperse_noaa">[docs]</a>
    <span class="k">def</span> <span class="nf">disperse_noaa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Calculating: dispersion - NOAA&#39;</span><span class="p">)</span>
        <span class="c1"># From NOAA PyGnome model:</span>
        <span class="c1"># https://github.com/NOAA-ORR-ERD/PyGnome/</span>
        <span class="n">c_disp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_energy_dissipation</span><span class="p">(),</span> <span class="mf">0.57</span><span class="p">)</span> <span class="o">*</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">sea_surface_wave_breaking_fraction</span><span class="p">()</span>
        <span class="c1"># Roy&#39;s constant</span>
        <span class="n">C_Roy</span> <span class="o">=</span> <span class="mf">2400.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="o">-</span><span class="mf">73.682</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">))</span>
        <span class="n">v_entrain</span> <span class="o">=</span> <span class="mf">3.9E-8</span>
        <span class="n">q_disp</span> <span class="o">=</span> <span class="n">C_Roy</span> <span class="o">*</span> <span class="n">c_disp</span> <span class="o">*</span> <span class="n">v_entrain</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span>
        <span class="n">fraction_dispersed</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_disp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fraction_dispersed</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Dispersion fraction larger than 1 -&gt; setting to 0.99&#39;</span><span class="p">)</span>
            <span class="n">fraction_dispersed</span><span class="p">[</span><span class="n">fraction_dispersed</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.99</span>
        <span class="n">oil_mass_loss</span> <span class="o">=</span> <span class="n">fraction_dispersed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fraction_dispersed</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span> <span class="o">-=</span> <span class="n">oil_mass_loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_dispersed</span> <span class="o">+=</span> <span class="n">oil_mass_loss</span></div>


<div class="viewcode-block" id="OpenOil.plot_droplet_spectrum">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.plot_droplet_spectrum">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_droplet_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Plotting distribution of droplet radii, for debugging&#39;&#39;&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpenOil.evaporation_noaa">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.evaporation_noaa">[docs]</a>
    <span class="k">def</span> <span class="nf">evaporation_noaa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#############################################</span>
        <span class="c1"># Evaporation, for elements at surface only</span>
        <span class="c1">#############################################</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Calculating evaporation - NOAA&#39;</span><span class="p">)</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># of active elements</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;All elements submerged, no evaporation&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;All surface oil elements older than 24 hours, &#39;</span> <span class="o">+</span>
                         <span class="s1">&#39;skipping further evaporation.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">surfaceID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># of any elements</span>
        <span class="c1"># Area for each element, repeated for each component</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">/</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">[</span><span class="n">surface</span><span class="p">])</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span>
        <span class="n">evap_decay_constant</span> <span class="o">=</span> <span class="n">noaa</span><span class="o">.</span><span class="n">evap_decay_constant</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wind_speed</span><span class="p">()[</span><span class="n">surface</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span><span class="p">[</span><span class="n">surface</span><span class="p">],</span> <span class="n">area</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="n">surfaceID</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">mass_remain</span> <span class="o">=</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="n">surfaceID</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
             <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">evap_decay_constant</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_evaporated</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">+=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span>
                    <span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="n">surfaceID</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mass_remain</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noaa_mass_balance</span><span class="p">[</span><span class="s1">&#39;mass_components&#39;</span><span class="p">][</span><span class="n">surfaceID</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> \
            <span class="n">mass_remain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">mass_oil</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_remain</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.emulsification_noaa">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.emulsification_noaa">[docs]</a>
    <span class="k">def</span> <span class="nf">emulsification_noaa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#############################################</span>
        <span class="c1"># Emulsification (surface only)</span>
        <span class="c1">#############################################</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Calculating emulsification - NOAA&#39;</span><span class="p">)</span>
        <span class="n">emul_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">bulltime</span>
        <span class="n">emul_constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">bullwinkle</span>

        <span class="c1"># Emulsify...</span>
        <span class="c1"># f ((le_age &gt;= emul_time &amp;&amp; emul_time &gt;= 0.) || frac_evap[i] &gt;= emul_C &amp;&amp; emul_C &gt; 0.)</span>

        <span class="n">start_emulsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span> <span class="o">&gt;=</span> <span class="n">emul_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">emul_time</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
                                  <span class="o">|</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">fraction_evaporated</span> <span class="o">&gt;=</span> <span class="n">emul_constant</span><span class="p">)</span>
                                     <span class="o">&amp;</span> <span class="p">(</span><span class="n">emul_constant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_emulsion</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;        Emulsification not yet started&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># max water content fraction - get from database</span>
        <span class="n">Y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">emulsion_water_fraction_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_water_fraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_water_fraction</span><span class="p">[</span><span class="s1">&#39;max_water_fraction&#39;</span><span class="p">]</span>
            <span class="n">wft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_water_fraction</span><span class="p">[</span><span class="s1">&#39;temperatures&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">wf</span> <span class="o">=</span> <span class="p">[</span><span class="n">wf</span><span class="p">,</span> <span class="n">wf</span><span class="p">]</span>
                <span class="n">wft</span> <span class="o">=</span> <span class="p">[</span><span class="n">wft</span><span class="p">,</span> <span class="n">wft</span><span class="p">]</span>
            <span class="n">swt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>  <span class="c1"># to Celcius</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">wft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">swt</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">wft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wft</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">swt</span><span class="o">&gt;</span><span class="n">wft</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">swt</span><span class="o">&lt;=</span><span class="n">wft</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">max_water_fraction_sintef</span> <span class="o">=</span> <span class="n">weights</span><span class="o">*</span><span class="n">wf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weights</span><span class="p">)</span><span class="o">*</span><span class="n">wf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">Y_max</span> <span class="o">-</span> <span class="n">max_water_fraction_sintef</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Overriding max water fraction </span><span class="si">{</span><span class="n">Y_max</span><span class="si">}</span><span class="s1"> with linear fit to SINTEF max values:&#39;</span>
                    <span class="sa">f</span><span class="s1">&#39; T: </span><span class="si">{</span><span class="n">wft</span><span class="si">}</span><span class="s1">, Fraction: </span><span class="si">{</span><span class="n">wf</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">Y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">Y_max</span><span class="p">,</span> <span class="n">max_water_fraction_sintef</span><span class="p">))</span>
        <span class="c1"># emulsion</span>
        <span class="k">if</span> <span class="n">Y_max</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Oil does not emulsify, returning.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Constants for droplets</span>
        <span class="n">drop_min</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
        <span class="n">drop_max</span> <span class="o">=</span> <span class="mf">1.0e-5</span>
        <span class="n">S_max</span> <span class="o">=</span> <span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="n">drop_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y_max</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Y_max</span><span class="p">))</span>
        <span class="n">S_min</span> <span class="o">=</span> <span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="n">drop_max</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y_max</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">Y_max</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">bulltime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># User has set value</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">bulltime</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_emulsion</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span>
            <span class="c1"># TODO: it should be possible to specify oil age at seeding</span>
            <span class="n">start_time</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">&gt;=</span>
                       <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">bulltime</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span>
        <span class="c1"># Update droplet interfacial area</span>
        <span class="n">k_emul</span> <span class="o">=</span> <span class="n">noaa</span><span class="o">.</span><span class="n">water_uptake_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_speed</span><span class="p">()[</span><span class="n">start_emulsion</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">interfacial_area</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">interfacial_area</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">(</span><span class="n">k_emul</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="n">k_emul</span><span class="o">/</span><span class="n">S_max</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">interfacial_area</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">interfacial_area</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">],</span> <span class="n">S_max</span><span class="p">)</span>
        <span class="c1"># Update water fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">water_fraction</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">interfacial_area</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">*</span> <span class="n">drop_max</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span> <span class="o">+</span>
             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">interfacial_area</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">*</span> <span class="n">drop_max</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">water_fraction</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">water_fraction</span><span class="p">[</span><span class="n">start_emulsion</span><span class="p">],</span> <span class="n">Y_max</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.update_terminal_velocity">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.update_terminal_velocity">[docs]</a>
    <span class="k">def</span> <span class="nf">update_terminal_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">Tprofiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">Sprofiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">z_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate terminal velocity for oil droplets</span>

<span class="sd">        according to:</span>

<span class="sd">        * Tkalich et al. (2002): Vertical mixing of oil droplets by breaking waves</span>

<span class="sd">        * Marine Pollution Bulletin 44, 1219-1229</span>

<span class="sd">        If profiles of temperature and salt are passed into this function,</span>
<span class="sd">        they will be interpolated from the profiles.</span>
<span class="sd">        if not, T,S will be fetched from reader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>  <span class="c1"># ms-2</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span>  <span class="c1"># NB: r is diameter, not radius</span>

        <span class="c1"># Prepare interpolation of temp, salt</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Tprofiles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Sprofiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">z_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z_i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># evtl. move out of loop</span>
                <span class="c1"># evtl. move out of loop</span>
                <span class="n">z_index</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
                                   <span class="n">z_i</span><span class="p">,</span>
                                   <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">zi</span> <span class="o">=</span> <span class="n">z_index</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">upper</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">weight_upper</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">zi</span> <span class="o">-</span> <span class="n">upper</span><span class="p">)</span>

        <span class="c1"># Do interpolation of temp, salt if profiles were passed into</span>
        <span class="c1"># this function, if not, use reader by calling self.environment</span>
        <span class="k">if</span> <span class="n">Tprofiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_temperature</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T0</span> <span class="o">=</span> <span class="n">Tprofiles</span><span class="p">[</span><span class="n">upper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="n">weight_upper</span> <span class="o">+</span> \
                <span class="n">Tprofiles</span><span class="p">[</span><span class="n">lower</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Tprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight_upper</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Sprofiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">S0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_water_salinity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">S0</span> <span class="o">=</span> <span class="n">Sprofiles</span><span class="p">[</span><span class="n">upper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Sprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="n">weight_upper</span> <span class="o">+</span> \
                <span class="n">Sprofiles</span><span class="p">[</span><span class="n">lower</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">Sprofiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">weight_upper</span><span class="p">)</span>

        <span class="n">T0</span> <span class="o">=</span> <span class="n">T0</span> <span class="o">-</span> <span class="mf">273.15</span> <span class="c1"># convert to Celcius - needed for the calcs in this method</span>

        <span class="n">rho_oil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span>
        <span class="n">rho_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T0</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="n">S0</span><span class="p">)</span>

        <span class="c1"># dynamic water viscosity</span>
        <span class="n">my_w</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.7915</span> <span class="o">-</span> <span class="mf">0.0538</span> <span class="o">*</span> <span class="n">T0</span> <span class="o">+</span> <span class="mf">0.007</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">T0</span><span class="o">**</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.0023</span> <span class="o">*</span> <span class="n">S0</span><span class="p">)</span>
        <span class="c1"># ~0.0014 kg m-1 s-1</span>
        <span class="c1"># kinemativ water viscosity</span>
        <span class="n">ny_w</span> <span class="o">=</span> <span class="n">my_w</span> <span class="o">/</span> <span class="n">rho_water</span>
        <span class="n">rhopr</span> <span class="o">=</span> <span class="n">rho_oil</span> <span class="o">/</span> <span class="n">rho_water</span>

        <span class="c1"># terminal velocity for low Reynolds numbers</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhopr</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">ny_w</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">kw</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># r is diameter so divide by 2 for radius</span>

        <span class="c1"># check if we are in a high Reynolds number regime</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">W</span> <span class="o">/</span> <span class="n">ny_w</span> <span class="c1"># r is diameter so no need to multiply by 2</span>
        <span class="n">highRe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Re</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>

        <span class="c1"># Terminal velocity in high Reynolds numbers</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rhopr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">W2</span> <span class="o">=</span> <span class="n">kw</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="n">W</span><span class="p">[</span><span class="n">highRe</span><span class="p">]</span> <span class="o">=</span> <span class="n">W2</span><span class="p">[</span><span class="n">highRe</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">terminal_velocity</span> <span class="o">=</span> <span class="n">W</span></div>


<div class="viewcode-block" id="OpenOil.oil_wave_entrainment_rate">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.oil_wave_entrainment_rate">[docs]</a>
    <span class="k">def</span> <span class="nf">oil_wave_entrainment_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">er</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;wave_entrainment:entrainment_rate&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">er</span> <span class="o">==</span> <span class="s1">&#39;Li et al. (2017)&#39;</span><span class="p">:</span>
            <span class="n">entrainment_rate</span> <span class="o">=</span> <span class="n">oil_wave_entrainment_rate_li2017</span><span class="p">(</span>
                <span class="n">dynamic_viscosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                <span class="n">oil_density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                <span class="n">interfacial_tension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span><span class="p">,</span>
                <span class="n">significant_wave_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">(),</span>
                <span class="n">wave_breaking_fraction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sea_surface_wave_breaking_fraction</span><span class="p">(</span>
                <span class="p">),</span>
                <span class="n">sea_water_density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">entrainment_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;no entrainment rate mechanism configured&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no entrainment rate mechanism configured&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.prepare_vertical_mixing">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.prepare_vertical_mixing">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare_vertical_mixing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Calculate entrainment probability before main loop&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_entrainment_probability</span> <span class="o">=</span> \
            <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">oil_wave_entrainment_rate</span><span class="p">()</span><span class="o">*</span>\
                       <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;vertical_mixing:timestep&#39;</span><span class="p">))</span>
        <span class="c1"># Calculate a random droplet diameter for each particle,</span>
        <span class="c1"># to be used if this particle gets entrained</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">droplet_diameter_if_entrained</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_wave_breaking_droplet_diameter</span><span class="p">()</span></div>

        <span class="c1"># Uncomment lines below to plot droplet size distribution at each step</span>
        <span class="c1">#import matplotlib.pyplot as plt</span>
        <span class="c1">#plt.hist(self.droplet_diameter_if_entrained, 200)</span>
        <span class="c1">#plt.gca().set_xscale(&quot;log&quot;)</span>
        <span class="c1">#plt.gca().set_yscale(&quot;log&quot;)</span>
        <span class="c1">#plt.show()</span>

<div class="viewcode-block" id="OpenOil.surface_wave_mixing">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.surface_wave_mixing">[docs]</a>
    <span class="k">def</span> <span class="nf">surface_wave_mixing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_step_seconds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mix surface oil into water column.&quot;&quot;&quot;</span>
        <span class="c1"># Entrain oil into uppermost layer (whitecapping from waves)</span>
        <span class="c1"># TODO: optimise this by only calculate for surface elements</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">random_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
        <span class="n">entrained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">surface</span><span class="p">,</span> <span class="n">random_number</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_entrainment_probability</span><span class="p">)</span>

        <span class="c1"># Intrusion depth for wave entrainment from</span>
        <span class="c1"># Delvigne and Sweeney (1988), Li et al. (2017):</span>
        <span class="k">if</span> <span class="n">entrained</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entraining </span><span class="si">%i</span><span class="s1"> of </span><span class="si">%i</span><span class="s1"> surface elements&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">entrained</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">surface</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
            <span class="n">zb</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span>  <span class="c1"># between 0 and zb</span>
            <span class="n">intrusion_depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">zb</span><span class="p">),</span>
                                                <span class="n">entrained</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">entrained</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">intrusion_depth</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_droplet_diameter</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># Give entrained elements a random diameter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span><span class="p">[</span><span class="n">entrained</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">droplet_diameter_if_entrained</span><span class="p">[</span><span class="n">entrained</span><span class="p">]</span></div>


<div class="viewcode-block" id="OpenOil.surface_stick">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.surface_stick">[docs]</a>
    <span class="k">def</span> <span class="nf">surface_stick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set surfaced particles to exactly zero depth to let them form a slick &quot;&quot;&quot;</span>

        <span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">surface</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span></div>


<div class="viewcode-block" id="OpenOil.get_wave_breaking_droplet_diameter">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.get_wave_breaking_droplet_diameter">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wave_breaking_droplet_diameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;wave_entrainment:droplet_size_distribution&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dm</span> <span class="o">==</span> <span class="s1">&#39;Johansen et al. (2015)&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wave_breaking_droplet_diameter_johansen2015</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dm</span> <span class="o">==</span> <span class="s1">&#39;Li et al. (2017)&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wave_breaking_droplet_diameter_liz2017</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no wave entrainment droplet size distribution specified&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.get_wave_breaking_droplet_diameter_liz2017">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.get_wave_breaking_droplet_diameter_liz2017">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wave_breaking_droplet_diameter_liz2017</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Li,Zhengkai, M. Spaulding, D. French-McCay, D. Crowley, J.R. Payne: &quot;Development of a unified oil droplet size distribution model</span>
        <span class="c1"># with application to surface breaking waves and subsea blowout releases considering dispersant effects&quot; Mar. Pol. Bul.</span>
        <span class="c1"># DOI: 10.1016/j.marpolbul.2016.09.008</span>
        <span class="c1"># Should be prefered when the oil film thickness is unknown.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;droplet_spectrum_pdf&#39;</span><span class="p">):</span>
            <span class="c1"># Generate droplet spectrum as in Li (Zhengkai) et al. (2017)</span>
            <span class="c1"># Bounds are hardcoded to 1 micron and 3mm</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generating wave breaking droplet size spectrum&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">3e-3</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>
            <span class="n">interfacial_tension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span>
            <span class="n">delta_rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span>
            <span class="n">d_o</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">interfacial_tension</span> <span class="o">/</span> <span class="p">(</span><span class="n">delta_rho</span> <span class="o">*</span> <span class="n">g</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">we</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sea_water_density</span><span class="p">()</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">()</span> <span class="o">*</span> <span class="n">d_o</span><span class="p">)</span> <span class="o">/</span> <span class="n">interfacial_tension</span>
            <span class="n">oh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">interfacial_tension</span> <span class="o">*</span>
                <span class="n">d_o</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.5</span>  <span class="c1"># From kin. to dyn. viscosity by * density</span>
            <span class="n">r</span> <span class="o">=</span> <span class="mf">1.791</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mf">0.460</span>
            <span class="n">q</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.518</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">d_o</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">oh</span>
            <span class="p">)</span><span class="o">**</span><span class="n">p</span> <span class="o">*</span> <span class="n">we</span><span class="o">**</span><span class="n">q</span>  <span class="c1"># median droplet diameter in volume distribution</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># log standard deviation in log10 units</span>
            <span class="n">Sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">sd</span>  <span class="c1"># log standard deviation in natural log units</span>
            <span class="c1"># TODO: calculation below with scalars, but we have arrays, with varying oil properties</span>
            <span class="c1"># treat all particle in one go:</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dV_50</span><span class="p">)</span>  <span class="c1"># mean log diameter</span>
            <span class="n">dN_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dV_50</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span>
                <span class="n">Sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># convert number distribution to volume distribution</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Droplet distribution median diameter dV_50: </span><span class="si">%f</span><span class="s1">, dN_50: </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">dV_50</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dN_50</span><span class="p">)))</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dV_50</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span>
                <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">*</span> <span class="n">Sd</span> <span class="o">*</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not update droplet diameters.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span>
                                    <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.get_wave_breaking_droplet_diameter_johansen2015">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.get_wave_breaking_droplet_diameter_johansen2015">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wave_breaking_droplet_diameter_johansen2015</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Johansen O, Reed M, Bodsberg NR, Natural dispersion revisited</span>
        <span class="c1"># DOI: 10.1016/j.marpolbul.2015.02.026</span>
        <span class="c1"># requires oil film thickness</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;droplet_spectrum_pdf&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span>
                <span class="s1">&#39;processes:update_oilfilm_thickness&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Generate droplet spectrum as in Johansen et al. (2015)</span>
            <span class="c1"># Bounds are hardcoded to 1micron and 3mm</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generating wave breaking droplet size spectrum&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">3e-3</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>
            <span class="n">interfacial_tension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_water_interfacial_tension</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">significant_wave_height</span><span class="p">(</span>
            <span class="p">)</span>  <span class="c1"># fall height = 2 * wave amplitude</span>
            <span class="c1"># Reyolds number (Eq. 7a from Johansen et al. 2015)</span>
            <span class="n">re</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span> <span class="o">*</span>
                  <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">H</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">*</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>
            <span class="c1"># Weber number (Eq. 7b from Johansen et al.2015)</span>
            <span class="n">we</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span> <span class="o">*</span>
                  <span class="n">g</span> <span class="o">*</span> <span class="n">H</span><span class="p">)</span> <span class="o">/</span> <span class="n">interfacial_tension</span>  <span class="c1"># Weber number</span>
            <span class="n">A</span> <span class="o">=</span> <span class="mf">2.251</span>  <span class="c1"># parameters from Johansen et al. 2015</span>
            <span class="n">Bp</span> <span class="o">=</span> <span class="mf">0.027</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">Bp</span>
            <span class="n">dN_50</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span> <span class="o">*</span> <span class="n">we</span><span class="o">**-</span><span class="mf">0.6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">B</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">oil_film_thickness</span> <span class="o">*</span> <span class="n">re</span><span class="o">**-</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="c1"># median droplet diameter in number distribution</span>
            <span class="n">sd</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># log standard deviation in log10 units</span>
            <span class="n">Sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">sd</span>  <span class="c1"># log standard deviation in natural log units</span>
            <span class="c1"># Convert number distribution to volume distribution</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dN_50</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">Sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># TODO: calculation below with scalars, but we have</span>
            <span class="c1"># arrays, with varying oil properties</span>
            <span class="c1"># treat all particle in one go:</span>
            <span class="n">dV_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dV_50</span><span class="p">)</span>  <span class="c1"># mean log diameter</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Droplet distribution median diameter dV_50: </span><span class="si">%f</span><span class="s1">, dN_50: </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">dV_50</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dN_50</span><span class="p">)))</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dV_50</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span>
                <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Sd</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span> <span class="o">*</span> <span class="n">Sd</span> <span class="o">*</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">))</span> <span class="ow">or</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not update droplet diameters.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">diameter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_diameter</span><span class="p">,</span>
                                    <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span>
                                    <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.resurface_elements">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.resurface_elements">[docs]</a>
    <span class="k">def</span> <span class="nf">resurface_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimum_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Oil elements reaching surface (or above) form slick, not droplet&quot;&quot;&quot;</span>
        <span class="n">surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">surface</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="OpenOil.advect_oil">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.advect_oil">[docs]</a>
    <span class="k">def</span> <span class="nf">advect_oil</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Calculating various drift factors according to ice concentration</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="s1">&#39;sea_ice_area_fraction&#39;</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sea_ice_area_fraction</span>
            <span class="c1"># According to</span>
            <span class="c1"># Nordam T, Beegle-Krause CJ, Skancke J, Nepstad R, Reed M.</span>
            <span class="c1"># Improving oil spill trajectory modelling in the Arctic.</span>
            <span class="c1"># Mar Pollut Bull. 2019;140:65-74.</span>
            <span class="c1"># doi:10.1016/j.marpolbul.2019.01.019</span>
            <span class="n">k_ice</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.8</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">)</span>
            <span class="n">k_ice</span><span class="p">[</span><span class="n">A</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">k_ice</span><span class="p">[</span><span class="n">A</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">k_ice</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Ice concentration above 30%, using Nordam scheme for advection in ice&#39;</span>
                <span class="p">)</span>
            <span class="c1"># Using decreased Stokes drift according to</span>
            <span class="c1"># Arneborg, L. (2017). Oil drift modellling in pack ice</span>
            <span class="c1"># - Sensitivity of oil-in-ice parameters.</span>
            <span class="c1"># Ocean Engineering 144 (2017) 340-350</span>
            <span class="n">factor_stokes</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.7</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.7</span>
            <span class="n">factor_stokes</span><span class="p">[</span><span class="n">A</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_ice</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">factor_stokes</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Simply move particles with ambient current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advect_ocean_current</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">k_ice</span><span class="p">)</span>

        <span class="c1"># Wind drag for elements at ocean surface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advect_wind</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">k_ice</span><span class="p">)</span>

        <span class="c1"># Stokes drift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_drift</span><span class="p">(</span><span class="n">factor_stokes</span><span class="p">)</span>

        <span class="c1"># Advect with ice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advect_with_sea_ice</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="n">k_ice</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.update">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update positions and properties of oil particles.&quot;&quot;&quot;</span>

        <span class="c1"># TODO: move all config-checking inside respective methods</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;processes:update_oilfilm_thickness&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_surface_oilfilm_thickness</span><span class="p">()</span>

        <span class="c1"># Oil weathering (inherited from OpenOil)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering</span><span class="p">()</span>

        <span class="c1"># Turbulent Mixing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:vertical_mixing&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_terminal_velocity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_mixing</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">droplet_spectrum_pdf</span>

        <span class="c1"># Vertical advection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:vertical_advection&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertical_advection</span><span class="p">()</span>

        <span class="c1"># Horizontal advection (inherited from OpenOil)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">advect_oil</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpenOil.get_oil_budget">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.get_oil_budget">[docs]</a>
    <span class="k">def</span> <span class="nf">get_oil_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get oil budget for the current simulation</span>

<span class="sd">        The oil budget consists of the following categories:</span>

<span class="sd">        * surface: the sum of variable mass_oil for all active elements where z = 0</span>
<span class="sd">        * submerged: the sum of variable mass_oil for all active elements where z &lt; 0</span>
<span class="sd">        * stranded: the sum of variable mass_oil for all elements which are stranded</span>
<span class="sd">        * evaporated: the sum of variable mass_evaporated for all elements</span>
<span class="sd">        * dispersed: the sum of variable mass_dispersed for all elements</span>

<span class="sd">        The sum (total mass) shall equal the mass released. Note that the mass of oil</span>
<span class="sd">        is conserved, whereas the volume may change with changes in density and</span>
<span class="sd">        water uptake (emulsification). Therefore mass should be used for budgets,</span>
<span class="sd">        eventually converted to volume (by dividing on density) in the final step</span>
<span class="sd">        before presentation.</span>

<span class="sd">        Note that mass_oil is the mass of pure oil. The mass of oil emulsion</span>
<span class="sd">        (oil containing entrained water droplets) can be calculated as:</span>

<span class="sd">        .. code::</span>

<span class="sd">            mass_emulsion = mass_oil / (1 - water_fraction)</span>

<span class="sd">        I.e. water_fraction = 0 means pure oil, water_fraction = 0.5 means mixture of</span>
<span class="sd">        50% oil and 50% water, and water_fraction = 0.9 (which is maximum)</span>
<span class="sd">        means 10% oil and 90% water.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Backwards simulation</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">z</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="n">mass_oil</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;mass_oil&#39;</span><span class="p">)</span>
        <span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;density&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;stranded&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stranded&#39;</span><span class="p">)</span>
        <span class="n">mass_submerged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;stranded&#39;</span><span class="p">))</span> <span class="o">|</span>
             <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)),</span> <span class="n">mass_oil</span><span class="p">)</span>
        <span class="n">mass_submerged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_submerged</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mass_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;stranded&#39;</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)),</span>
            <span class="n">mass_oil</span><span class="p">)</span>
        <span class="n">mass_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_surface</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mass_stranded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;stranded&#39;</span><span class="p">),</span> <span class="n">mass_oil</span><span class="p">),</span>
                                  <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mass_evaporated</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;mass_evaporated&#39;</span><span class="p">)</span>
        <span class="n">mass_evaporated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_evaporated</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mass_dispersed</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;mass_dispersed&#39;</span><span class="p">)</span>
        <span class="n">mass_dispersed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_dispersed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mass_biodegraded</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;mass_biodegraded&#39;</span><span class="p">)</span>
        <span class="n">mass_biodegraded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mass_biodegraded</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">oil_budget</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;oil_density&#39;</span><span class="p">:</span>
            <span class="n">density</span><span class="p">,</span>
            <span class="s1">&#39;mass_dispersed&#39;</span><span class="p">:</span>
            <span class="n">mass_dispersed</span><span class="p">,</span>
            <span class="s1">&#39;mass_submerged&#39;</span><span class="p">:</span>
            <span class="n">mass_submerged</span><span class="p">,</span>
            <span class="s1">&#39;mass_surface&#39;</span><span class="p">:</span>
            <span class="n">mass_surface</span><span class="p">,</span>
            <span class="s1">&#39;mass_stranded&#39;</span><span class="p">:</span>
            <span class="n">mass_stranded</span><span class="p">,</span>
            <span class="s1">&#39;mass_evaporated&#39;</span><span class="p">:</span>
            <span class="n">mass_evaporated</span><span class="p">,</span>
            <span class="s1">&#39;mass_biodegraded&#39;</span><span class="p">:</span>
            <span class="n">mass_biodegraded</span><span class="p">,</span>
            <span class="s1">&#39;mass_total&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">mass_dispersed</span> <span class="o">+</span> <span class="n">mass_submerged</span> <span class="o">+</span> <span class="n">mass_surface</span> <span class="o">+</span>
                           <span class="n">mass_stranded</span> <span class="o">+</span> <span class="n">mass_evaporated</span> <span class="o">+</span> <span class="n">mass_biodegraded</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">oil_budget</span></div>


<div class="viewcode-block" id="OpenOil.plot_oil_budget">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.plot_oil_budget">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_oil_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">show_watercontent_and_viscosity</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">show_wind_and_current</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Backwards simulation</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">6.</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Oil weathering deactivated for &#39;</span>
                     <span class="s1">&#39;backwards simulations&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_oil_budget</span><span class="p">()</span>

        <span class="n">oil_budget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">(</span>
            <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_dispersed&#39;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_submerged&#39;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_surface&#39;</span><span class="p">],</span>
             <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_stranded&#39;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_evaporated&#39;</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_biodegraded&#39;</span><span class="p">]))</span>
        <span class="n">oil_density</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;oil_density&#39;</span><span class="p">]</span>

        <span class="n">budget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">oil_budget</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">time</span><span class="p">,</span> <span class="n">time_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_relative</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Left axis showing oil mass</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">show_watercontent_and_viscosity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">show_wind_and_current</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">nrows</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">6.</span> <span class="o">+</span> <span class="p">(</span><span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Suitable aspect ratio</span>
            <span class="c1">#ax1 = fig.add_subplot(nrows=nrows, 1, 1)</span>
            <span class="k">if</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">axs</span>
            <span class="k">elif</span> <span class="n">nrows</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">show_watercontent_and_viscosity</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_oil_watercontent_and_viscosity</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_wind_and_current</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_environment</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">nrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span>

        <span class="c1"># Hack: make some emply plots since fill_between does not support label</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_dispersed&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkslategrey&#39;</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;dispersed&#39;</span><span class="p">))</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">budget</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;darkslategrey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_submerged&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;submerged&#39;</span><span class="p">))</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_surface&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">))</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_stranded&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;stranded&#39;</span><span class="p">))</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_evaporated&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;evaporated&#39;</span><span class="p">))</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_biodegraded&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="mi">0</span><span class="p">,</span>
                              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;indigo&#39;</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;biodegraded&#39;</span><span class="p">))</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">budget</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span>
                             <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;indigo&#39;</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">budget</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Mass oil  [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;mass_oil&#39;</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time  [hours]&#39;</span><span class="p">)</span>
        <span class="c1"># Right axis showing volume</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">mass_total</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mass_total&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">mass_total</span> <span class="o">/</span> <span class="n">oil_density</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volume oil [m3]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%.1f</span><span class="s1"> kg/m3) - </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_oil_name</span><span class="p">(),</span> <span class="n">oil_density</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)))</span>
        <span class="c1"># Shrink current axis&#39;s height by 10% on the bottom</span>
        <span class="c1">#box = ax1.get_position()</span>
        <span class="c1">#ax1.set_position(</span>
        <span class="c1">#    [box.x0, box.y0 + box.height * 0.15, box.width, box.height * 0.85])</span>
        <span class="c1">#ax2.set_position(</span>
        <span class="c1">#    [box.x0, box.y0 + box.height * 0.5, box.width, box.height * 0.6])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.04</span><span class="p">),</span>
                   <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                   <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span>
                   <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                   <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpenOil.get_oil_name">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.get_oil_name">[docs]</a>
    <span class="k">def</span> <span class="nf">get_oil_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># fallback if importing old files</span>
            <span class="k">return</span> <span class="s1">&#39;unknown oiltype&#39;</span></div>


<div class="viewcode-block" id="OpenOil.cumulative_oil_entrainment_fraction">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.cumulative_oil_entrainment_fraction">[docs]</a>
    <span class="k">def</span> <span class="nf">cumulative_oil_entrainment_fraction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the fraction of oil elements which has been entrained vs time&#39;&#39;&#39;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">notmasked_edges</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">maskfirst</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maskrow</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">maskfirst</span><span class="p">,</span> <span class="n">maskrow</span><span class="p">):</span>
            <span class="n">z</span><span class="p">[</span><span class="n">mf</span><span class="p">:</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># has been entrained</span>
        <span class="n">totentrained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cumulative_fraction_entrained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cumulative_fraction_entrained</span></div>


<div class="viewcode-block" id="OpenOil.plot_oil_watercontent_and_viscosity">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.plot_oil_watercontent_and_viscosity">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_oil_watercontent_and_viscosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>

        <span class="n">time</span><span class="p">,</span> <span class="n">time_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_relative</span><span class="p">])</span>
        <span class="n">kin_viscosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;viscosity&#39;</span><span class="p">]</span>
        <span class="n">dyn_viscosity</span> <span class="o">=</span> <span class="n">kin_viscosity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># unit of mPas</span>
        <span class="n">dyn_viscosity_mean</span> <span class="o">=</span> <span class="n">dyn_viscosity</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dyn_viscosity_std</span> <span class="o">=</span> <span class="n">dyn_viscosity</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">density_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">watercontent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;water_fraction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">watercontent_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;water_fraction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                <span class="n">dyn_viscosity_mean</span><span class="p">,</span>
                <span class="s1">&#39;g&#39;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Emulsion viscosity&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                        <span class="n">dyn_viscosity_mean</span> <span class="o">-</span> <span class="n">dyn_viscosity_std</span><span class="p">,</span>
                        <span class="n">dyn_viscosity_mean</span> <span class="o">+</span> <span class="n">dyn_viscosity_std</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">dyn_viscosity_mean</span> <span class="o">+</span> <span class="n">dyn_viscosity_std</span><span class="p">)])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Emulsion viscosity  [cPoise] / [mPas]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>

        <span class="n">axb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">axb</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">watercontent</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Water content&#39;</span><span class="p">)</span>
        <span class="n">axb</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>
                         <span class="n">watercontent</span> <span class="o">-</span> <span class="n">watercontent_std</span><span class="p">,</span>
                         <span class="n">watercontent</span> <span class="o">+</span> <span class="n">watercontent_std</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [hours]&#39;</span><span class="p">)</span>
        <span class="n">axb</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
        <span class="n">axb</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Water content  [%]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">axb</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">axb</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="OpenOil.set_oiltype">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.set_oiltype">[docs]</a>
    <span class="k">def</span> <span class="nf">set_oiltype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oiltype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the oil type by specifying the name, the first match will be chosen. See the `ADIOS database &lt;https://adios.orr.noaa.gov/oils&gt;`_ for a list. OpenDrift provides a small set of extra oils.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">oiltype</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_seed_config__</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">,</span> <span class="n">oiltype</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting oil_type to: </span><span class="si">{</span><span class="n">oiltype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">oiltype</span> <span class="o">=</span> <span class="n">adios</span><span class="o">.</span><span class="n">oil_name_alias</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oiltype</span><span class="p">,</span> <span class="n">oiltype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span> <span class="o">=</span> <span class="n">oiltype</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span> <span class="o">=</span> <span class="n">adios</span><span class="o">.</span><span class="n">find_full_oil_from_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">valid</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="si">}</span><span class="s2"> is not a valid oil for Opendrift simulations&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported oil weathering model&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.set_oiltype_by_id">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.set_oiltype_by_id">[docs]</a>
    <span class="k">def</span> <span class="nf">set_oiltype_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oiltypeid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the oil type by specifying the ADIOS ID. See the `ADIOS database &lt;https://adios.orr.noaa.gov/oils&gt;`_ for a list. OpenDrift provides a small set of extra oils.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span> <span class="o">=</span> <span class="n">adios</span><span class="o">.</span><span class="n">get_full_oil_from_id</span><span class="p">(</span><span class="n">oiltypeid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">valid</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="si">}</span><span class="s2"> is not a valid oil for Opendrift simulations&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported oil weathering model&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.set_oiltype_by_json">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.set_oiltype_by_json">[docs]</a>
    <span class="k">def</span> <span class="nf">set_oiltype_by_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the oil type by specifing a JSON dict. The format should be the same as the ADIOS database. See the `ADIOS database &lt;https://adios.orr.noaa.gov/oils&gt;`_ for a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="c1">#o = { &#39;data&#39;: { &#39;attributes&#39; : json } }</span>
            <span class="c1">#o[&#39;data&#39;][&#39;_id&#39;] = o[&#39;data&#39;][&#39;attributes&#39;][&#39;oil_id&#39;]</span>
            <span class="c1">#o[&#39;data&#39;][&#39;attributes&#39;][&#39;metadata&#39;][&#39;location&#39;] = &#39;Norway&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span> <span class="o">=</span> <span class="n">adios</span><span class="o">.</span><span class="n">oil</span><span class="o">.</span><span class="n">OpendriftOil</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oil_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">valid</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="si">}</span><span class="s2"> is not a valid oil for Opendrift simulations&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported oil weathering model&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.set_oiltype_from_file">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.set_oiltype_from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">set_oiltype_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the oil type by specifing a JSON file. The format should be the same as the ADIOS database. See the `ADIOS database &lt;https://adios.orr.noaa.gov/oils&gt;`_ for a list.</span>

<span class="sd">        &gt;&gt;&gt; o = OpenOil()</span>
<span class="sd">        &gt;&gt;&gt; o.set_oiltype_from_file(&#39;opendrift/models/openoil/adios/extra_oils/AD04001.json&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">json</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_oiltype_by_json</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unsupported oil weathering model&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.store_oil_seed_metadata">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.store_oil_seed_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">store_oil_seed_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;m3_per_hour&#39;</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;seed_&#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;radius&#39;</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># There is no default radius</span>
                    <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span> <span class="ow">and</span> <span class="s1">&#39;z&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span>
                            <span class="s1">&#39;seed:seafloor&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;seafloor&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_time&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_time&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;seed_oiltype&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;oiltype&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">oiltype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oiltype&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;oil_type&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">oiltype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oil_type&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">oiltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_oiltype&#39;</span><span class="p">,</span> <span class="n">oiltype</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.seed_elements">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.seed_elements">[docs]</a>
    <span class="k">def</span> <span class="nf">seed_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:number&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;diameter&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Droplet diameter is provided, and will &#39;</span>
                        <span class="s1">&#39;be kept constant during simulation&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_droplet_diameter</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_droplet_diameter</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:seafloor&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;seafloor&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;seafloor&#39;</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>  <span class="c1"># Convert scalar z to array</span>
        <span class="n">subsea</span> <span class="o">=</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">subsea</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;diameter&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">dsd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:droplet_size_distribution&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dsd</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
                <span class="c1"># Droplet min and max for particles seeded below sea surface</span>
                <span class="n">sub_dmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:droplet_diameter_min_subsea&#39;</span><span class="p">)</span>
                <span class="n">sub_dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:droplet_diameter_max_subsea&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using uniform droplet size distribution between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> m for &#39;</span>
                            <span class="s1">&#39;elements seeded below sea surface.&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">sub_dmin</span><span class="p">,</span> <span class="n">sub_dmax</span><span class="p">))</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">sub_dmin</span><span class="p">,</span> <span class="n">sub_dmax</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dsd</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
                <span class="c1"># Droplet mu and sigma for particles seeded below sea surface</span>
                <span class="n">sub_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:droplet_diameter_mu&#39;</span><span class="p">)</span>
                <span class="n">sub_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:droplet_diameter_sigma&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using normal droplet size distribution with &#39;</span>
                            <span class="s1">&#39;mu = </span><span class="si">%s</span><span class="s1"> and sigma = </span><span class="si">%s</span><span class="s1"> m for elements seeded below sea surface.&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">sub_mu</span><span class="p">,</span> <span class="n">sub_sigma</span><span class="p">))</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">sub_mu</span><span class="p">,</span> <span class="n">sub_sigma</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dsd</span> <span class="o">==</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">:</span>
                <span class="c1"># Droplet mu and sigma for particles seeded below sea surface</span>
                <span class="n">sub_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:droplet_diameter_mu&#39;</span><span class="p">)</span>
                <span class="n">sub_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:droplet_diameter_sigma&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using lognormal droplet size distribution with &#39;</span>
                            <span class="s1">&#39;mu = </span><span class="si">%s</span><span class="s1"> and sigma = </span><span class="si">%s</span><span class="s1"> m for elements seeded below sea surface.&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">sub_mu</span><span class="p">,</span> <span class="n">sub_sigma</span><span class="p">))</span>
                <span class="c1"># From numpy.random.lognormal:</span>
                <span class="c1"># &quot;Note that the mean and standard deviation are not the values for the</span>
                <span class="c1"># distribution itself, but of the underlying normal distribution it is derived from.&quot;</span>
                <span class="c1"># So we need to compute the input to the function from the mean and</span>
                <span class="c1"># standard deviation of the data we want to generate (assumed as input)</span>
                <span class="n">sub_sigma2</span> <span class="o">=</span> <span class="n">sub_sigma</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">sub_sigma2_lognormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sub_sigma2</span><span class="o">/</span><span class="n">sub_mu</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sub_mu_lognormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sub_mu</span><span class="p">)</span> <span class="o">-</span> <span class="n">sub_sigma2_lognormal</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">sub_sigma_lognormal</span> <span class="o">=</span> <span class="n">sub_sigma2_lognormal</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">sub_mu_lognormal</span><span class="p">,</span> <span class="n">sub_sigma_lognormal</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
                <span class="c1"># check it worked</span>
                <span class="c1"># print(&#39;median = &#39;+str(np.median(kwargs[&#39;diameter&#39;])))</span>
                <span class="c1"># print(&#39;mean = &#39;+str(np.mean(kwargs[&#39;diameter&#39;])))</span>
                <span class="c1"># print(&#39;sigma = &#39;+str(np.std(kwargs[&#39;diameter&#39;])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no valid initial subsea droplet size distribution specified&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;oiltype&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Seed argument *oiltype* is deprecated, use *oil_type* instead&#39;</span>
            <span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oil_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oiltype&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oiltype&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;oil_type&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oil_type&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__set_seed_config__</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oil_type&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oil_type&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Oil type not specified, using default: &#39;</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_oiltype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oil_weathering_model</span> <span class="o">==</span> <span class="s1">&#39;noaa&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Density</span> <span class="o">=</span> <span class="n">Density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">oil</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KinematicViscosity</span> <span class="o">=</span> <span class="n">KinematicViscosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oiltype</span><span class="o">.</span><span class="n">oil</span><span class="p">)</span>
            <span class="n">oil_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Density</span><span class="o">.</span><span class="n">at_temp</span><span class="p">(</span><span class="mi">285</span><span class="p">)</span>
            <span class="n">oil_viscosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KinematicViscosity</span><span class="o">.</span><span class="n">at_temp</span><span class="p">(</span><span class="mi">285</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Using density </span><span class="si">%s</span><span class="s1"> and viscosity </span><span class="si">%s</span><span class="s1"> of oiltype </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">oil_density</span><span class="p">,</span> <span class="n">oil_viscosity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:oil_type&#39;</span><span class="p">)))</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oil_density</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;viscosity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oil_viscosity</span>

        <span class="k">if</span> <span class="s1">&#39;m3_per_hour&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">m3_per_hour</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;m3_per_hour&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;m3_per_hour&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m3_per_hour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:m3_per_hour&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">num_elements</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:number&#39;</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">duration_hours</span> <span class="o">=</span> <span class="p">((</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="o">/</span> <span class="mi">3600</span>
            <span class="k">if</span> <span class="n">duration_hours</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">duration_hours</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration_hours</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># For instantaneous spill, we use 1h</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mass_oil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m3_per_hour</span> <span class="o">*</span> <span class="n">duration_hours</span> <span class="o">/</span> <span class="n">num_elements</span> <span class="o">*</span>
                              <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store_oil_seed_metadata</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OpenOil</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.seed_cone">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.seed_cone">[docs]</a>
    <span class="k">def</span> <span class="nf">seed_cone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;oiltype&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Seed argument *oiltype* is deprecated, use *oil_type* instead&#39;</span>
            <span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oil_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oiltype&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;oiltype&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store_oil_seed_metadata</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OpenOil</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">seed_cone</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.seed_from_gml">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.seed_from_gml">[docs]</a>
    <span class="k">def</span> <span class="nf">seed_from_gml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gmlfile</span><span class="p">,</span> <span class="n">num_elements</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read oil slick contours from GML file, and seed particles within.&quot;&quot;&quot;</span>

        <span class="c1"># Specific imports</span>
        <span class="kn">import</span> <span class="nn">datetime</span>
        <span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="kn">import</span> <span class="n">Path</span>
        <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">ElementTree</span>
        <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
        <span class="kn">import</span> <span class="nn">pyproj</span>

        <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;od&#39;</span><span class="p">:</span> <span class="s1">&#39;http://cweb.ksat.no/cweb/schema/geoweb/oil&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gml&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.opengis.net/gml&#39;</span>
        <span class="p">}</span>
        <span class="n">slicks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gmlfile</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">pos1</span> <span class="o">=</span> <span class="s1">&#39;od:oilDetectionMember/od:oilDetection/od:oilSpill/gml:Polygon&#39;</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="s1">&#39;gml:exterior/gml:LinearRing/gml:posList&#39;</span>

        <span class="c1"># This retrieves some other types of patches, found in some files only</span>
        <span class="c1"># Should be combines with the above, to get all patches</span>
        <span class="c1">#pos1 = &#39;od:oilDetectionMember/od:oilDetection/od:oilSpill/</span>
        <span class="c1"># gml:Surface/gml:polygonPatches&#39;</span>
        <span class="c1">#pos2 = &#39;gml:PolygonPatch/gml:exterior/gml:LinearRing/gml:posList&#39;</span>

        <span class="c1"># Find detection time</span>
        <span class="n">time_pos</span> <span class="o">=</span> <span class="s1">&#39;od:oilDetectionMember/od:oilDetection/od:detectionTime&#39;</span>
        <span class="n">oil_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">time_pos</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">patch</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">slicks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">))))</span>

        <span class="c1"># Find boundary and area of all patches</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">slick</span> <span class="ow">in</span> <span class="n">slicks</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">slick</span><span class="o">.</span><span class="n">get_extents</span><span class="p">()</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ext</span><span class="o">.</span><span class="n">xmax</span><span class="p">])</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="p">[</span><span class="n">ext</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ext</span><span class="o">.</span><span class="n">ymax</span><span class="p">])</span>
            <span class="c1"># Make a stereographic projection centred on the polygon</span>
        <span class="n">lonmin</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">lonmax</span> <span class="o">=</span> <span class="n">lons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">latmin</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">latmax</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Place n points within the polygons</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span>
            <span class="s1">&#39;+proj=aea +lat_1=</span><span class="si">%f</span><span class="s1"> +lat_2=</span><span class="si">%f</span><span class="s1"> +lat_0=</span><span class="si">%f</span><span class="s1"> +lon_0=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">latmin</span><span class="p">,</span> <span class="n">latmax</span><span class="p">,</span> <span class="p">(</span><span class="n">latmin</span> <span class="o">+</span> <span class="n">latmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">lonmin</span> <span class="o">+</span> <span class="n">lonmax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">slickarea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">slick</span> <span class="ow">in</span> <span class="n">slicks</span><span class="p">:</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="n">slick</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

            <span class="n">area_of_polygon</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">area_of_polygon</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">area_of_polygon</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">area_of_polygon</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">slickarea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slickarea</span><span class="p">,</span> <span class="n">area_of_polygon</span><span class="p">)</span>  <span class="c1"># in m2</span>

        <span class="c1"># Make points</span>
        <span class="n">deltax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">slickarea</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_elements</span><span class="p">)</span>

        <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">latpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slick</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slicks</span><span class="p">):</span>
            <span class="n">lonlat</span> <span class="o">=</span> <span class="n">slick</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
            <span class="n">xvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">deltax</span><span class="p">)</span>
            <span class="n">yvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">deltax</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span> <span class="n">yvec</span><span class="p">)</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">slick</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lonpoints</span><span class="p">,</span> <span class="n">lon</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">latpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latpoints</span><span class="p">,</span> <span class="n">lat</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

        <span class="c1"># Finally seed at found positions</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonpoints</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">oil_time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil.seed_from_geotiff_thickness">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil.seed_from_geotiff_thickness">[docs]</a>
    <span class="k">def</span> <span class="nf">seed_from_geotiff_thickness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">filename</span><span class="p">,</span>
                                    <span class="n">number</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
                                    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Seed from files as provided by Prof. Chuanmin Hu&#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">ogr</span><span class="p">,</span> <span class="n">osr</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># get time from filename</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">28</span><span class="p">:</span><span class="o">-</span><span class="mi">13</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">.%H%M%S&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parsed time from filename: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">time</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not pase time from filename, &#39;</span>
                               <span class="s1">&#39;using present time: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">time</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">srcband</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">srcband</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

        <span class="n">thickness_microns</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">,</span> <span class="mf">4.4</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>  <span class="c1"># NB: approximate</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># categories</span>

        <span class="c1"># Make memory raster bands for each category</span>
        <span class="n">memrastername</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.mem&#39;</span>
        <span class="n">memdriver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;MEM&#39;</span><span class="p">)</span>
        <span class="n">mem_ds</span> <span class="o">=</span> <span class="n">memdriver</span><span class="o">.</span><span class="n">CreateCopy</span><span class="p">(</span><span class="n">memrastername</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">mem_ds</span><span class="o">.</span><span class="n">AddBand</span><span class="p">(</span><span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Byte</span><span class="p">)</span>
            <span class="n">mem_band</span> <span class="o">=</span> <span class="n">mem_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
            <span class="n">mem_band</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">cat</span><span class="p">)</span>

        <span class="c1"># Make memory polygons for each category</span>
        <span class="n">drv</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;MEMORY&#39;</span><span class="p">)</span>
        <span class="n">mem_vector_ds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
        <span class="n">mem_vector_layers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">memshapename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">.mem&#39;</span> <span class="o">%</span> <span class="n">cat</span>
            <span class="n">mem_vector_ds</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">drv</span><span class="o">.</span><span class="n">CreateDataSource</span><span class="p">(</span><span class="n">memshapename</span><span class="p">)</span>
            <span class="n">mem_vector_layers</span><span class="p">[</span><span class="n">cat</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">mem_vector_ds</span><span class="p">[</span><span class="n">cat</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span>
                    <span class="s1">&#39;thickness</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cat</span><span class="p">,</span> <span class="n">srs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">gdal</span><span class="o">.</span><span class="n">Polygonize</span><span class="p">(</span><span class="n">mem_ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">cat</span><span class="p">),</span>
                            <span class="kc">None</span><span class="p">,</span>
                            <span class="n">mem_vector_layers</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[],</span>
                            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">total_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">))</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>

        <span class="n">src_srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">src_srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">4269</span><span class="p">)</span>
        <span class="n">tgt_srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">tgt_srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">3857</span><span class="p">)</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">CoordinateTransformation</span><span class="p">(</span><span class="n">src_srs</span><span class="p">,</span> <span class="n">tgt_srs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">memshapename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">.shp&#39;</span> <span class="o">%</span> <span class="n">cat</span>
            <span class="n">layers</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem_vector_layers</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">GetFeatureCount</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">()</span>
                <span class="n">geom</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>  <span class="c1"># To get area in m2</span>
                <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()</span>
            <span class="c1"># Delete largest polygon, which is outer border</span>
            <span class="n">outer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">areas</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">areas</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">areas</span><span class="p">[</span><span class="n">outer</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_area</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span>
            <span class="n">layers</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">DeleteFeature</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
            <span class="n">layers</span><span class="p">[</span><span class="n">cat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ResetReading</span><span class="p">()</span>

        <span class="c1"># Calculate how many elements to be seeded for each category</span>
        <span class="n">areas_weighted</span> <span class="o">=</span> <span class="n">total_area</span> <span class="o">*</span> <span class="n">thickness_microns</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="n">number</span> <span class="o">*</span> <span class="n">areas_weighted</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areas_weighted</span><span class="p">)</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">oil_density</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">mass_oil</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_area</span> <span class="o">*</span> <span class="n">thickness_microns</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">*</span> <span class="n">oil_density</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed_from_shapefile</span><span class="p">([</span><span class="n">mem_vector_layers</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                     <span class="n">oil_film_thickness</span><span class="o">=</span><span class="n">thickness_microns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
                                     <span class="mf">1000000.</span><span class="p">,</span>
                                     <span class="n">mass_oil</span><span class="o">=</span><span class="n">mass_oil</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">num</span><span class="p">,</span>
                                     <span class="n">number</span><span class="o">=</span><span class="n">num</span><span class="p">,</span>
                                     <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                     <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenOil._substance_name">
<a class="viewcode-back" href="../../../../autoapi/opendrift/models/openoil/openoil/index.html#opendrift.models.openoil.OpenOil._substance_name">[docs]</a>
    <span class="k">def</span> <span class="nf">_substance_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_oil_name</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Knut-Frode Dagestad (knutfd@met.no) and Gaute Hope (gauteh@met.no)..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>