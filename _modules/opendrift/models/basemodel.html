<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>opendrift.models.basemodel &mdash; OpenDrift  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> OpenDrift
            <img src="../../../_static/opendrift_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction to OpenDrift</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../history_link.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installing OpenDrift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory/index.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../choosing_a_model.html">How to choose which model to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writing_a_new_model.html">How to write a new module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../oil_types.html">Oil types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../interaction_with_coastline.html">Interaction with coastline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker.html">Using OpenDrift in a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gui.html">Graphical User Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../services.html">Services using OpenDrift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OpenDrift</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../opendrift.html">opendrift</a> &raquo;</li>
      <li>opendrift.models.basemodel</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for opendrift.models.basemodel</h1><div class="highlight"><pre>
<span></span><span class="c1"># This file is part of OpenDrift.</span>
<span class="c1">#</span>
<span class="c1"># OpenDrift is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 2</span>
<span class="c1">#</span>
<span class="c1"># OpenDrift is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with OpenDrift.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1"># Copyright 2015, Knut-Frode Dagestad, MET Norway</span>
<span class="c1"># Copyright 2020, Gaute Hope, MET Norway</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span><span class="p">;</span> <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span><span class="p">,</span> <span class="n">abstractproperty</span>
<span class="kn">import</span> <span class="nn">geojson</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">nc_time_axis</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">date2num</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;legend.numpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;legend.scatterpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;DISPLAY&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span>
            <span class="s1">&#39;PYCHARM_HOSTED&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span>
            <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;nt&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No display found. Using non-interactive Agg backend&#39;</span><span class="p">)</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
    <span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="kn">import</span> <span class="nn">cartopy</span>
    <span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
    <span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;matplotlib and/or cartopy is not available, can not make plots&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">opendrift</span>
<span class="kn">from</span> <span class="nn">opendrift.timer</span> <span class="kn">import</span> <span class="n">Timeable</span>
<span class="kn">from</span> <span class="nn">opendrift.readers.basereader</span> <span class="kn">import</span> <span class="n">BaseReader</span><span class="p">,</span> <span class="n">vector_pairs_xy</span><span class="p">,</span> <span class="n">standard_names</span>
<span class="kn">from</span> <span class="nn">opendrift.readers</span> <span class="kn">import</span> <span class="n">reader_from_url</span><span class="p">,</span> <span class="n">reader_global_landmask</span>
<span class="kn">from</span> <span class="nn">opendrift.models.physics_methods</span> <span class="kn">import</span> <span class="n">PhysicsMethods</span>

<div class="viewcode-block" id="OpenDriftSimulation"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation">[docs]</a><span class="k">class</span> <span class="nc">OpenDriftSimulation</span><span class="p">(</span><span class="n">PhysicsMethods</span><span class="p">,</span> <span class="n">Timeable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generic trajectory model class, to be extended (subclassed).</span>

<span class="sd">    This as an Abstract Base Class, meaning that only subclasses can</span>
<span class="sd">    be initiated and used.</span>
<span class="sd">    Any specific subclass (&#39;model&#39;) must contain its own (or shared)</span>
<span class="sd">    specific type of particles (ElementType), whose properties are</span>
<span class="sd">    updated at each time_step using method update() on basis of model</span>
<span class="sd">    physics/chemistry/biology and &#39;required_variables&#39; (environment)</span>
<span class="sd">    which are provided by one or more Reader objects.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ElementType: the type (class) of particles to be used by this model</span>

<span class="sd">        elements: object of the class ElementType, storing the specific</span>
<span class="sd">        particle properties (ndarrays and scalars) of all active particles</span>
<span class="sd">        as named attributes. Elements are added by seeding-functions</span>
<span class="sd">        (presently only one implemented: seed_elements).</span>

<span class="sd">        elements_deactivated: ElementType object containing particles which</span>
<span class="sd">            have been deactivated (and removed from &#39;elements&#39;)</span>

<span class="sd">        elements_scheduled: ElementType object containing particles which</span>
<span class="sd">            have been scheduled, but not yet activated</span>
<span class="sd">        required_variables: list of strings of CF standard_names which is</span>
<span class="sd">            needed by this model (update function) to update properties of</span>
<span class="sd">            particles (&#39;elements&#39;) at each time_step. This core class has</span>
<span class="sd">            no required_elements, this is implemented by subclasses/modules.</span>
<span class="sd">        environment: recarray storing environment variables (wind, waves,</span>
<span class="sd">            current etc) as named attributes. Attribute names follow</span>
<span class="sd">            standard_name from CF-convention, allowing any OpenDriftSimulation</span>
<span class="sd">            module/subclass using environment data from any readers which</span>
<span class="sd">            can provide the requested variables. Used in method &#39;update&#39;</span>
<span class="sd">            to update properties of elements every time_step.</span>
<span class="sd">        time_step: timedelta object, time interval at which element properties</span>
<span class="sd">            are updated (including advection).</span>
<span class="sd">        time_step_output: timedelta object, time interval at which element</span>
<span class="sd">            properties are stored in memory and eventually written to file</span>
<span class="sd">        readers: Dictionary where values are Reader objects, and names are</span>
<span class="sd">            unique reference keywords used to access a given reader (typically</span>
<span class="sd">            filename or URL)</span>
<span class="sd">        priority_list: OrderedDict where names are variable names,</span>
<span class="sd">            and values are lists of names (kewywords) of the reader, in the</span>
<span class="sd">            order of priority (user defined) of which the readers shall be</span>
<span class="sd">            called to retrieve environmental data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="n">status_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span>  <span class="c1"># Particles are active by default</span>

    <span class="c1"># Default plotting colors of trajectory endpoints</span>
    <span class="n">status_colors_default</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;initial&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;missing_data&#39;</span><span class="p">:</span> <span class="s1">&#39;gray&#39;</span><span class="p">}</span>

    <span class="n">CONFIG_LEVEL_ESSENTIAL</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">CONFIG_LEVEL_BASIC</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">CONFIG_LEVEL_ADVANCED</span><span class="o">=</span><span class="mi">3</span>

    <span class="n">max_speed</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Assumed max average speed of any element</span>
    <span class="n">required_profiles_z_range</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># [min_depth, max_depth]</span>
    <span class="n">plot_comparison_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

    <span class="n">proj_latlon</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="s1">&#39;+proj=latlong&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="OpenDriftSimulation.SRS"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.SRS">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">SRS</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">proj_latlon</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">iomodule</span><span class="o">=</span><span class="s1">&#39;netcdf&#39;</span><span class="p">,</span>
                 <span class="n">loglevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logtime</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise OpenDriftSimulation</span>

<span class="sd">        Args:</span>
<span class="sd">            seed: integer or None. A given integer will yield identical</span>
<span class="sd">                random numbers drawn each simulation. Random numbers are</span>
<span class="sd">                e.g. used to distribute particles spatially when seeding,</span>
<span class="sd">                and may be used by modules (subclasses) for e.g. diffusion.</span>
<span class="sd">                Specifying a fixed value (default: 0) is useful for sensitivity</span>
<span class="sd">                tests. With seed = None, different random numbers will be drawn</span>
<span class="sd">                for subsequent runs, even with identical configuration/input.</span>
<span class="sd">            iomodule: name of module used to export data</span>
<span class="sd">                default: netcdf, see :py:mod:`opendrift.io` for more alternatives.</span>
<span class="sd">                `iomodule` is module/filename without preceeding `io_`</span>
<span class="sd">            loglevel: set to 0 (default) to retrieve all debug information.</span>
<span class="sd">                Provide a higher value (e.g. 20) to receive less output.</span>
<span class="sd">                Use the string &#39;custom&#39; to configure logging from outside.</span>
<span class="sd">            logtime: if True, a time stamp is given for each logging line.</span>
<span class="sd">                     logtime can also be given as a python time specifier</span>
<span class="sd">                     (e.g. &#39;%H:%M:%S&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_continuous_performance</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">origin_marker</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Dictionary to store named seeding locations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minvals</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionaries to store minimum and maximum values of variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxvals</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># List to store GeoJSON dicts of seeding commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_geojson</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Dict to store readers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readers</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># Dictionary, key=name, value=reader object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># Make copies of dictionaries so that they are private to each instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span>  <span class="c1"># Particles are active by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_colors_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors_default</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;status_colors&#39;</span><span class="p">):</span>
            <span class="c1"># Append model specific colors to (and override) default colors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_colors_default</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors_default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors_default</span>

        <span class="c1"># Using a fixed seed will generate the same random numbers</span>
        <span class="c1"># each run, useful for sensitivity tests</span>
        <span class="c1"># Use seed = None to get different random numbers each time</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Increase for each simulation step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="p">()</span>  <span class="c1"># Empty array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="p">()</span>  <span class="c1"># Empty array</span>

        <span class="k">if</span> <span class="n">loglevel</span> <span class="o">!=</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(levelname)-7s</span><span class="s1"> </span><span class="si">%(name)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
            <span class="n">datefmt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">logtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="nb">format</span>
                <span class="k">if</span> <span class="n">logtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">datefmt</span> <span class="o">=</span> <span class="n">logtime</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="n">datefmt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">loglevel</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># 0 is NOTSET, giving no output</span>
                <span class="n">loglevel</span><span class="o">=</span><span class="mi">10</span>

            <span class="n">od_loggers</span> <span class="o">=</span> <span class="p">[</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;opendrift&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;opendrift_landmask_data&#39;</span><span class="p">)</span> <span class="p">]</span>

            <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">od_loggers</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">loglevel</span><span class="p">)</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">coloredlogs</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">coloredlogs</span><span class="o">.</span><span class="n">DEFAULT_FIELD_STYLES</span>
                <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;levelname&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;magenta&#39;</span>

                <span class="c1"># coloredlogs does not create duplicate handlers</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">od_loggers</span><span class="p">:</span>
                    <span class="n">coloredlogs</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">loglevel</span><span class="p">,</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">l</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nb">format</span><span class="p">,</span> <span class="n">datefmt</span> <span class="o">=</span> <span class="n">datefmt</span><span class="p">,</span> <span class="n">field_styles</span> <span class="o">=</span> <span class="n">fields</span><span class="p">)</span>

        <span class="c1"># Prepare outfile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">io_module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;opendrift.export.io_&#39;</span> <span class="o">+</span> <span class="n">iomodule</span><span class="p">,</span>
                                   <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;write_buffer&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;import_file&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not import iomodule &#39;</span> <span class="o">+</span> <span class="n">iomodule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_init</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">io_module</span><span class="o">.</span><span class="n">init</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_write_buffer</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">io_module</span><span class="o">.</span><span class="n">write_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_close</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">io_module</span><span class="o">.</span><span class="n">close</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_import_file</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">io_module</span><span class="o">.</span><span class="n">import_file</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_import_file_xarray</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">io_module</span><span class="o">.</span><span class="n">import_file_xarray</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Set configuration options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_config</span><span class="p">({</span>
            <span class="c1"># type, default, min, max, enum, important, value, units, description</span>
            <span class="s1">&#39;general:use_auto_landmask&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;A built-in GSHHG global landmask is used if True, &#39;</span>
                 <span class="s1">&#39;otherwise landmask is taken from reader or fallback value.&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;general:coastline_action&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;stranding&#39;</span><span class="p">,</span> <span class="s1">&#39;previous&#39;</span><span class="p">],</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;stranding&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_BASIC</span><span class="p">,</span>
                 <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;None means that objects may also move over land. &#39;</span>
                    <span class="s1">&#39;stranding means that objects are deactivated if they hit land. &#39;</span>
                    <span class="s1">&#39;previous means that objects will move back to the previous location &#39;</span>
                    <span class="s1">&#39;if they hit land&#39;</span><span class="p">},</span>
            <span class="s1">&#39;general:time_step_minutes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">.01</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">1440</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_BASIC</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Calculation time step used for the simulation. The output time step may &#39;</span>
                <span class="s1">&#39;be equal or larger than this.&#39;</span><span class="p">},</span>
            <span class="s1">&#39;general:time_step_output_minutes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">1440</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_BASIC</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Output time step, i.e. the interval at which output is saved. This must be larger than &#39;</span>
                <span class="s1">&#39;the calculation time step, and be an integer multiple of this.&#39;</span><span class="p">},</span>
            <span class="s1">&#39;seed:ocean_only&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;If True, elements seeded on land will be moved to the closest &#39;</span>
                    <span class="s1">&#39;position in ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;seed:number&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">100000000</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;The number of elements for the simulation.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_BASIC</span><span class="p">},</span>
            <span class="s1">&#39;drift:max_age_seconds&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;seconds&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Elements will be deactivated when this age is reached&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:advection_scheme&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;euler&#39;</span><span class="p">,</span> <span class="s1">&#39;runge-kutta&#39;</span><span class="p">,</span> <span class="s1">&#39;runge-kutta4&#39;</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;euler&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">:</span>
                <span class="s1">&#39;Numerical advection scheme for ocean current advection&#39;</span><span class="p">},</span>
            <span class="s1">&#39;drift:current_uncertainty&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m/s&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Add gaussian perturbation with this standard deviation to current components at each time step&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:current_uncertainty_uniform&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m/s&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Add gaussian perturbation with this standard deviation to current components at each time step&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:horizontal_diffusivity&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m2/s&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Add horizontal diffusivity (random walk)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:wind_uncertainty&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;m/s&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Add gaussian perturbation with this standard deviation to wind components at each time step.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:relative_wind&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;If True, wind drift is calculated for absolute wind (wind vector minus ocean surface current vector).&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:deactivate_north_of&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;degrees&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Elements are deactivated if the move further north than this limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:deactivate_south_of&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;degrees&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Elements are deactivated if the move further south than this limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:deactivate_east_of&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">360</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;degrees&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Elements are deactivated if the move further east than this limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
            <span class="s1">&#39;drift:deactivate_west_of&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">360</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;degrees&#39;</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Elements are deactivated if the move further west than this limit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">},</span>
        <span class="p">})</span>

        <span class="c1"># Add default element properties to config</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;seed&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Properties which may not be provided by user</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;seed:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="s1">&#39;Seeding value of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ADVANCED</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_config</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c1"># Add constant and fallback environment variables to config</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">:</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">description_constant</span> <span class="o">=</span> <span class="s1">&#39;Use constant value for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span>
            <span class="n">description_fallback</span> <span class="o">=</span> <span class="s1">&#39;Fallback value for </span><span class="si">%s</span><span class="s1"> if not available from any reader&#39;</span> <span class="o">%</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">standard_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;valid_min&#39;</span> <span class="ow">in</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
                    <span class="n">minval</span> <span class="o">=</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;valid_min&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;valid_max&#39;</span> <span class="ow">in</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
                    <span class="n">maxval</span> <span class="o">=</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;valid_max&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;long_name&#39;</span> <span class="ow">in</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
                    <span class="n">description_constant</span> <span class="o">=</span> <span class="n">description_fallback</span> <span class="o">=</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">]:</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="n">standard_names</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;environment:constant:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">minval</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">maxval</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">OpenDriftSimulation</span><span class="o">.</span><span class="n">CONFIG_LEVEL_BASIC</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description_constant</span><span class="p">}</span>
            <span class="n">c</span><span class="p">[</span><span class="s1">&#39;environment:fallback:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">minval</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">maxval</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;fallback&#39;</span><span class="p">]</span> <span class="k">if</span>
                    <span class="s1">&#39;fallback&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">OpenDriftSimulation</span><span class="o">.</span><span class="n">CONFIG_LEVEL_BASIC</span><span class="p">,</span>
                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description_fallback</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_config</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c1"># Find variables which require profiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_profiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span>
            <span class="k">if</span> <span class="s1">&#39;profiles&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;profiles&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span>

        <span class="c1"># Find variables which are desired, but not required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desired_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span>
            <span class="k">if</span> <span class="s1">&#39;important&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;important&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;total time&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;configuration&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;opendrift_version&#39;</span><span class="p">,</span> <span class="n">opendrift</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;OpenDriftSimulation initialised (version </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                     <span class="n">opendrift</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version_or_git</span><span class="p">())</span>

        <span class="c1"># Check if dependencies are outdated</span>
        <span class="kn">import</span> <span class="nn">importlib</span>
        <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;cmocean&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">82</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Dependencies are outdated, please update with: conda env update -f environment.yml&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">*</span><span class="mi">82</span><span class="p">)</span>

<div class="viewcode-block" id="OpenDriftSimulation.list_config"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.list_config">[docs]</a>    <span class="k">def</span> <span class="nf">list_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all possible configuration settings with values&quot;&quot;&quot;</span>
        <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">=============================================</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="nb">str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="nb">str</span> <span class="o">+=</span> <span class="s1">&#39;=============================================</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.list_configspec"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.list_configspec">[docs]</a>    <span class="k">def</span> <span class="nf">list_configspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Readable formatting of config specification&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;value&#39;</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
                    <span class="n">rang</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]:</span>
                    <span class="n">rang</span> <span class="o">=</span> <span class="s1">&#39;min: </span><span class="si">%s</span><span class="s1">, max: </span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;enum&#39;</span><span class="p">:</span>
                    <span class="n">rang</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;enum&#39;</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%-35s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">] </span><span class="si">%-5s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">rang</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">20</span><span class="p">]))</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_configspec"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_configspec">[docs]</a>    <span class="k">def</span> <span class="nf">get_configspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="n">level</span><span class="p">]</span>
        <span class="n">configspec</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">level</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">configspec</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._add_config"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._add_config">[docs]</a>    <span class="k">def</span> <span class="nf">_add_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add configuration settings</span>

<span class="sd">        config is a dictionary where keys are configuration keywords,</span>
<span class="sd">        and values are dictionaries with the following contents:</span>

<span class="sd">        type (string): &#39;float&#39;, &#39;int&#39;, &#39;bool&#39; or &#39;enum&#39;</span>

<span class="sd">        min, max (float/int/None): (only when type is &#39;float&#39; or &#39;int&#39;)</span>
<span class="sd">            The minimum and maximum allowed values for this setting.</span>
<span class="sd">            May also be None if there are no upper/lowe limits.</span>

<span class="sd">        units (string): (only when type is &#39;float&#39; or &#39;int&#39;)</span>
<span class="sd">            The units of this config setting.</span>

<span class="sd">        enum (list): (only when type is &#39;enum&#39;)</span>
<span class="sd">            A list of possible values for this setting.</span>

<span class="sd">        default (number/bool/string/None):</span>
<span class="sd">            The default value for this setting.</span>

<span class="sd">        value (number/bool/string/None): The actual value for this setting.</span>
<span class="sd">            This is updated with self.set_config(key, value) and retrieved</span>
<span class="sd">            with self.get_config(key)</span>

<span class="sd">        description (string):</span>
<span class="sd">            A description of this config setting, for users/documentation/GUIs.</span>

<span class="sd">        level (int): A parameter to determine the level of exposure in GUIs</span>
<span class="sd">            1 self.CONFIG_LEVEL_ESSENTIAL: important setting which user has to consider</span>
<span class="sd">            2 self.CONFIG_LEVEL_BASIC: setting which many users may consider</span>
<span class="sd">            3 self.CONFIG_LEVEL_ADVANCED: setting relevant only to advanced users</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">caller</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">%i</span><span class="s1"> config items from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">),</span> <span class="n">caller</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_config&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># Check that provided config is conistent</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  Config item </span><span class="si">%s</span><span class="s1"> is already specified, not overwriting&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
                    <span class="n">remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  Overwriting config item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; must be specified for config item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFIG_LEVEL_ESSENTIAL</span> <span class="ow">and</span> <span class="s1">&#39;default&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span><span class="c1">#or i[&#39;default&#39;] is None:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A default value must be provided for config item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;enum&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;enum&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;enum&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;enum&quot; of type list must be provided for config item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; not provided for config item </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># no check for bool</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Config type &quot;</span><span class="si">%s</span><span class="s1">&quot; (</span><span class="si">%s</span><span class="s1">) is not defined. Valid options are: &#39;</span>
                                 <span class="s1">&#39;float, int, enum, bool&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">i</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">config</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.set_config"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.set_config">[docs]</a>    <span class="k">def</span> <span class="nf">set_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_config</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No config setting named </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Config value </span><span class="si">%s</span><span class="s1"> must be True or False&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Config value </span><span class="si">%s</span><span class="s1"> must be between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;enum&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;enum&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;enum&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">difflib</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;enum&#39;</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
                    <span class="n">containing</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;enum&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">e</span><span class="p">]</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">containing</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">matches</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                        <span class="n">suggestion</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Did you mean any of these?</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">suggestion</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wrong configuration, possible values are:</span><span class="se">\n\t</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;enum&#39;</span><span class="p">],</span> <span class="n">suggestion</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._set_config_default"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._set_config_default">[docs]</a>    <span class="k">def</span> <span class="nf">_set_config_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update both default and actual value of a config setting&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_config"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No config setting named </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.add_metadata"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add item to metadata dictionary, for export as netCDF global attributes&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;metadata_dict&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.prepare_run"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.prepare_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>  <span class="c1"># to be overloaded when needed</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.store_present_positions"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.store_present_positions">[docs]</a>    <span class="k">def</span> <span class="nf">store_present_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IDs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store present element positions, in case they shall be moved back&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:coastline_action&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;previous&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;general:seafloor_action&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:seafloor_action&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;previous&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;previous_lon&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">previous_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">IDs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newly_seeded_IDs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># to check if seeded on land</span>
                <span class="k">if</span> <span class="nb">len</span> <span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">newly_seeded_IDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">newly_seeded_IDs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_lon</span><span class="p">[</span><span class="n">IDs</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previous_lat</span><span class="p">[</span><span class="n">IDs</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.store_previous_variables"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.store_previous_variables">[docs]</a>    <span class="k">def</span> <span class="nf">store_previous_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store some environment variables, for access at next time step&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;store_previous&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;variables_previous&#39;</span><span class="p">):</span>
            <span class="c1"># Create ndarray to store previous variables</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_previous</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables_previous</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Copying variables_previous to environment_previous</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment_previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables_previous</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Use new values for new elements which have no previous value</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_previous</span><span class="p">:</span>
            <span class="n">undefined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment_previous</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment_previous</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">undefined</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="n">undefined</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">environment_previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_previous</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_previous</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables_previous</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.interact_with_coastline"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.interact_with_coastline">[docs]</a>    <span class="k">def</span> <span class="nf">interact_with_coastline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Coastline interaction according to configuration setting&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:coastline_action&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="s1">&#39;land_binary_mask&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>  <span class="c1"># Do nothing</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Get land_binary_mask for final location</span>
            <span class="n">en</span><span class="p">,</span> <span class="n">en_prof</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_environment</span><span class="p">([</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                                     <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">land_binary_mask</span> <span class="o">=</span> <span class="n">en</span><span class="o">.</span><span class="n">land_binary_mask</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;stranding&#39;</span><span class="p">:</span>  <span class="c1"># Deactivate elements on land</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">land_binary_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;stranded&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;previous&#39;</span><span class="p">:</span>  <span class="c1"># Go back to previous position (in water)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">newly_seeded_IDs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">land_binary_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()),</span>
                    <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;seeded_on_land&#39;</span><span class="p">)</span>
            <span class="n">on_land</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">land_binary_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_land</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No elements hit coastline.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> elements hit coastline, &#39;</span>
                              <span class="s1">&#39;moving back to water&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">on_land</span><span class="p">))</span>
                <span class="n">on_land_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">on_land</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">on_land</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_lon</span><span class="p">[</span><span class="n">on_land_ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">on_land</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_lat</span><span class="p">[</span><span class="n">on_land_ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">land_binary_mask</span><span class="p">[</span><span class="n">on_land</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.interact_with_seafloor"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.interact_with_seafloor">[docs]</a>    <span class="k">def</span> <span class="nf">interact_with_seafloor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seafloor interaction according to configuration setting&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sea_floor_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sea_floor_depth</span><span class="p">()</span>
        <span class="n">below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">sea_floor_depth</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">below</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No elements hit seafloor.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:seafloor_action&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;lift_to_seafloor&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Lifting </span><span class="si">%s</span><span class="s1"> elements to seafloor.&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">below</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">below</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sea_floor_depth</span><span class="p">[</span><span class="n">below</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;deactivate&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">sea_floor_depth</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;seafloor&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;previous&#39;</span><span class="p">:</span>  <span class="c1"># Go back to previous position (in water)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> elements hit seafloor, &#39;</span>
                           <span class="s1">&#39;moving back &#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">below</span><span class="p">))</span>
            <span class="n">below_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">below</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">below</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_lon</span><span class="p">[</span><span class="n">below_ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">below</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_lat</span><span class="p">[</span><span class="n">below_ID</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="OpenDriftSimulation.update"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.update">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Any trajectory model implementation must define an update method.</span>
<span class="sd">        This method must/can use environment data (self.environment) to</span>
<span class="sd">        update properties (including position) of its particles (self.elements)</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">ElementType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Any trajectory model implementation must define an ElementType.&quot;&quot;&quot;</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">required_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Any trajectory model implementation must list needed variables.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OpenDriftSimulation.test_data_folder"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.test_data_folder">[docs]</a>    <span class="k">def</span> <span class="nf">test_data_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">opendrift</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">opendrift</span><span class="o">.</span><span class="vm">__file__</span><span class="p">),</span>
                         <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="s1">&#39;test_data&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.performance"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.performance">[docs]</a>    <span class="k">def</span> <span class="nf">performance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Report the time spent on various tasks&#39;&#39;&#39;</span>

        <span class="n">outStr</span> <span class="o">=</span> <span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;Reader performance:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">is_lazy</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="n">r</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="n">reader</span><span class="o">.</span><span class="n">performance</span><span class="p">()</span>

        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;Performance:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">timestr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timestr</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s1">&#39;123456789.&#39;</span><span class="p">:</span>
                    <span class="n">timestr</span> <span class="o">=</span> <span class="n">timestr</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>  <span class="c1"># Strip leading 0 and :</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                        <span class="n">timestr</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="n">timestr</span>
                    <span class="k">break</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">category</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39;  &#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">category</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;colon&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s%7s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">timestr</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>

        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">outStr</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.add_reader"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.add_reader">[docs]</a>    <span class="k">def</span> <span class="nf">add_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readers</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one or more readers providing variables used by this model.</span>

<span class="sd">        Method may be called subsequently to add more readers</span>
<span class="sd">        for other variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            readers: one or more (list) Reader objects.</span>

<span class="sd">            variables (optional): list of strings of standard_name of variables to be provided by this/these reader(s).</span>
<span class="sd">            first: Set to True if this reader should be set as first option</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert any strings to lists, for looping</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">variables</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">readers</span><span class="p">,</span> <span class="n">BaseReader</span><span class="p">):</span>
            <span class="n">readers</span> <span class="o">=</span> <span class="p">[</span><span class="n">readers</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="n">readers</span><span class="p">:</span>
            <span class="c1"># Check if input class is of correct type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">BaseReader</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="s1">&#39;_lazyname&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide Reader object&#39;</span><span class="p">)</span>

            <span class="c1"># Check that reader class contains the requested variables</span>
            <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missingVariables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">missingVariables</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Reader </span><span class="si">%s</span><span class="s1"> does not provide variables: </span><span class="si">%s</span><span class="s1">&#39;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">missingVariables</span><span class="p">)))</span>

            <span class="c1"># Finally add new reader to list</span>
            <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
                <span class="c1"># Reader names must be unique, adding integer</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">99999</span><span class="p">):</span>
                    <span class="n">tmp_name</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span>
                    <span class="k">if</span> <span class="n">tmp_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
                        <span class="n">reader</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">tmp_name</span>
                        <span class="k">break</span>

            <span class="c1"># Horizontal buffer of reader must be large enough to cover</span>
            <span class="c1"># the distance possibly covered by elements within a time step</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reader</span><span class="o">.</span><span class="n">is_lazy</span><span class="p">:</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">set_buffer_size</span><span class="p">(</span><span class="n">max_speed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reader</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Added reader &#39;</span> <span class="o">+</span> <span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Add this reader for each of the given variables</span>
            <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">is_lazy</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">variables</span> <span class="k">else</span> <span class="n">reader</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">variable</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">first</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># Remove/hide variables not needed by the current trajectory model</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.add_readers_from_list"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.add_readers_from_list">[docs]</a>    <span class="k">def</span> <span class="nf">add_readers_from_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Make readers from a list of URLs or paths to netCDF datasets&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">urls</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lazy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">opendrift.readers.reader_lazy</span> <span class="kn">import</span> <span class="n">Reader</span>
            <span class="n">readers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Reader</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_reader</span><span class="p">(</span><span class="n">readers</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">readers</span> <span class="o">=</span> <span class="p">[</span><span class="n">reader_from_url</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_reader</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">readers</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.add_readers_from_file"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.add_readers_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_readers_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sources</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_readers_from_list</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.list_environment_variables"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.list_environment_variables">[docs]</a>    <span class="k">def</span> <span class="nf">list_environment_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of all variables provided by the added readers.&quot;&quot;&quot;</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">reader</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variables</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.missing_variables"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.missing_variables">[docs]</a>    <span class="k">def</span> <span class="nf">missing_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of all variables for which no reader has been added.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_reader_groups"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_reader_groups">[docs]</a>    <span class="k">def</span> <span class="nf">get_reader_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find which groups of variables are provided by the same readers.</span>

<span class="sd">        This function loops through &#39;priority_list&#39; (see above) and groups</span>
<span class="sd">        all variables returned by the same readers in the same order. This</span>
<span class="sd">        allows asking readers for several variables simultaneously,</span>
<span class="sd">        improving performance. Used by method &#39;get_environment&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            variable_groups: list of lists of (environment) variables.</span>
<span class="sd">            reader_groups: list of list of reader names, corresponding to</span>
<span class="sd">            each of the variable_groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">variables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">)</span>
        <span class="n">reader_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Find all unique reader groups</span>
        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">readers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">readers</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reader_groups</span><span class="p">):</span>
                <span class="n">reader_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">readers</span><span class="p">)</span>
        <span class="c1"># Find all variables returned by the same reader group</span>
        <span class="n">variable_groups</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">reader_groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">readers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">readerGroup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader_groups</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">readers</span> <span class="o">==</span> <span class="n">readerGroup</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">variable_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">variable_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">variable_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="p">]</span>

        <span class="n">missing_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="o">-</span>
                                 <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">variable_groups</span><span class="p">,</span> <span class="n">reader_groups</span><span class="p">,</span> <span class="n">missing_variables</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._lazy_readers"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._lazy_readers">[docs]</a>    <span class="k">def</span> <span class="nf">_lazy_readers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">is_lazy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._unlazy_readers"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._unlazy_readers">[docs]</a>    <span class="k">def</span> <span class="nf">_unlazy_readers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">is_lazy</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._initialise_next_lazy_reader"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._initialise_next_lazy_reader">[docs]</a>    <span class="k">def</span> <span class="nf">_initialise_next_lazy_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns reader if successful and None if no more readers&#39;&#39;&#39;</span>

        <span class="n">lazy_readers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lazy_readers</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lazy_readers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">lazyname</span> <span class="o">=</span> <span class="n">lazy_readers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">lazyname</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Reader could not be initialised, and is&#39;</span>
                            <span class="s1">&#39; discarded: &#39;</span> <span class="o">+</span> <span class="n">lazyname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discard_reader</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_next_lazy_reader</span><span class="p">()</span>  <span class="c1"># Call self</span>

        <span class="n">reader</span><span class="o">.</span><span class="n">set_buffer_size</span><span class="p">(</span><span class="n">max_speed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">)</span>
        <span class="c1"># Update reader lazy name with actual name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lazyname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># Remove variables not needed</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">reader</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.earliest_time"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.earliest_time">[docs]</a>    <span class="k">def</span> <span class="nf">earliest_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_end_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.latest_time"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.latest_time">[docs]</a>    <span class="k">def</span> <span class="nf">latest_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_end_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.discard_reader_if_not_relevant"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.discard_reader_if_not_relevant">[docs]</a>    <span class="k">def</span> <span class="nf">discard_reader_if_not_relevant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;expected_endtime&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">reader</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_time</span><span class="p">()</span> <span class="ow">or</span>
                 <span class="n">reader</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">earliest_time</span><span class="p">())):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Reader does not cover simulation period&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discard_reader</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">)</span> <span class="o">&amp;</span>
               <span class="nb">set</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">variables</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Reader does not contain any relevant variables&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discard_reader</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.discard_reader"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.discard_reader">[docs]</a>    <span class="k">def</span> <span class="nf">discard_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">):</span>
        <span class="n">readername</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Discarding reader: &#39;</span> <span class="o">+</span> <span class="n">readername</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">readername</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;discarded_readers&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discarded_readers</span> <span class="o">=</span> <span class="p">[</span><span class="n">readername</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discarded_readers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">readername</span><span class="p">)</span>

        <span class="c1"># Remove from priority list</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">readername</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.discard_irrelevant_readers"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.discard_irrelevant_readers">[docs]</a>    <span class="k">def</span> <span class="nf">discard_irrelevant_readers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">readername</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">readername</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">is_lazy</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discard_reader_if_not_relevant</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DISCARDED: &#39;</span> <span class="o">+</span> <span class="n">readername</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_environment"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_environment">[docs]</a>    <span class="k">def</span> <span class="nf">get_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">profiles</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Retrieve environmental variables at requested positions.</span>

<span class="sd">        Updates:</span>
<span class="sd">            Buffer (raw data blocks) for each reader stored for performance:</span>
<span class="sd">                [readers].var_block_before (last before requested time)</span>
<span class="sd">                [readers].var_block_after (first after requested time)</span>
<span class="sd">                - lists of one ReaderBlock per variable group: time, x, y, [vars]</span>

<span class="sd">        Returns:</span>
<span class="sd">            environment: recarray with variables as named attributes,</span>
<span class="sd">                         interpolated to requested positions/time.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;main loop:readers&#39;</span><span class="p">)</span>
        <span class="c1"># Initialise ndarray to hold environment variables</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fallback_values&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_fallback_values</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Discard any existing readers which are not relevant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discard_irrelevant_readers</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;drift:truncate_ocean_model_below_m&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="n">truncate_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:truncate_ocean_model_below_m&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">truncate_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Truncating ocean models below </span><span class="si">%s</span><span class="s1"> m&#39;</span> <span class="o">%</span> <span class="n">truncate_depth</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">z</span><span class="p">[</span><span class="n">z</span><span class="o">&lt;-</span><span class="n">truncate_depth</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">truncate_depth</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_profiles_z_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">required_profiles_z_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">required_profiles_z_range</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">required_profiles_z_range</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">required_profiles_z_range</span><span class="o">&lt;-</span><span class="n">truncate_depth</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">truncate_depth</span>

        <span class="c1"># Initialise more lazy readers if necessary</span>
        <span class="n">missing_variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;missingvar&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
               <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lazy_readers</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">variable_groups</span><span class="p">,</span> <span class="n">reader_groups</span><span class="p">,</span> <span class="n">missing_variables</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_reader_groups</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;desired_variables&#39;</span><span class="p">):</span>
                <span class="n">missing_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">)</span> <span class="o">-</span>
                                         <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">desired_variables</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Variables not covered by any reader: &#39;</span> <span class="o">+</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">))</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="s1">&#39;NotNone&#39;</span>
                <span class="k">while</span> <span class="n">reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_next_lazy_reader</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discard_reader_if_not_relevant</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">covers_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="ow">and</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">covers_positions</span><span class="p">(</span>
                                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">missing_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="nb">set</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">)</span> <span class="o">-</span>
                                <span class="nb">set</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">variables</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">break</span>  <span class="c1"># We cover now all variables</span>

        <span class="c1"># For each variable/reader group:</span>
        <span class="n">variable_groups</span><span class="p">,</span> <span class="n">reader_groups</span><span class="p">,</span> <span class="n">missing_variables</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_reader_groups</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>  <span class="c1"># Fill with fallback value if no reader</span>
            <span class="n">co</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;environment:fallback:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">variable</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">env</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">co</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variable_group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variable_groups</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Variable group </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">variable_group</span><span class="p">)))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----------------------------------------&#39;</span><span class="p">)</span>
            <span class="n">reader_group</span> <span class="o">=</span> <span class="n">reader_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">missing_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)))</span>
            <span class="c1"># For each reader:</span>
            <span class="k">for</span> <span class="n">reader_name</span> <span class="ow">in</span> <span class="n">reader_group</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calling reader &#39;</span> <span class="o">+</span> <span class="n">reader_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;----------------------------------------&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;main loop:readers:&#39;</span> <span class="o">+</span>
                                 <span class="n">reader_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;colon&gt;&#39;</span><span class="p">))</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">reader_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">is_lazy</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Reader is lazy, should not happen&#39;</span><span class="p">)</span>
                    <span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Should not happen&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reader</span><span class="o">.</span><span class="n">covers_time</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Outside time coverage of reader.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">reader_name</span> <span class="o">==</span> <span class="n">reader_group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_next_lazy_reader</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Missing variables: calling get_environment recursively&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span>
                                        <span class="n">time</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">profiles</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Fetch given variables at given positions from current reader</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Data needed for </span><span class="si">%i</span><span class="s1"> elements&#39;</span> <span class="o">%</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">))</span>
                    <span class="c1"># Check if vertical profiles are requested from reader</span>
                    <span class="k">if</span> <span class="n">profiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">profiles_from_reader</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">variable_group</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">profiles</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">profiles_from_reader</span> <span class="o">==</span> <span class="p">[]:</span>
                            <span class="n">profiles_from_reader</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">profiles_from_reader</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">env_tmp</span><span class="p">,</span> <span class="n">env_profiles_tmp</span> <span class="o">=</span> \
                        <span class="n">reader</span><span class="o">.</span><span class="n">get_variables_interpolated</span><span class="p">(</span>
                            <span class="n">variable_group</span><span class="p">,</span> <span class="n">profiles_from_reader</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">required_profiles_z_range</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span>
                            <span class="n">lon</span><span class="p">[</span><span class="n">missing_indices</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="n">missing_indices</span><span class="p">],</span>
                            <span class="n">z</span><span class="p">[</span><span class="n">missing_indices</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_latlon</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;========================&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Exception:&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;========================&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;main loop:readers:&#39;</span> <span class="o">+</span>
                                   <span class="n">reader_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;colon&gt;&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">reader_name</span> <span class="o">==</span> <span class="n">reader_group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_next_lazy_reader</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Missing variables: calling get_environment recursively&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span>
                                        <span class="n">time</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">profiles</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Copy retrieved variables to env array, and mask nan-values</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable_group</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not returning env-variable: &#39;</span> <span class="o">+</span> <span class="n">var</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># Skipping variables that are only used to derive needed variables</span>
                    <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">missing_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span>
                        <span class="n">env_tmp</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">profiles_from_reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">profiles_from_reader</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;env_profiles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                            <span class="n">env_profiles</span> <span class="o">=</span> <span class="n">env_profiles_tmp</span>
                        <span class="c1"># TODO: fix to be checked</span>
                        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">env_profiles</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">env_profiles_tmp</span><span class="p">:</span>
                            <span class="c1"># If one profile has fewer vertical layers than</span>
                            <span class="c1"># the other, we use only the overlapping part</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span>
                                <span class="n">env_profiles_tmp</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Warning: different number of &#39;</span>
                                    <span class="s1">&#39; vertical layers: </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]),</span>
                                        <span class="nb">len</span><span class="p">(</span> <span class="n">env_profiles_tmp</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])))</span>
                            <span class="n">z_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">env_profiles_tmp</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="c1"># len(missing_indices) since 2 points might have been added and not removed</span>
                            <span class="n">env_profiles_tmp</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">env_profiles_tmp</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                            <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">z_ind</span><span class="p">,</span> <span class="n">missing_indices</span><span class="p">)]</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">env_profiles_tmp</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">z_ind</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
                            <span class="c1"># For profiles with different numbers of layers, we extrapolate</span>
                            <span class="k">if</span> <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">missingbottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>
                                <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">missingbottom</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">missingbottom</span><span class="p">]</span>

                <span class="c1"># Detect elements with missing data, for present reader group</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env_tmp</span><span class="p">[</span><span class="n">variable_group</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;mask&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">combined_mask</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable_group</span><span class="p">:</span>
                        <span class="n">tmp_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">env_tmp</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                        <span class="c1"># Changed 13 Oct 2016, but uncertain of effect</span>
                        <span class="c1"># TODO: to be checked</span>
                        <span class="c1">#tmp_var = env_tmp[var]</span>
                        <span class="k">if</span> <span class="s1">&#39;combined_mask&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">combined_mask</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">,</span>
                                              <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmask</span><span class="p">(</span><span class="n">tmp_var</span><span class="p">),</span>
                                              <span class="n">shrink</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">):</span>
                            <span class="c1"># TODO: mask mismatch due to 2 added points</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Mismatch of masks&#39;</span><span class="p">)</span>
                        <span class="n">missing_indices</span> <span class="o">=</span> <span class="n">missing_indices</span><span class="p">[</span><span class="n">combined_mask</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># Not sure what is happening here</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Problems setting mask on missing_indices!&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">missing_indices</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># temporary workaround</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">):</span>
                    <span class="n">missing_indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;main loop:readers:&#39;</span> <span class="o">+</span>
                               <span class="n">reader_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;colon&gt;&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Obtained data for all elements.&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Data missing for </span><span class="si">%i</span><span class="s1"> elements.&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_indices</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lazy_readers</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_next_lazy_reader</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Missing variables: calling get_environment recursively&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span>
                                <span class="n">time</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">profiles</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;---------------------------------------&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finished processing all variable groups&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;main loop:readers:postprocessing&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">profiles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profiles</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">mask</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Using fallback value </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> elements&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">==</span><span class="kc">True</span><span class="p">)))</span>
                <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="c1"># Profiles</span>
            <span class="k">if</span> <span class="n">profiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">profiles</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;env_profiles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating empty dictionary for profiles not &#39;</span>
                                  <span class="s1">&#39;profided by any reader: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_profiles</span><span class="p">))</span>
                    <span class="n">env_profiles</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_profiles_z_range</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env_profiles</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;      Using fallback value </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> for all profiles&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">var</span><span class="p">))</span>
                    <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">*</span>\
                        <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>
                    <span class="n">num_masked_values_per_element</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">num_missing_profiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num_masked_values_per_element</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]))</span>
                    <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;      Using fallback value </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> profiles&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">num_missing_profiles</span><span class="p">,))</span>
                    <span class="n">num_missing_individual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num_masked_values_per_element</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_missing_profiles</span>
                    <span class="k">if</span> <span class="n">num_missing_individual</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;        ...plus </span><span class="si">%s</span><span class="s1"> individual points in other profiles&#39;</span> <span class="o">%</span>
                                      <span class="n">num_missing_individual</span><span class="p">)</span>

        <span class="c1">#######################################################</span>
        <span class="c1"># Some extra checks of units and realistic magnitude</span>
        <span class="c1">#######################################################</span>
        <span class="k">if</span> <span class="s1">&#39;sea_water_temperature&#39;</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">t_kelvin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_kelvin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Converting temperatures from Kelvin to Celcius&#39;</span><span class="p">)</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">][</span><span class="n">t_kelvin</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">][</span><span class="n">t_kelvin</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="k">if</span> <span class="s1">&#39;env_profiles&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;sea_water_temperature&#39;</span> <span class="ow">in</span> <span class="n">env_profiles</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                  <span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">][:,</span><span class="n">t_kelvin</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">env_profiles</span><span class="p">[</span><span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">][:,</span><span class="n">t_kelvin</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>

        <span class="c1">#######################################################</span>
        <span class="c1"># Parameterisation of unavailable variables</span>
        <span class="c1">#######################################################</span>
        <span class="k">if</span> <span class="s1">&#39;drift:use_tabularised_stokes_drift&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:use_tabularised_stokes_drift&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;x_wind&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No wind available to calculate Stokes drift&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sea_surface_wave_stokes_drift_x_velocity&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_surface_wave_stokes_drift_x_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
                    <span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_surface_wave_stokes_drift_y_velocity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculating parameterised stokes drift&#39;</span><span class="p">)</span>
                        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_surface_wave_stokes_drift_x_velocity&#39;</span><span class="p">],</span> \
                        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_surface_wave_stokes_drift_y_velocity&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">wave_stokes_drift_parameterised</span><span class="p">((</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;x_wind&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;y_wind&#39;</span><span class="p">]),</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:tabularised_stokes_drift_fetch&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_surface_wave_significant_height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculating parameterised significant wave height&#39;</span><span class="p">)</span>
                        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_surface_wave_significant_height&#39;</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">wave_significant_height_parameterised</span><span class="p">((</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;x_wind&#39;</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;y_wind&#39;</span><span class="p">]),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:tabularised_stokes_drift_fetch&#39;</span><span class="p">))</span>

        <span class="c1">#############################</span>
        <span class="c1"># Add uncertainty/diffusion</span>
        <span class="c1">#############################</span>
        <span class="c1"># Current</span>
        <span class="k">if</span> <span class="s1">&#39;x_sea_water_velocity&#39;</span> <span class="ow">in</span> <span class="n">variables</span> <span class="ow">and</span> \
                <span class="s1">&#39;y_sea_water_velocity&#39;</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:current_uncertainty&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding uncertainty for current: </span><span class="si">%s</span><span class="s1"> m/s&#39;</span> <span class="o">%</span> <span class="n">std</span><span class="p">)</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;x_sea_water_velocity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;y_sea_water_velocity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
            <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:current_uncertainty_uniform&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding uncertainty for current: </span><span class="si">%s</span><span class="s1"> m/s&#39;</span> <span class="o">%</span> <span class="n">std</span><span class="p">)</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;x_sea_water_velocity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">std</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;y_sea_water_velocity&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                    <span class="o">-</span><span class="n">std</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
        <span class="c1"># Wind</span>
        <span class="k">if</span> <span class="s1">&#39;x_wind&#39;</span> <span class="ow">in</span> <span class="n">variables</span> <span class="ow">and</span> <span class="s1">&#39;y_wind&#39;</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:wind_uncertainty&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">std</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding uncertainty for wind: </span><span class="si">%s</span><span class="s1"> m/s&#39;</span> <span class="o">%</span> <span class="n">std</span><span class="p">)</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;x_wind&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
                <span class="n">env</span><span class="p">[</span><span class="s1">&#39;y_wind&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>

        <span class="c1">#####################</span>
        <span class="c1"># Diagnostic output</span>
        <span class="c1">#####################</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;------------ SUMMARY -------------&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">%s</span><span class="s1">: </span><span class="si">%g</span><span class="s1"> (min) </span><span class="si">%g</span><span class="s1"> (max)&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;---------------------------------&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="s1"> active elements&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lonmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">lonmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">latmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">latmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">zmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">latmin</span> <span class="o">==</span> <span class="n">latmax</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">latitude =  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">latmin</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="s1"> &lt;- latitude  -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">latmin</span><span class="p">,</span> <span class="n">latmax</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">lonmin</span> <span class="o">==</span> <span class="n">lonmax</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">longitude = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lonmin</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="s1"> &lt;- longitude -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lonmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">zmin</span> <span class="o">==</span> <span class="n">zmax</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">z = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zmin</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">%s</span><span class="s1">   &lt;- z -&gt;   </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;---------------------------------&#39;</span><span class="p">)</span>

        <span class="c1"># Prepare array indiciating which elements contain any invalid values</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mask_or</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span>
                                    <span class="n">shrink</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Convert dictionary to recarray and return</span>
        <span class="k">if</span> <span class="s1">&#39;env_profiles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">env_profiles</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Convert masked arrays to regular arrays for increased performance</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_profiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">env_profiles</span><span class="p">:</span>
                <span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">env_profiles</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;main loop:readers:postprocessing&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;main loop:readers&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">),</span> <span class="n">env_profiles</span><span class="p">,</span> <span class="n">missing</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.num_elements_active"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.num_elements_active">[docs]</a>    <span class="k">def</span> <span class="nf">num_elements_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of active elements.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;elements&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.num_elements_deactivated"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.num_elements_deactivated">[docs]</a>    <span class="k">def</span> <span class="nf">num_elements_deactivated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number of deactivated elements.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;elements_deactivated&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.num_elements_scheduled"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.num_elements_scheduled">[docs]</a>    <span class="k">def</span> <span class="nf">num_elements_scheduled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;elements_scheduled&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.num_elements_total"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.num_elements_total">[docs]</a>    <span class="k">def</span> <span class="nf">num_elements_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The total number of scheduled, active and deactivated elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_activated</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.num_elements_activated"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.num_elements_activated">[docs]</a>    <span class="k">def</span> <span class="nf">num_elements_activated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The total number of active and deactivated elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_deactivated</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.schedule_elements"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.schedule_elements">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Schedule elements to be seeded during runtime.</span>

<span class="sd">        Also assigns a unique ID to each particle, monotonically increasing.&quot;&quot;&quot;</span>

        <span class="c1"># prepare time</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;elements_scheduled&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span> <span class="o">=</span> <span class="n">elements</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="c1"># We start simulation at time of release of first element:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">))</span>  <span class="c1"># Increase ID successively</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>

        <span class="n">min_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">min_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">min_time</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting simulation start time to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">min_time</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">min_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting simulation start time to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="nb">str</span><span class="p">(</span><span class="n">min_time</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.release_elements"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.release_elements">[docs]</a>    <span class="k">def</span> <span class="nf">release_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Activate elements which are scheduled within following timestep.&quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;to be seeded: </span><span class="si">%s</span><span class="s1">, already seeded </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_activated</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&amp;</span> \
                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span> <span class="o">&lt;</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&amp;</span> \
                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span> <span class="o">&gt;</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_present_positions</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">ID</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">move_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span><span class="p">[</span><span class="o">~</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Released </span><span class="si">%i</span><span class="s1"> new elements.&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.closest_ocean_points"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.closest_ocean_points">[docs]</a>    <span class="k">def</span> <span class="nf">closest_ocean_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the closest ocean points for given lon, lat&quot;&quot;&quot;</span>

        <span class="n">deltalon</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># grid</span>
        <span class="n">deltalat</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">numbuffer</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">lonmin</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltalon</span><span class="o">*</span><span class="n">numbuffer</span>
        <span class="n">lonmax</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltalon</span><span class="o">*</span><span class="n">numbuffer</span>
        <span class="n">latmin</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltalat</span><span class="o">*</span><span class="n">numbuffer</span>
        <span class="n">latmax</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltalat</span><span class="o">*</span><span class="n">numbuffer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;land_binary_mask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No land reader added, &#39;</span>
                         <span class="s1">&#39;making a temporary landmask reader&#39;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">opendrift.models.oceandrift</span> <span class="kn">import</span> <span class="n">OceanDrift</span>
            <span class="n">reader_landmask</span> <span class="o">=</span> <span class="n">reader_global_landmask</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span>
                    <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltalon</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="mi">89</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltalat</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">720</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltalon</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">89</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltalat</span><span class="p">)</span>
                        <span class="p">])</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">OceanDrift</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">)</span>
            <span class="n">o</span><span class="o">.</span><span class="n">add_reader</span><span class="p">(</span><span class="n">reader_landmask</span><span class="p">)</span>
            <span class="n">land_reader</span> <span class="o">=</span> <span class="n">reader_landmask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using existing reader for land_binary_mask&#39;</span><span class="p">)</span>
            <span class="n">land_reader_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">land_reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">land_reader_name</span><span class="p">]</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">land</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get_environment</span><span class="p">([</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">],</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">land_reader</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">land</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All points are in ocean&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Moving </span><span class="si">%i</span><span class="s1"> out of </span><span class="si">%i</span><span class="s1"> points from land to water&#39;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">land</span><span class="o">!=</span><span class="mi">0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)))</span>
        <span class="n">landlons</span> <span class="o">=</span> <span class="n">lon</span><span class="p">[</span><span class="n">land</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">landlats</span> <span class="o">=</span> <span class="n">lat</span><span class="p">[</span><span class="n">land</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">longrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lonmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">,</span> <span class="n">deltalon</span><span class="p">)</span>
        <span class="n">latgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">latmin</span><span class="p">,</span> <span class="n">latmax</span><span class="p">,</span> <span class="n">deltalat</span><span class="p">)</span>
        <span class="n">longrid</span><span class="p">,</span> <span class="n">latgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">longrid</span><span class="p">,</span> <span class="n">latgrid</span><span class="p">)</span>
        <span class="n">longrid</span> <span class="o">=</span> <span class="n">longrid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">latgrid</span> <span class="o">=</span> <span class="n">latgrid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="c1"># Remove grid-points not covered by this reader</span>
        <span class="n">latgrid_covered</span> <span class="o">=</span> <span class="n">land_reader</span><span class="o">.</span><span class="n">covers_positions</span><span class="p">(</span><span class="n">longrid</span><span class="p">,</span> <span class="n">latgrid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">longrid</span> <span class="o">=</span> <span class="n">longrid</span><span class="p">[</span><span class="n">latgrid_covered</span><span class="p">]</span>
        <span class="n">latgrid</span> <span class="o">=</span> <span class="n">latgrid</span><span class="p">[</span><span class="n">latgrid_covered</span><span class="p">]</span>
        <span class="n">landgrid</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">],</span> <span class="n">lon</span><span class="o">=</span><span class="n">longrid</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">latgrid</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">longrid</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">land_reader</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">landgrid</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">landgrid</span><span class="o">.</span><span class="n">min</span><span class="p">()):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No ocean pixels nearby, cannot move elements.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>

        <span class="n">oceangridlons</span> <span class="o">=</span> <span class="n">longrid</span><span class="p">[</span><span class="n">landgrid</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">oceangridlats</span> <span class="o">=</span> <span class="n">latgrid</span><span class="p">[</span><span class="n">landgrid</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">oceangridlons</span><span class="p">,</span> <span class="n">oceangridlats</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">landpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">landlons</span><span class="p">,</span> <span class="n">landlats</span><span class="p">])</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">landpoints</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lon</span><span class="p">[</span><span class="n">land</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">oceangridlons</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">lat</span><span class="p">[</span><span class="n">land</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">oceangridlats</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_elements"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_elements">[docs]</a>    <span class="k">def</span> <span class="nf">seed_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">radius_type</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seed elements with given position(s), time and properties.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            lon: scalar or array</span>
<span class="sd">                central longitude(s).</span>
<span class="sd">            lat: scalar or array</span>
<span class="sd">                central latitude(s).</span>
<span class="sd">            radius: scalar or array</span>
<span class="sd">                radius in meters around each lon-lat pair,</span>
<span class="sd">                within which particles will be randomly seeded.</span>
<span class="sd">            number: integer, total number of particles to be seeded</span>
<span class="sd">                If number is None, the number of elements is the</span>
<span class="sd">                length of lon/lat or time if these are arrays. Otherwise</span>
<span class="sd">                the number of elements are obtained from the config-default.</span>
<span class="sd">            time: datenum or list</span>
<span class="sd">                The time at which particles are seeded/released.</span>
<span class="sd">                If time is a list with two elements, elements are seeded</span>
<span class="sd">                continously from start/first to end/last time.</span>
<span class="sd">                If time is a list with more than two elements, the number of elements</span>
<span class="sd">                is equal to len(time) and are seeded as a time series.</span>
<span class="sd">            radius_type: string</span>
<span class="sd">                If &#39;gaussian&#39; (default), the radius is the standard deviation in</span>
<span class="sd">                x-y-directions. If &#39;uniform&#39;, elements are spread evenly and</span>
<span class="sd">                always inside a circle with the given radius.</span>
<span class="sd">            kwargs:</span>
<span class="sd">                keyword arguments containing properties/attributes and</span>
<span class="sd">                values corresponding to the actual particle type (ElementType).</span>
<span class="sd">                These are forwarded to the ElementType class. All properties</span>
<span class="sd">                for which there are no default value must be specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;cone&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Keyword *cone* for seed_elements is deprecated, use seed_cone() instead.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">origin_marker</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;origin_marker&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">origin_marker</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;origin_marker&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origin_marker</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin_marker</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;origin_marker_name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">origin_marker_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;origin_marker_name&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;origin_marker_name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origin_marker_name</span> <span class="o">=</span> <span class="s1">&#39;Seed </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin_marker</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;origin_marker&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;origin_marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin_marker</span>
        <span class="k">if</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">origin_marker_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Underscore (_) not allowed in origin_marker_name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_marker</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">origin_marker</span><span class="p">)]</span> <span class="o">=</span> <span class="n">origin_marker_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">90</span> <span class="ow">or</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Latitude must be between -90 and 90 degrees&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lon and lat must have same lengths&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">number</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lon and lat have length </span><span class="si">%s</span><span class="s1">, but number is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">number</span><span class="p">))</span>
            <span class="n">number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>  <span class="c1"># Interpreting as time series</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:number&#39;</span><span class="p">)</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">!=</span> <span class="n">number</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># start -&gt; end</span>
                <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">number</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># timestep between points</span>
                <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">td</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Time array has length </span><span class="si">%s</span><span class="s1">, must be 1, 2 or </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">number</span><span class="p">))</span>

        <span class="c1"># Add radius / perturbation</span>
        <span class="k">if</span> <span class="n">radius</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>
            <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">radius_type</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">*</span><span class="n">radius</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">*</span><span class="n">radius</span>
                <span class="n">az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">radius_type</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
                <span class="n">az</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">*</span><span class="mi">360</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)))</span><span class="o">*</span><span class="n">radius</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># If z is &#39;seafloor&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;seed:seafloor&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:seafloor&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;seafloor&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Seafloor is selected, neglecting z&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;seafloor&#39;</span><span class="p">:</span>
            <span class="c1"># We need to fetch seafloor depth from reader</span>
            <span class="n">seafloor_constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;environment:constant:sea_floor_depth_below_sea_level&#39;</span><span class="p">)</span>
            <span class="n">seafloor_fallback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;environment:fallback:sea_floor_depth_below_sea_level&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seafloor_constant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seafloor_constant</span><span class="p">)}</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span>
                        <span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lazy_readers</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">env</span><span class="p">,</span> <span class="n">env_profiles</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_environment</span><span class="p">([</span><span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span><span class="p">],</span>
                                         <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                                         <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">lon</span><span class="p">,</span> <span class="n">profiles</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">seafloor_fallback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seafloor_fallback</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A reader providing the variable &#39;</span>
                                 <span class="s1">&#39;sea_floor_depth_below_sea_level must be &#39;</span>
                                 <span class="s1">&#39;added before seeding elements at seafloor.&#39;</span><span class="p">)</span>
            <span class="c1"># Add M meters if given as &#39;seafloor+M&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">meters_above_seafloor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">9</span><span class="p">::])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Seeding elements </span><span class="si">%f</span><span class="s1"> meters above seafloor&#39;</span>
                             <span class="o">%</span> <span class="n">meters_above_seafloor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meters_above_seafloor</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="o">-</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;sea_floor_depth_below_sea_level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">meters_above_seafloor</span>

        <span class="c1"># Creating and scheduling elements</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">time_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_elements</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_cone"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_cone">[docs]</a>    <span class="k">def</span> <span class="nf">seed_cone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seed elements along a transect/cone between two points/times</span>

<span class="sd">        Arguments:</span>
<span class="sd">            lon: scalar or list with 2 elements [lon0, lon1]</span>

<span class="sd">            lat: scalar or list with 2 elements [lat0, lat]</span>

<span class="sd">            time: datetime or list with 2 elements [t0, t1]</span>

<span class="sd">            radius: scalar or list with 2 elements [r0, r1] Unit: meters</span>

<span class="sd">            number (int): The number of elements. If this is None, the number of</span>
<span class="sd">            elements is taken from configuration.</span>

<span class="sd">        Elements are seeded along a transect from</span>
<span class="sd">            (lon0, lat0) with uncertainty radius r0 at time t0, towards</span>
<span class="sd">            (lon1, lat1) with uncertainty radius r1 at time t1.</span>
<span class="sd">            If r0 != r1, the unceetainty radius is linearly changed along</span>
<span class="sd">            the transect, thus outlining a &quot;cone&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:number&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;For a cone, the number of elements must be at least 2 or more, given is 1&#39;</span><span class="p">)</span>

        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lon and lat must have same length (1 or 2)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lon and lat must have length 1 or 2, given length is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Segment from lon0,lat1 to lon1,lat2</span>
            <span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>
            <span class="n">lonin</span> <span class="o">=</span> <span class="n">lon</span>
            <span class="n">latin</span> <span class="o">=</span> <span class="n">lat</span>
            <span class="c1"># Note that npts places points in-between start and end, and does not include these</span>
            <span class="n">conelonlats</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">npts</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">number</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">conelonlats</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Seed radius must have length 1 or 2&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Linear increase from r0 to r1</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">number</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
            <span class="n">timespan</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timespan</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span><span class="p">]</span>

        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">lonin</span> <span class="o">=</span> <span class="n">lonin</span> <span class="k">if</span> <span class="s1">&#39;lonin&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="p">[</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
        <span class="n">latin</span> <span class="o">=</span> <span class="n">latin</span> <span class="k">if</span> <span class="s1">&#39;latin&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="p">[</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed_cone_arguments</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">lonin</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">latin</span><span class="p">,</span>
                <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">timespan</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="n">number</span><span class="p">}</span>

        <span class="c1"># Make GeoJson seeding dict to be saved in netCDF metadata</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="n">geojson</span><span class="o">.</span><span class="n">LineString</span><span class="p">([(</span><span class="nb">float</span><span class="p">(</span><span class="n">lonin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">latin</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                                  <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lonin</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">latin</span><span class="p">[</span><span class="mi">1</span><span class="p">]))])</span>
        <span class="n">seed_defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_configspec</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">)</span>
        <span class="n">default_seed</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span><span class="n">seed_defaults</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">seed_defaults</span><span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;seafloor&#39;</span> <span class="ow">in</span> <span class="n">default_seed</span> <span class="ow">and</span> <span class="n">default_seed</span><span class="p">[</span><span class="s1">&#39;seafloor&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">default_seed</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;seafloor&#39;</span>
        <span class="n">default_seed</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_seed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>  <span class="c1"># Overwrite with explicitly provided values</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">default_seed</span><span class="p">,</span>
                      <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">timespan</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">timespan</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                      <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span>
                      <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="n">number</span><span class="p">}</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">geojson</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">geo</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_geojson</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Forwarding calculated cone points/radii to seed_elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_from_geojson"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_from_geojson">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_geojson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gjson</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Under development&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gj</span> <span class="o">=</span> <span class="n">geojson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">gjson</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not load GeoJSON string: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gjson</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gj</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;GeoJSON string is not valid: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">gj</span><span class="o">.</span><span class="n">errors</span><span class="p">())</span>
        <span class="c1"># Assuming temporally that g is a Feature, and not a FeatureCollection</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="n">gj</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Property &quot;time&quot; is not available&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">)),</span>
                            <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>

        <span class="n">geometry</span> <span class="o">=</span> <span class="n">gj</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Polygon&#39;</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geojson</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">gj</span><span class="p">))</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed_within_polygon</span><span class="p">(</span><span class="n">lons</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LineString&#39;</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geojson</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">gj</span><span class="p">))</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed_cone</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">geometry</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Point&#39;</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geojson</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">coords</span><span class="p">(</span><span class="n">gj</span><span class="p">))</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not yet implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_repeated_segment"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_repeated_segment">[docs]</a>    <span class="k">def</span> <span class="nf">seed_repeated_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                              <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">time_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">number_per_segment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">total_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seed elements repeatedly in time along a segment.</span>

<span class="sd">        The segment goes from lon[0],lat[0] to lon[1],lat[1].</span>

<span class="sd">        The number of elements should be proved as either:</span>

<span class="sd">        1) number_per_segment, in which case total number of elements is number_per_segment * len(times), or</span>

<span class="sd">        2) total_number, in which case the number of elements per segment is: total_number / len(times).</span>
<span class="sd">           Any extra elements are duplicated along at the first segment.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">numtimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span>
                        <span class="n">time_interval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_time</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">time_interval</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numtimes</span><span class="p">)]</span>

        <span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">number_per_segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">number_per_segment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">total_number</span><span class="o">/</span><span class="n">numtimes</span><span class="p">))</span>

        <span class="n">s_lonlats</span><span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">npts</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">number_per_segment</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">slon</span><span class="p">,</span> <span class="n">slat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">s_lonlats</span><span class="p">))</span>
        <span class="n">slon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">slon</span><span class="p">)</span>
        <span class="n">slat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">slat</span><span class="p">)</span>

        <span class="n">lon</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">slon</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">slat</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">total_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_elements</span> <span class="o">=</span> <span class="n">total_number</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Repeating the </span><span class="si">%d</span><span class="s1"> last points, to obtain </span><span class="si">%d</span><span class="s1"> elements&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">additional_elements</span><span class="p">,</span> <span class="n">total_number</span><span class="p">))</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lon</span><span class="p">,</span> <span class="n">lon</span><span class="p">[</span><span class="o">-</span><span class="n">additional_elements</span><span class="p">::]))</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lat</span><span class="p">,</span> <span class="n">lat</span><span class="p">[</span><span class="o">-</span><span class="n">additional_elements</span><span class="p">::]))</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">time</span><span class="p">,</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="n">additional_elements</span><span class="p">::]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_within_polygon"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_within_polygon">[docs]</a>    <span class="k">def</span> <span class="nf">seed_within_polygon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seed a number of elements within given polygon.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            lon: array of longitudes</span>

<span class="sd">            lat: array of latitudes</span>

<span class="sd">            number: int, number of elements to be seeded</span>

<span class="sd">            kwargs: keyword arguments containing properties/attributes and</span>
<span class="sd">            values corresponding to the actual particle type (ElementType).</span>
<span class="sd">            These are forwarded to method seed_elements(). All properties</span>
<span class="sd">            for which there are no default value must be specified.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:number&#39;</span><span class="p">)</span>

        <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;At least three points needed to make a polygon&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;lon and lat arrays must have same length.&#39;</span><span class="p">)</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">)),</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Place N points within the polygons</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="s1">&#39;+proj=aea +lat_1=</span><span class="si">%f</span><span class="s1"> +lat_2=</span><span class="si">%f</span><span class="s1"> +lat_0=</span><span class="si">%f</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;+lon_0=</span><span class="si">%f</span><span class="s1"> +R=6370997.0 +units=m +ellps=WGS84&#39;</span>
                           <span class="o">%</span> <span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                              <span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="n">lats</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                              <span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">+</span><span class="n">lons</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">lonlat</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">area</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">area</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">area</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Make points, evenly distributed</span>
        <span class="n">deltax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">area</span><span class="o">/</span><span class="n">number</span><span class="p">)</span>
        <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">latpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">lonlat</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_xy</span><span class="p">()</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lonlat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="n">xvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                           <span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">deltax</span><span class="p">))</span>
        <span class="n">yvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltax</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                           <span class="nb">int</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">deltax</span><span class="p">))</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xvec</span><span class="p">,</span> <span class="n">yvec</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>  <span class="c1"># No elements are inside, we seed on border</span>
            <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lonpoints</span><span class="p">,</span> <span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">number</span><span class="p">])</span>
            <span class="n">latpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latpoints</span><span class="p">,</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">number</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lonpoints</span><span class="p">,</span> <span class="n">lon</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
            <span class="n">latpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latpoints</span><span class="p">,</span> <span class="n">lat</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Small or irregular polygon, using center point.&#39;</span><span class="p">)</span>
            <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lons</span><span class="p">))</span>
            <span class="n">latpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span>
        <span class="c1"># Truncate if too many</span>
        <span class="c1"># NB: should also repeat some points, if too few</span>
        <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">lonpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">number</span><span class="p">]</span>
        <span class="n">latpoints</span> <span class="o">=</span> <span class="n">latpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">number</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lonpoints</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">number</span><span class="p">:</span>
            <span class="c1"># If number of positions is smaller than requested,</span>
            <span class="c1"># we duplicate the first ones</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">number</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">lonpoints</span><span class="p">)</span>
            <span class="n">lonpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lonpoints</span><span class="p">,</span> <span class="n">lonpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">missing</span><span class="p">])</span>
            <span class="n">latpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latpoints</span><span class="p">,</span> <span class="n">latpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">missing</span><span class="p">])</span>

        <span class="c1"># Finally seed at calculated positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="n">lonpoints</span><span class="p">,</span> <span class="n">latpoints</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_from_wkt"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_from_wkt">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_wkt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wkt</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seeds elements within (multi)polygons from WKT&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">ogr</span><span class="p">,</span> <span class="n">osr</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;OGR library is needed to parse WKT&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:number&#39;</span><span class="p">)</span>

        <span class="n">geom</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">CreateGeometryFromWkt</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
        <span class="n">total_area</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">GetGeometryCount</span><span class="p">()):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">total_area</span> <span class="o">+=</span> <span class="n">g</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Total area of all polygons: </span><span class="si">%s</span><span class="s1"> m2&#39;</span> <span class="o">%</span> <span class="n">total_area</span><span class="p">)</span>
        <span class="n">num_seeded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">geom</span><span class="o">.</span><span class="n">GetGeometryCount</span><span class="p">()):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">num_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="o">*</span><span class="n">g</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()</span><span class="o">/</span><span class="n">total_area</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">geom</span><span class="o">.</span><span class="n">GetGeometryCount</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># For the last feature we seed the remaining number,</span>
                <span class="c1"># avoiding difference due to rounding:</span>
                <span class="n">num_elements</span> <span class="o">=</span> <span class="n">number</span> <span class="o">-</span> <span class="n">num_seeded</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Seeding </span><span class="si">%s</span><span class="s1"> elements within polygon number </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">num_elements</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">coordTrans</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">GetBoundary</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Alternative if OGR is not built with GEOS support</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">GetX</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">GetPointCount</span><span class="p">())]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">GetY</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">GetPointCount</span><span class="p">())]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">seed_within_polygon</span><span class="p">(</span><span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">num_elements</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">num_seeded</span> <span class="o">+=</span> <span class="n">num_elements</span></div>


<div class="viewcode-block" id="OpenDriftSimulation.seed_from_shapefile"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_from_shapefile">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_shapefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapefile</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span>
                            <span class="n">layername</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">featurenum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seeds elements within contours read from a shapefile&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">ogr</span><span class="p">,</span> <span class="n">osr</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;OGR library is needed to read shapefiles.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;timeformat&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># Recondstructing time from filename, where &#39;timeformat&#39;</span>
            <span class="c1"># is forwarded to datetime.strptime()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">shapefile</span><span class="p">),</span>
                                               <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeformat&#39;</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeformat&#39;</span><span class="p">]</span>

        <span class="n">num_seeded_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span>

        <span class="n">targetSRS</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">targetSRS</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">shapefile</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">shapefile</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layername</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span> <span class="o">!=</span> <span class="n">layername</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping layer: &#39;</span> <span class="o">+</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetName</span><span class="p">())</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Seeding for layer: </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1"> features)&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">(),</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetFeatureCount</span><span class="p">()))</span>

            <span class="n">coordTrans</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">CoordinateTransformation</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetSpatialRef</span><span class="p">(),</span>
                                                      <span class="n">targetSRS</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">featurenum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">featurenum</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetFeatureCount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">featurenum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">featurenum</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">featurenum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetFeatureCount</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only </span><span class="si">%s</span><span class="s1"> features in layer.&#39;</span> <span class="o">%</span>
                                 <span class="n">layer</span><span class="o">.</span><span class="n">GetFeatureCount</span><span class="p">())</span>

            <span class="c1"># Loop first through all features to determine total area</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">ResetReading</span><span class="p">()</span>
            <span class="n">area_srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">area_srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">3857</span><span class="p">)</span>
            <span class="n">areaTransform</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">CoordinateTransformation</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetSpatialRef</span><span class="p">(),</span> <span class="n">area_srs</span><span class="p">)</span>

            <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">featurenum</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">featurenum</span><span class="p">):</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetFeature</span><span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Note 1-indexing, not 0</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">gom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">()</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
                    <span class="n">gom</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">areaTransform</span><span class="p">)</span>
                    <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gom</span><span class="o">.</span><span class="n">GetArea</span><span class="p">()</span>

            <span class="n">total_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">ResetReading</span><span class="p">()</span>  <span class="c1"># Rewind to first layer</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Total area of all polygons: </span><span class="si">%s</span><span class="s1"> m2&#39;</span> <span class="o">%</span> <span class="n">total_area</span><span class="p">)</span>
            <span class="c1"># Find number of points per polygon</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">number</span><span class="o">*</span><span class="n">areas</span><span class="o">/</span><span class="n">total_area</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">numbers</span><span class="p">[</span><span class="n">numbers</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">featurenum</span><span class="p">):</span>
                <span class="n">feature</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetFeature</span><span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">num_elements</span> <span class="o">=</span> <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Seeding </span><span class="si">%s</span><span class="s1"> elements within polygon number </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">num_elements</span><span class="p">,</span> <span class="n">featurenum</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">geom</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">coordTrans</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not transform coordinates:&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">pass</span>
                <span class="c1">#b = geom.GetBoundary()</span>
                <span class="c1">#if b is not None:</span>
                <span class="c1">#    points = b.GetPoints()</span>
                <span class="c1">#    lons = [p[0] for p in points]</span>
                <span class="c1">#    lats = [p[1] for p in points]</span>
                <span class="c1">#else:</span>
                <span class="c1"># Alternative if OGR is not built with GEOS support</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">GetGeometryRef</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">GetY</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">GetPointCount</span><span class="p">())]</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">GetX</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">GetPointCount</span><span class="p">())]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">seed_within_polygon</span><span class="p">(</span><span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">num_elements</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_letters"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_letters">[docs]</a>    <span class="k">def</span> <span class="nf">seed_letters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seed elements within text polygons&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matplotlib.font_manager</span> <span class="kn">import</span> <span class="n">FontProperties</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">FontProperties</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s1">&#39;Bitstream Vera Sans&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">pol</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">textpath</span><span class="o">.</span><span class="n">TextPath</span><span class="p">((</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">pol</span><span class="o">.</span><span class="n">_vertices</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">])</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">PathPatch</span><span class="p">(</span>
                <span class="n">pol</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">po</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span><span class="o">.</span><span class="n">to_polygons</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">po</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed_within_polygon</span><span class="p">(</span><span class="n">lons</span><span class="o">=</span><span class="n">p</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">lats</span><span class="o">=</span><span class="n">p</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.seed_from_ladim"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.seed_from_ladim">[docs]</a>    <span class="k">def</span> <span class="nf">seed_from_ladim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ladimfile</span><span class="p">,</span> <span class="n">roms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Seed elements from ladim \\*.rls text file: [time, x, y, z, name]&quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">ladimfile</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">),</span>
                   <span class="s1">&#39;formats&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;S20&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">)},</span>
            <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">roms</span><span class="o">.</span><span class="n">xy2lonlat</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Seeding </span><span class="si">%i</span><span class="s1"> elements from </span><span class="si">%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">ladimfile</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    Lons: </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    Lats: </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    Depths: </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    Time: </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">z</span><span class="o">=-</span><span class="n">z</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_elements</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenDriftSimulation.horizontal_diffusion"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.horizontal_diffusion">[docs]</a>    <span class="k">def</span> <span class="nf">horizontal_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move elements with random walk according to given horizontal diffuivity.&quot;&quot;&quot;</span>
        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:horizontal_diffusivity&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Horizontal diffusivity is 0, no random walk.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="n">x_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">moving</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
        <span class="n">y_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">moving</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">D</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
        <span class="n">speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_vel</span><span class="o">*</span><span class="n">x_vel</span><span class="o">+</span><span class="n">y_vel</span><span class="o">*</span><span class="n">y_vel</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Moving elements according to horizontal diffusivity of </span><span class="si">%s</span><span class="s1">, with speeds between </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1"> m/s&#39;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">speed</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">speed</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_positions</span><span class="p">(</span><span class="n">x_vel</span><span class="p">,</span> <span class="n">y_vel</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.deactivate_elements"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.deactivate_elements">[docs]</a>    <span class="k">def</span> <span class="nf">deactivate_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;deactivated&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Schedule deactivated particles for deletion (at end of step)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Added status </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reason</span><span class="p">))</span>
        <span class="n">reason_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
        <span class="c1">#if not hasattr(self.elements.status, &quot;__len__&quot;):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="c1"># Deactivate elements, if they have not already been deactivated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">indices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> \
            <span class="n">reason_number</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> elements scheduled for deactivation (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">reason</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">(z: </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1">)&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.remove_deactivated_elements"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.remove_deactivated_elements">[docs]</a>    <span class="k">def</span> <span class="nf">remove_deactivated_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Moving deactivated elements from self.elements</span>
<span class="sd">        to self.elements_deactivated.&quot;&quot;&quot;</span>

        <span class="c1"># All particles scheduled for deletion</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">#try:</span>
        <span class="c1">#    len(indices)</span>
        <span class="c1">#except:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No elements to deactivate&#39;</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># No elements scheduled for deactivation</span>
        <span class="c1"># Basic, but some more housekeeping will be required later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">move_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%i</span><span class="s1"> elements.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="o">~</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%i</span><span class="s1"> values from environment.&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;environment_profiles&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">environment_profiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">profiles</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_profiles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;remove items from profile for &#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="o">!=</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">environment_profiles</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">profiles</span><span class="p">[:,</span> <span class="o">~</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">%i</span><span class="s1"> values from environment_profiles.&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span></div>
            <span class="c1">#if self.num_elements_active() == 0:</span>
            <span class="c1">#    raise ValueError(&#39;No more active elements.&#39;)  # End simulation</span>

<div class="viewcode-block" id="OpenDriftSimulation.set_fallback_values"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.set_fallback_values">[docs]</a>    <span class="k">def</span> <span class="nf">set_fallback_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fallback_values&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">refresh</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Manually editing fallback_values dict is deprecated, please use set_config()&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_configspec</span><span class="p">(</span><span class="s1">&#39;environment:fallback:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.run"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_step_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">export_buffer_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start a trajectory simulation, after initial configuration.</span>

<span class="sd">        Performs the main loop:</span>
<span class="sd">            - Obtain environment data for positions of all particles.</span>
<span class="sd">            - Call method &#39;update&#39; to update (incl advect) particle properties.</span>
<span class="sd">        until one of the following conditions are met:</span>
<span class="sd">            - Maximum number of steps are reached</span>
<span class="sd">            - A needed variable can not be obtained by any reader</span>
<span class="sd">                (outside spatial/temporal domain) and has no fallback</span>
<span class="sd">                (default) value.</span>
<span class="sd">            - All particles have been deactivated (e.g. by stranding)</span>
<span class="sd">            - Occurance of any error, whose trace will be output to terminal.</span>

<span class="sd">        Before starting a model run, readers must be added for all</span>
<span class="sd">        required variables, unless fallback values have been specified.</span>
<span class="sd">        Some particles/elements must have been scheduled for seeding, and the</span>
<span class="sd">        run will start at the time when the first element has been scheduled..</span>

<span class="sd">        Arguments:</span>
<span class="sd">            time_step: interval between particles updates, in seconds or as</span>
<span class="sd">                timedelta. Default: 3600 seconds (1 hour)</span>
<span class="sd">            time_step_output: Time step at which element properties are stored</span>
<span class="sd">                and eventually written to file.</span>
<span class="sd">                Timedelta object or seconds.</span>
<span class="sd">                Default: same as time_step, meaning that all steps are stored</span>
<span class="sd">            The length of the simulation is specified by defining one</span>
<span class="sd">                (and only one) of the following parameters:</span>
<span class="sd">                - steps: integer, maximum number of steps. End of simulation</span>
<span class="sd">                will be self.start_time + steps*self.time_step</span>
<span class="sd">                - duration: timedelta defining the length of the simulation</span>
<span class="sd">                - end_time: datetime object defining the end of the simulation</span>
<span class="sd">            export_variables: list of variables and parameter names to be</span>
<span class="sd">                saved to file. Default is None (all variables are saved)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Exporting software and hardware specification, for possible debugging</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">opendrift</span><span class="o">.</span><span class="n">versions</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;configuration&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;preparing main loop&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please seed elements before starting a run.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="p">()</span>

        <span class="c1"># Export seed_geojson as FeatureCollection string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;seed_geojson&#39;</span><span class="p">,</span> <span class="n">geojson</span><span class="o">.</span><span class="n">FeatureCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed_geojson</span><span class="p">))</span>

        <span class="c1"># Collect fallback values from config into dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_fallback_values</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">export_buffer_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No output file is specified, &#39;</span>
                          <span class="s1">&#39;neglecting export_buffer_length&#39;</span><span class="p">)</span>
            <span class="n">export_buffer_length</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Make constant readers if config environment:constant:&lt;var&gt; is</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_configspec</span><span class="p">(</span><span class="s1">&#39;environment:constant:&#39;</span><span class="p">)</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mr</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">opendrift.readers</span> <span class="kn">import</span> <span class="n">reader_constant</span>
            <span class="n">rc</span> <span class="o">=</span> <span class="n">reader_constant</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_reader</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">missing_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing_variables</span><span class="p">()</span>
        <span class="n">missing_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing_variables</span> <span class="k">if</span>
                             <span class="n">m</span> <span class="o">!=</span> <span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">has_fallback</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">missing_variables</span>
                            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">]</span>
            <span class="n">has_no_fallback</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">missing_variables</span>
                               <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">]</span>
            <span class="c1">#if has_fallback == missing_variables:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_fallback</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span><span class="c1"># == missing_variables:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fallback values will be used for the following &#39;</span>
                             <span class="s1">&#39;variables which have no readers: &#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">has_fallback</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1">: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">]))</span>
            <span class="c1">#else:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">has_no_fallback</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lazy_readers</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span><span class="c1"># == missing_variables:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No readers added for the following variables: &#39;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">has_no_fallback</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Readers must be added for the &#39;</span>
                                 <span class="s1">&#39;following required variables: &#39;</span> <span class="o">+</span>
                                 <span class="nb">str</span><span class="p">(</span><span class="n">has_no_fallback</span><span class="p">))</span>

        <span class="c1"># Some cleanup needed if starting from imported state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">):</span>
            <span class="c1"># Delete history matrix before new run</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">)</span>
            <span class="c1"># Renumbering elements from 0 to num_elements, necessary fix when</span>
            <span class="c1"># importing from file, where elements may have been deactivated</span>
            <span class="c1"># TODO: should start from 1?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">())</span>

        <span class="c1">########################</span>
        <span class="c1"># Simulation time step</span>
        <span class="c1">########################</span>
        <span class="k">if</span> <span class="n">time_step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_step</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:time_step_minutes&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">timedelta</span><span class="p">:</span>
            <span class="c1"># Time step may be given in seconds, as alternative to timedelta</span>
            <span class="n">time_step</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="n">time_step</span>
        <span class="k">if</span> <span class="n">time_step_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_step_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:time_step_output_minutes&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time_step_output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">time_step_output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">time_step_output</span><span class="p">)</span> <span class="ow">is</span> <span class="n">timedelta</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span> <span class="o">=</span> <span class="n">time_step_output</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time_step_output</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span>

        <span class="n">time_step_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">time_step_ratio</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Output time step must be equal or larger &#39;</span>
                             <span class="s1">&#39;than calculation time step.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">time_step_ratio</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Ratio of calculation and output time steps &#39;</span>
                             <span class="s1">&#39;must be an integer - given ratio is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="n">time_step_ratio</span><span class="p">)</span>
        <span class="c1">########################</span>
        <span class="c1"># Simulation duration</span>
        <span class="c1">########################</span>
        <span class="k">if</span> <span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Backwards simulation, starting from last seeded element&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only one of &quot;steps&quot;, &quot;duration&quot; and &quot;end_time&quot; &#39;</span>
                             <span class="s1">&#39;may be provided simultaneously&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">steps</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">end_time</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">end_time</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">end_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Duration, steps or end time not specified, &#39;</span>
                                 <span class="s1">&#39;running until end of first reader: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">end_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

        <span class="k">if</span> <span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">duration</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Duration shall also be negative for backwards run</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="o">-</span><span class="n">duration</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Time step must be negative if duration is negative.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_output</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Includes start and end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_calculation</span> <span class="o">=</span> <span class="n">duration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_output</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_calculation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_calculation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_calculation</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>

        <span class="c1">##############################################################</span>
        <span class="c1"># Prepare readers for the requested simulation domain/time</span>
        <span class="c1">##############################################################</span>
        <span class="n">max_distance</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_calculation</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="n">deltalat</span> <span class="o">=</span> <span class="n">max_distance</span><span class="o">/</span><span class="mf">111000.</span>
        <span class="n">deltalon</span> <span class="o">=</span> <span class="n">deltalat</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="p">)))</span>
        <span class="c1"># TODO: extent should ideally be a general polygon, not only lon/lat-min/max</span>
        <span class="c1"># TODO: Should also take into account eventual lifetime of elements</span>
        <span class="n">simulation_extent</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltalon</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="mi">89</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">deltalat</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">720</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltalon</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">89</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">deltalat</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Preparing readers for simulation coverage (</span><span class="si">%s</span><span class="s1">) and time (</span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">)&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">simulation_extent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_end_time</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">reader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Preparing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">simulation_extent</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_end_time</span><span class="p">)</span>

        <span class="c1">##############################################################</span>
        <span class="c1"># If no landmask has been added, we determine it dynamically</span>
        <span class="c1">##############################################################</span>
        <span class="c1"># TODO: some more error checking here</span>
        <span class="c1"># If landmask is requested, it shall not be obtained from other readers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:use_auto_landmask&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;land_binary_mask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;basemap_landmask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;basemap_landmask&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;global_landmask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;global_landmask&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;general:use_auto_landmask&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="s1">&#39;land_binary_mask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span> <span class="ow">and</span> \
                <span class="s1">&#39;land_binary_mask&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span> \
                <span class="ow">and</span> <span class="s1">&#39;land_binary_mask&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Adding a dynamical landmask with max. priority based on &#39;</span>
                <span class="s1">&#39;assumed maximum speed of </span><span class="si">%s</span><span class="s1"> m/s. &#39;</span>
                <span class="s1">&#39;Adding a customised landmask may be faster...&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_speed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;preparing main loop:making dynamical landmask&#39;</span><span class="p">)</span>
            <span class="n">reader_landmask</span> <span class="o">=</span> <span class="n">reader_global_landmask</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">extent</span> <span class="o">=</span> <span class="n">simulation_extent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_reader</span><span class="p">(</span><span class="n">reader_landmask</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;preparing main loop:making dynamical landmask&#39;</span><span class="p">)</span>

        <span class="c1"># Move point seeded on land to ocean</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;seed:ocean_only&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="s1">&#39;land_binary_mask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">):</span>
            <span class="c1">#(&#39;land_binary_mask&#39; not in self.fallback_values) and \</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;preparing main loop:moving elements to ocean&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">closest_ocean_points</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;preparing main loop:moving elements to ocean&#39;</span><span class="p">)</span>

        <span class="c1">####################################################################</span>
        <span class="c1"># Preparing history array for storage in memory and eventually file</span>
        <span class="c1">####################################################################</span>
        <span class="k">if</span> <span class="n">export_buffer_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_buffer_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_buffer_length</span> <span class="o">=</span> <span class="n">export_buffer_length</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># For backwards simulation, we start at last seeded element</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Backwards simulation, starting at &#39;</span>
                         <span class="s1">&#39;time of last seeded element&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="c1"># Flipping ID array, so that lowest IDs are released first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Forward simulation, start time has been set when seeding</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

        <span class="c1"># Add the output variables which are always required</span>
        <span class="k">if</span> <span class="n">export_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">export_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">export_variables</span> <span class="o">+</span>
                                        <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span> <span class="o">=</span> <span class="n">export_variables</span>
        <span class="c1"># Initialise array to hold history (element properties and environment)</span>
        <span class="c1"># for export to file.</span>
        <span class="n">history_dtype_fields</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;dtype&#39;</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
        <span class="c1"># Add environment variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">env_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">:</span>
            <span class="n">history_dtype_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">env_var</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history_metadata</span><span class="p">[</span><span class="n">env_var</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Remove variables from output array, if only subset is requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">history_dtype_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">history_dtype_fields</span>
                                    <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_metadata</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_metadata</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

        <span class="n">history_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">history_dtype_fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="p">),</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">export_buffer_length</span><span class="p">)),</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="n">history_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_exported</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_init</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#############################</span>
        <span class="c1"># Check validity domain</span>
        <span class="c1">#############################</span>
        <span class="n">validity_domain</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:deactivate_west_of&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:deactivate_east_of&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:deactivate_south_of&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:deactivate_north_of&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">validity_domain</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validity_domain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validity_domain</span> <span class="o">=</span> <span class="n">validity_domain</span>

        <span class="c1">#############################</span>
        <span class="c1"># Model specific preparation</span>
        <span class="c1">#############################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_run</span><span class="p">()</span>

        <span class="c1">##########################</span>
        <span class="c1"># Main loop</span>
        <span class="c1">##########################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;simulation_time&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;preparing main loop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;main loop&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_calculation</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Release elements</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">release_elements</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No active but </span><span class="si">%s</span><span class="s1"> scheduled elements, skipping timestep </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_to_buffer</span><span class="p">()</span>  <span class="c1"># Append status to history array</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">increase_age_and_retire</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">interact_with_seafloor</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_continuous_performance</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="p">())</span>
                <span class="c1"># Display time to terminal</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;===================================&#39;</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> - step </span><span class="si">%i</span><span class="s1"> of </span><span class="si">%i</span><span class="s1"> - </span><span class="si">%i</span><span class="s1"> active elements &#39;</span>
                             <span class="s1">&#39;(</span><span class="si">%i</span><span class="s1"> deactivated)&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">expected_steps_calculation</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_deactivated</span><span class="p">()))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> elements scheduled.&#39;</span> <span class="o">%</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;===================================&#39;</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_profiles</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">required_profiles</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">store_previous_variables</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_missing_environment_variables</span><span class="p">()</span>

                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">report_missing_variables</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">interact_with_coastline</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">interact_with_seafloor</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;missing_data&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">state_to_buffer</span><span class="p">()</span>  <span class="c1"># Append status to history array</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">remove_deactivated_elements</span><span class="p">()</span>

                <span class="c1"># Propagate one timestep forwards</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No more active or scheduled elements, quitting.&#39;</span><span class="p">)</span>

                <span class="c1"># Store location, in case elements shall be moved back</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_present_positions</span><span class="p">()</span>

                <span class="c1">#####################################################</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calling </span><span class="si">%s</span><span class="s1">.update()&#39;</span> <span class="o">%</span>
                                  <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;main loop:updating elements&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;main loop:updating elements&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No active elements, skipping update() method&#39;</span><span class="p">)</span>
                <span class="c1">#####################################################</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_diffusion</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No active or scheduled elements, quitting simulation&#39;</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> active elements (</span><span class="si">%s</span><span class="s1"> deactivated)&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_deactivated</span><span class="p">()))</span>
                <span class="c1"># Updating time</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The simulation stopped before requested &#39;</span>
                           <span class="s1">&#39;end time was reached.&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;========================&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;End of simulation:&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">())</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Simulation aborted. &#39;</span> <span class="o">+</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;========================&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_on_error</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Stopping on error. &#39;</span> <span class="o">+</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Simulation stopped within &#39;</span>
                        <span class="s1">&#39;first timestep. &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">())</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;main loop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_start</span><span class="p">(</span><span class="s1">&#39;cleaning up&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cleaning up&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interact_with_coastline</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_to_buffer</span><span class="p">()</span>  <span class="c1"># Append final status to buffer</span>

        <span class="c1">#############################</span>
        <span class="c1"># Add some metadata</span>
        <span class="c1">#############################</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="s1">&#39;reader_&#39;</span> <span class="o">+</span> <span class="n">var</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_values</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">readers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">readers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;constant_reader&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">readers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_parameter_value_map</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">readers</span><span class="p">[</span>
                                <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_parameter_value_map</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_metadata</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Writing and closing output file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outfile</span><span class="p">)</span>
            <span class="c1"># Write buffer to outfile, and close</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_exported</span><span class="p">:</span>
                <span class="c1"># Write last lines, if needed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">io_write_buffer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_close</span><span class="p">()</span>

        <span class="c1"># Remove any elements scheduled for deactivation during last step</span>
        <span class="c1">#self.remove_deactivated_elements()</span>

        <span class="k">if</span> <span class="n">export_buffer_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Remove columns for unseeded elements in history array</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing </span><span class="si">%i</span><span class="s1"> unseeded elements from history array&#39;</span> <span class="o">%</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">())</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">mask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># Remove rows for unreached timsteps in history array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[:,</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If output has been flushed to file during run, we</span>
               <span class="c1"># need to reimport from file to get all data in memory</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;environment_profiles&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment_profiles</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_import_file</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;cleaning up&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer_end</span><span class="p">(</span><span class="s1">&#39;total time&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.increase_age_and_retire"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.increase_age_and_retire">[docs]</a>    <span class="k">def</span> <span class="nf">increase_age_and_retire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increase age of elements, and retire if older than config setting.&quot;&quot;&quot;</span>
        <span class="c1"># Increase age of elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1"># Deactivate elements that exceed a certain age</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:max_age_seconds&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">age_seconds</span> <span class="o">&gt;=</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s1">&#39;drift:max_age_seconds&#39;</span><span class="p">),</span>
                                     <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;retired&#39;</span><span class="p">)</span>

        <span class="c1"># Deacticate any elements outside validity domain set by user</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity_domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">W</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validity_domain</span>
            <span class="k">if</span> <span class="n">W</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span> <span class="o">&lt;</span> <span class="n">W</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">E</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">S</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="n">S</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span> <span class="o">&gt;</span> <span class="n">N</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.state_to_buffer"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.state_to_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">state_to_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append present state (elements and environment) to recarray.&quot;&quot;&quot;</span>

        <span class="n">steps_calculation_float</span> <span class="o">=</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">&lt;=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">steps_calculation_float</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">steps_calculation_float</span><span class="p">))</span>

        <span class="n">ID_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">ID</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">time_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_exported</span>

        <span class="k">if</span> <span class="n">steps_calculation_float</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">element_ind</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ID_ind</span><span class="p">))</span>  <span class="c1"># We write all elements</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deactivated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deactivated</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>  <span class="c1"># No deactivated elements this sub-timestep</span>
            <span class="c1"># We write history for deactivated elements only:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Writing history for </span><span class="si">%s</span><span class="s1"> deactivated elements&#39;</span> <span class="o">%</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">deactivated</span><span class="p">))</span>
            <span class="n">ID_ind</span> <span class="o">=</span> <span class="n">ID_ind</span><span class="p">[</span><span class="n">deactivated</span><span class="p">]</span>
            <span class="n">element_ind</span> <span class="o">=</span> <span class="n">deactivated</span>
            <span class="n">time_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">time_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># TODO: storing of variables and environment below should be collected in a single loop</span>
        <span class="c1"># Store present state in history recarray</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">variables</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                    <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Temporarily assuming elements numbered</span>
            <span class="c1"># from 0 to num_elements_active()</span>
            <span class="c1"># Does not hold when importing ID from a saved file, where</span>
            <span class="c1"># some elements have been deactivated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">ID_ind</span><span class="p">,</span> <span class="n">time_ind</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="n">element_ind</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ID_ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">ID_ind</span><span class="p">,</span> <span class="n">time_ind</span><span class="p">])</span>
                <span class="n">newmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">ID_ind</span><span class="p">,</span> <span class="n">time_ind</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">newmin</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maxvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">newmax</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">newmin</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maxvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxvals</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">newmax</span><span class="p">)</span>
        <span class="c1"># Copy environment data to history array</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                    <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_variables</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">ID_ind</span><span class="p">,</span> <span class="n">time_ind</span><span class="p">]</span> <span class="o">=</span> \
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">var</span><span class="p">)[</span><span class="n">element_ind</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ID_ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">ID_ind</span><span class="p">,</span> <span class="n">time_ind</span><span class="p">])</span>
                <span class="n">newmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">ID_ind</span><span class="p">,</span> <span class="n">time_ind</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">newmin</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maxvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">newmax</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minvals</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">newmin</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">maxvals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxvals</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">newmax</span><span class="p">)</span>

        <span class="c1"># Call writer if buffer is full</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_exported</span><span class="p">)</span> <span class="o">==</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">export_buffer_length</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">io_write_buffer</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.report_missing_variables"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.report_missing_variables">[docs]</a>    <span class="k">def</span> <span class="nf">report_missing_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue warning if some environment variables missing.&quot;&quot;&quot;</span>

        <span class="n">missing_variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()):</span>
                <span class="n">missing_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Missing variables: &#39;</span> <span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_message</span><span class="p">(</span><span class="s1">&#39;Missing variables: &#39;</span> <span class="o">+</span>
                               <span class="nb">str</span><span class="p">(</span><span class="n">missing_variables</span><span class="p">))</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.index_of_activation_and_deactivation"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.index_of_activation_and_deactivation">[docs]</a>    <span class="k">def</span> <span class="nf">index_of_activation_and_deactivation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the indices when elements were seeded and deactivated.&quot;&quot;&quot;</span>

        <span class="n">firstlast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">notmasked_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">index_of_activation</span> <span class="o">=</span> <span class="n">firstlast</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">index_of_deactivation</span> <span class="o">=</span> <span class="n">firstlast</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_of_deactivation</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">missingind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">firstlast</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> elements were never seeded, removing from history array (this is probably caused by importing an old file)&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">missingind</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">firstlast</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="n">index_of_activation</span><span class="p">,</span> <span class="n">index_of_deactivation</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.set_up_map"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.set_up_map">[docs]</a>    <span class="k">def</span> <span class="nf">set_up_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">delta_lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">lscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide_landmask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate Figure instance on which trajectories are plotted.</span>

<span class="sd">        :param hide_landmask: do not plot landmask (default False)</span>
<span class="sd">        :type hide_landmask: bool</span>

<span class="sd">        provide corners=[lonmin, lonmax, latmin, latmax] for specific map selection</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialise map</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">):</span>  <span class="c1"># If dataset is lazily imported</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lat</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding min longitude...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lonmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding max longitude...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lonmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding min latitude...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding max latitude...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">lonmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonmin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">lonmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonmax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">latmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latmin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">latmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latmax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>  <span class="c1"># TODO: to be removed</span>

        <span class="k">if</span> <span class="n">corners</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># User provided map corners</span>
            <span class="n">lonmin</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lonmax</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">latmin</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">latmax</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lonmin&#39;</span><span class="p">):</span>  <span class="c1"># if dataset is lazily imported</span>
            <span class="n">lonmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonmin</span>
            <span class="n">lonmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonmax</span>
            <span class="n">latmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latmin</span>
            <span class="n">latmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latmax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>
            <span class="n">lonmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">-</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">lonmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">*</span><span class="mi">2</span>
            <span class="n">latmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">-</span> <span class="n">buffer</span>
            <span class="n">latmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">+</span> <span class="n">buffer</span>

        <span class="k">if</span> <span class="n">fast</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Plotting fast. This will make your plots less accurate.&#39;</span><span class="p">)</span>

            <span class="kn">import</span> <span class="nn">matplotlib.style</span> <span class="k">as</span> <span class="nn">mplstyle</span>
            <span class="n">mplstyle</span><span class="o">.</span><span class="n">use</span><span class="p">([</span><span class="s1">&#39;fast&#39;</span><span class="p">])</span>

            <span class="c1"># use a spherical earth</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="mf">57.29577951308232</span>  <span class="c1"># something to do with pi</span>
            <span class="n">globe</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Globe</span><span class="p">(</span><span class="n">ellipse</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">semimajor_axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span> <span class="n">semiminor_axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">)</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Mercator</span><span class="p">(</span><span class="n">globe</span> <span class="o">=</span> <span class="n">globe</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lscale</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Mercator</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lscale</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>

        <span class="n">meanlat</span> <span class="o">=</span> <span class="p">(</span><span class="n">latmin</span> <span class="o">+</span> <span class="n">latmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">latmax</span><span class="o">-</span><span class="n">latmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">lonmax</span><span class="o">-</span><span class="n">lonmin</span><span class="p">))</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">aspect_ratio</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">meanlat</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.</span><span class="o">/</span><span class="n">aspect_ratio</span><span class="p">,</span> <span class="mf">11.</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.</span><span class="p">,</span> <span class="mf">11.</span><span class="o">*</span><span class="n">aspect_ratio</span><span class="p">))</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>  <span class="c1"># need &#39;111&#39; for Python 2</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">lonmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">latmax</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

        <span class="k">if</span> <span class="s1">&#39;ocean_color&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ocean_color&#39;</span><span class="p">])</span>
            <span class="n">ocean_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ocean_color&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ocean_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;land_color&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">land_color</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;land_color&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fast</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">land_color</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">land_color</span> <span class="o">=</span> <span class="n">cfeature</span><span class="o">.</span><span class="n">COLORS</span><span class="p">[</span><span class="s1">&#39;land&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">te</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="o">**</span><span class="n">te</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;box&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">bx</span> <span class="ow">in</span> <span class="n">box</span><span class="p">:</span>
                <span class="n">lonmn</span> <span class="o">=</span> <span class="n">bx</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lonmx</span> <span class="o">=</span> <span class="n">bx</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">latmn</span> <span class="o">=</span> <span class="n">bx</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">latmx</span> <span class="o">=</span> <span class="n">bx</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">bx</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">bx</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">bx</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">lonmn</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">latmx</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">bx</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">())</span>
                    <span class="k">del</span> <span class="n">bx</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">xy</span><span class="o">=</span><span class="p">[</span><span class="n">lonmn</span><span class="p">,</span> <span class="n">latmn</span><span class="p">],</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">lonmx</span><span class="o">-</span><span class="n">lonmn</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">latmx</span><span class="o">-</span><span class="n">latmn</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Geodetic</span><span class="p">(),</span> <span class="o">**</span><span class="n">bx</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">hide_landmask</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;land_binary_mask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_list</span><span class="p">[</span><span class="s1">&#39;land_binary_mask&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using custom shapes for plotting land..&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_geometries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">polys</span><span class="p">,</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">land_color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reader_global_landmask</span><span class="o">.</span><span class="n">plot_land</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">lonmin</span><span class="p">,</span> <span class="n">latmin</span><span class="p">,</span> <span class="n">lonmax</span><span class="p">,</span> <span class="n">latmax</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">ocean_color</span><span class="p">,</span> <span class="n">land_color</span><span class="p">,</span> <span class="n">lscale</span><span class="p">)</span>

        <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cartopy</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&lt;</span> <span class="s1">&#39;0.18.0&#39;</span><span class="p">:</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">xlabels_top</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Cartopy &lt; 0.18</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Cartopy &gt;= 0.18</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_tight_layout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">firstlast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">notmasked_edges</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">index_of_first</span> <span class="o">=</span> <span class="n">firstlast</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">index_of_last</span> <span class="o">=</span> <span class="n">firstlast</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">index_of_last</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_of_first</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">index_of_last</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Activate figure zooming</span>
            <span class="n">mng</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
            <span class="n">mng</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">zoom</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Maximise figure window size</span>
            <span class="n">mng</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="o">*</span><span class="n">mng</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">maxsize</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">lons</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lats</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">index_of_first</span><span class="p">,</span> <span class="n">index_of_last</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_lonlats"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_lonlats">[docs]</a>    <span class="k">def</span> <span class="nf">get_lonlats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">):</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.animation"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.animation">[docs]</a>    <span class="k">def</span> <span class="nf">animation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compare</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bgalpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drifter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">skip</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_elements</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">show_trajectories</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trajectory_alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">hide_landmask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">density_pixelsize_m</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">unitfactor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">surface_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">origin_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">legend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">lscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Animate last run.&quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please run simulation before animating&#39;</span><span class="p">)</span>

        <span class="n">markersizebymass</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">markersize</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">markersize</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
                <span class="n">markersizebymass</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">markersize</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">background</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lcs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">density</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">markercolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_comparison_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">density</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Density field is weighted by this variable</span>
            <span class="c1"># TODO: not yet implemented!</span>
            <span class="n">density_weight</span> <span class="o">=</span> <span class="n">density</span>
            <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">density_weight</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">density</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">density_weight</span><span class="o">=</span><span class="n">density</span>
                <span class="n">density</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Get density arrays</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ds&#39;</span><span class="p">):</span>  <span class="c1"># opened with Xarray</span>
                <span class="k">if</span> <span class="n">origin_marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">origin_marker</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">per_origin_marker</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">per_origin_marker</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">H</span><span class="p">,</span> <span class="n">H_om</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_xarray</span><span class="p">(</span><span class="n">pixelsize_m</span><span class="o">=</span><span class="n">density_pixelsize_m</span><span class="p">,</span>
                                                                        <span class="n">weights</span><span class="o">=</span><span class="n">density_weight</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">per_origin_marker</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">H</span> <span class="o">=</span> <span class="n">H_om</span><span class="p">[:,:,:,</span><span class="n">origin_marker</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">origin_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Separation by origin_marker is only active when imported from file with &#39;</span>
                            <span class="s1">&#39;open_xarray: https://opendrift.github.io/gallery/example_huge_output.html&#39;</span><span class="p">)</span>
                <span class="n">H</span><span class="p">,</span> <span class="n">H_submerged</span><span class="p">,</span> <span class="n">H_stranded</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_density_array</span><span class="p">(</span><span class="n">pixelsize_m</span><span class="o">=</span><span class="n">density_pixelsize_m</span><span class="p">,</span>
                                           <span class="n">weight</span><span class="o">=</span><span class="n">density_weight</span><span class="p">)</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">H</span> <span class="o">+</span> <span class="n">H_submerged</span> <span class="o">+</span> <span class="n">H_stranded</span>

        <span class="c1"># x, y are longitude, latitude -&gt; i.e. in a PlateCarree CRS</span>
        <span class="n">gcrs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">plot_timestep</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Sub function needed for matplotlib animation.&quot;&quot;&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1"> UTC&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figure_title</span><span class="p">(),</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">u_component</span><span class="p">,</span> <span class="n">v_component</span><span class="p">,</span> <span class="n">qmap_x</span><span class="p">,</span> <span class="n">qmap_y</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_map_background</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span>
                                            <span class="n">time</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="c1"># https://stackoverflow.com/questions/18797175/animation-with-pcolormesh-routine-in-matplotlib-how-do-i-initialize-the-data</span>
                <span class="n">bg</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">scalar</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">bg_quiv</span><span class="o">.</span><span class="n">set_UVC</span><span class="p">(</span><span class="n">u_component</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">],</span> <span class="n">v_component</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">lcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
                    <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">bgalpha</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Update density plot</span>
                <span class="n">pm</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

            <span class="c1"># Move points</span>
            <span class="k">if</span> <span class="n">show_elements</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">points</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                                         <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]])</span>
                <span class="n">points_deactivated</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span>
                    <span class="n">x_deactive</span><span class="p">[</span><span class="n">index_of_last_deactivated</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">],</span>
                    <span class="n">y_deactive</span><span class="p">[</span><span class="n">index_of_last_deactivated</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">]])</span>

                <span class="k">if</span> <span class="n">markersizebymass</span><span class="p">:</span>
                    <span class="n">points</span><span class="o">.</span><span class="n">set_sizes</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;mass_degraded&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;mass_volatilized&#39;</span><span class="p">][:,</span><span class="n">i</span><span class="p">])))</span>

                <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># Update colors</span>
                    <span class="n">points</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">colorarray</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                        <span class="n">points_deactivated</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span>
                            <span class="n">colorarray_deactivated</span><span class="p">[</span>
                                <span class="n">index_of_last_deactivated</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">drifter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">drifter_pos</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>

            <span class="k">if</span> <span class="n">show_elements</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">compare_list</span><span class="p">:</span>
                        <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;points_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span>
                            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">][</span><span class="nb">range</span><span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">],</span>
                            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;y_other&#39;</span><span class="p">][</span><span class="nb">range</span><span class="p">(</span><span class="n">cd</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">]])</span>
                        <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;points_other_deactivated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span>
                            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;x_other_deactive&#39;</span><span class="p">][</span>
                                <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;index_of_last_deactivated_other&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">],</span>
                            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;y_other_deactive&#39;</span><span class="p">][</span>
                                <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;index_of_last_deactivated_other&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">]])</span>
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;points_other&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">points</span>

        <span class="c1"># Find map coordinates and plot points with empty data</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">index_of_first</span><span class="p">,</span> <span class="n">index_of_last</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">set_up_map</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="n">corners</span><span class="p">,</span> <span class="n">lscale</span><span class="o">=</span><span class="n">lscale</span><span class="p">,</span>
                            <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span> <span class="n">hide_landmask</span><span class="o">=</span><span class="n">hide_landmask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">surface_only</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="n">z</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">y</span><span class="p">[</span><span class="n">z</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">show_trajectories</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">trajectory_alpha</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">show_elements</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">colorarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">color</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">colorarray</span> <span class="o">=</span> <span class="n">colorarray</span><span class="o">*</span><span class="n">unitfactor</span>
                <span class="n">colorarray_deactivated</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">color</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span>
                        <span class="n">index_of_last</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>  <span class="c1"># E.g. array/list of ensemble numbers</span>
                <span class="n">colorarray_deactivated</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">colorarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colorarray</span> <span class="o">=</span> <span class="n">color</span>
            <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">colorarray</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">colorarray</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">u_component</span><span class="p">,</span> <span class="n">v_component</span><span class="p">,</span> <span class="n">qmap_x</span><span class="p">,</span> <span class="n">qmap_y</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_map_background</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span>
                                        <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">bgalpha</span><span class="p">,</span>
                               <span class="n">antialiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">bg_quiv</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">qmap_x</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">],</span>
                                    <span class="n">qmap_y</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">],</span>
                                    <span class="n">u_component</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">],</span>
                                    <span class="n">v_component</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">lcsh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">],</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:],</span>
                                  <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                  <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">show_elements</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">index_of_last_deactivated</span> <span class="o">=</span> \
                <span class="n">index_of_last</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">markercolor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">markersizebymass</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="p">[],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.4</span><span class="p">,</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="p">[],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">compare</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">legend</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]):</span>
            <span class="n">markers</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">legend_index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">legend</span><span class="p">)):</span>
                <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">legend_index</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                                    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="n">legend_index</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">legend_loc</span><span class="p">)</span>

        <span class="c1"># Plot deactivated elements, with transparency</span>
        <span class="k">if</span> <span class="n">markersizebymass</span><span class="p">:</span>
            <span class="n">points_deactivated</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                        <span class="n">edgecolor</span><span class="o">=</span><span class="p">[],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points_deactivated</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                        <span class="n">edgecolor</span><span class="o">=</span><span class="p">[],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="n">x_deactive</span><span class="p">,</span> <span class="n">y_deactive</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">compare_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comparison_xy_for_plots</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compare_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">legend</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
                    <span class="n">legstr</span> <span class="o">=</span> <span class="n">legend</span><span class="p">[</span><span class="n">cn</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">legstr</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;points_other&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_comparison_colors</span><span class="p">[</span><span class="n">cn</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legstr</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                <span class="c1"># Plot deactivated elements, with transparency</span>
                <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;points_other_deactivated&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                               <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_comparison_colors</span><span class="p">[</span><span class="n">cn</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">legend</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">markerscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">legend_loc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">density</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">H</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
            <span class="n">lat_array</span><span class="p">,</span> <span class="n">lon_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lat_array</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">H</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span><span class="p">,</span> <span class="n">H</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:],</span>
                               <span class="n">vmin</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">gcrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">drifter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Interpolate drifter time series onto simulation times</span>
            <span class="n">sts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">dts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">dts</span><span class="p">,</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
            <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">dts</span><span class="p">,</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">])</span>
            <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">sts</span><span class="o">&lt;</span><span class="n">dts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="n">sts</span><span class="o">&gt;</span><span class="n">dts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">sts</span><span class="o">&lt;</span><span class="n">dts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="n">sts</span><span class="o">&gt;</span><span class="n">dts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">dlabel</span> <span class="o">=</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">drifter</span> <span class="k">else</span> <span class="s1">&#39;Drifter&#39;</span>
            <span class="n">dcolor</span> <span class="o">=</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;color&#39;</span> <span class="ow">in</span> <span class="n">drifter</span> <span class="k">else</span> <span class="s1">&#39;r&#39;</span>
            <span class="n">dlinewidth</span> <span class="o">=</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;linewidth&#39;</span> <span class="ow">in</span> <span class="n">drifter</span> <span class="k">else</span> <span class="mi">2</span>
            <span class="n">dmarkersize</span> <span class="o">=</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;markersize&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;markersize&#39;</span> <span class="ow">in</span> <span class="n">drifter</span> <span class="k">else</span> <span class="mi">20</span>
            <span class="n">drifter_pos</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="n">dcolor</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">dmarkersize</span><span class="p">,</span>
                                     <span class="n">label</span><span class="o">=</span><span class="n">dlabel</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">gcrs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">drifter</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">dcolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">dlinewidth</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">gcrs</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_tight_layout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colorbar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">clabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">clabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">clabel</span> <span class="o">=</span> <span class="n">color</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">points</span>
            <span class="k">elif</span> <span class="n">density</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">pm</span>
                <span class="k">if</span> <span class="n">clabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">clabel</span> <span class="o">=</span> <span class="s1">&#39;density&#39;</span>
            <span class="k">elif</span> <span class="n">lcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">lcsh</span>
                <span class="k">if</span> <span class="n">clabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">clabel</span> <span class="o">=</span> <span class="s1">&#39;LCS&#39;</span>
            <span class="k">elif</span> <span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">bg</span>
                <span class="k">if</span> <span class="n">clabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">clabel</span> <span class="o">=</span> <span class="n">background</span>

            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">clabel</span><span class="p">)</span>

        <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">(),</span> <span class="n">plot_timestep</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">frames</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;sphinx_gallery&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_animation</span><span class="p">(</span><span class="n">anim</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Time to make animation: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.animation_profile"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.animation_profile">[docs]</a>    <span class="k">def</span> <span class="nf">animation_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compare</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">legend</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">legend_loc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Animate vertical profile of the last run.&quot;&quot;&quot;</span>


        <span class="k">def</span> <span class="nf">plot_timestep</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Sub function needed for matplotlib animation.&quot;&quot;&quot;</span>
            <span class="c1">#plt.gcf().gca().set_title(str(i))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> UTC&#39;</span> <span class="o">%</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">PlotColors</span><span class="p">:</span>
                <span class="n">points</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">z</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">points</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">colorarray</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">points</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">],</span>
                                <span class="n">z</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">])</span>

            <span class="n">points_deactivated</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
                <span class="n">x_deactive</span><span class="p">[</span><span class="n">index_of_last_deactivated</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">],</span>
                <span class="n">z_deactive</span><span class="p">[</span><span class="n">index_of_last_deactivated</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">points_other</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">x_other</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">x_other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">],</span>
                                      <span class="n">z_other</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">x_other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">points_other_deactivated</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span>
                    <span class="n">x_other_deactive</span><span class="p">[</span><span class="n">index_of_last_deactivated_other</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">],</span>
                    <span class="n">z_other_deactive</span><span class="p">[</span><span class="n">index_of_last_deactivated_other</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_other</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">points</span>

        <span class="n">PlotColors</span><span class="o">=</span><span class="p">(</span><span class="n">compare</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">legend</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">PlotColors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">colorarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">color</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>


        <span class="c1"># Set up plot</span>
        <span class="n">index_of_first</span><span class="p">,</span> <span class="n">index_of_last</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">index_of_activation_and_deactivation</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="c1">#seafloor_depth = \</span>
        <span class="c1">#    -self.get_property(&#39;sea_floor_depth_below_sea_level&#39;)[0].T</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">6.</span><span class="p">))</span>  <span class="c1"># Suitable aspect ratio</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude [degrees]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Depth [m]&#39;</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">index_of_last_deactivated</span> <span class="o">=</span> \
            <span class="n">index_of_last</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PlotColors</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">c</span><span class="o">=</span><span class="p">[],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                 <span class="n">edgecolor</span><span class="o">=</span><span class="p">[],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                                 <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

            <span class="n">markers</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">legend_index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">legend</span><span class="p">)):</span>
                <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                               <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">legend_index</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                               <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="n">legend_index</span><span class="p">]))</span>
            <span class="n">leg</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">markers</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">legend_loc</span><span class="p">)</span>
            <span class="n">leg</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;.k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


        <span class="c1"># Plot deactivated elements, with transparency</span>
        <span class="n">points_deactivated</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;.k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_deactive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lon</span>
        <span class="n">z_deactive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">z</span>

        <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="c1"># Other is given as filename</span>
                <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">other</span><span class="o">.</span><span class="n">io_import_file</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Other is given as an OpenDrift object</span>
                <span class="n">other</span> <span class="o">=</span> <span class="n">compare</span>
            <span class="n">z_other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">x_other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">points_other</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_other</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">z_other</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;.r&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Plot deactivated elements, with transparency</span>
            <span class="n">points_other_deactivated</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s1">&#39;.r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x_other_deactive</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lon</span>
            <span class="n">z_other_deactive</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">z</span>
            <span class="n">firstlast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">notmasked_edges</span><span class="p">(</span><span class="n">x_other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">index_of_last_other</span> <span class="o">=</span> <span class="n">firstlast</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">index_of_last_deactivated_other</span> <span class="o">=</span> \
                <span class="n">index_of_last_other</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x_other</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_other</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">z_other</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">z_other</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">zmin</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">zmax</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Set figure limits</span>
        <span class="n">sky</span> <span class="o">=</span> <span class="p">(</span><span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span><span class="o">*</span><span class="mf">.1</span>  <span class="c1"># Sky height is 10% of water depth</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">zmin</span><span class="p">,</span> <span class="n">sky</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">,</span> <span class="n">sky</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightsteelblue&#39;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">),</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">,</span>
                     <span class="o">-</span><span class="n">zmin</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">legend</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">PlotColors</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">(),</span> <span class="n">plot_timestep</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">frames</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">interval</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;sphinx_gallery&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_animation</span><span class="p">(</span><span class="n">anim</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._get_comparison_xy_for_plots"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._get_comparison_xy_for_plots">[docs]</a>    <span class="k">def</span> <span class="nf">_get_comparison_xy_for_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compare</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">compare</span> <span class="o">=</span> <span class="p">[</span><span class="n">compare</span><span class="p">]</span>
        <span class="n">compare_list</span> <span class="o">=</span> <span class="p">[{}]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compare</span><span class="p">):</span>
            <span class="n">compare_list</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="n">compare_list</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span>  <span class="c1"># pointer to dict with data</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="c1"># Other is given as filename</span>
                <span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">other</span><span class="o">.</span><span class="n">io_import_file</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Other is given as an OpenDrift object</span>
                <span class="n">other</span> <span class="o">=</span> <span class="n">comp</span>

            <span class="c1"># Find map coordinates of comparison simulations</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">],</span> <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;y_other&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;x_other_deactive&#39;</span><span class="p">],</span> <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;y_other_deactive&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="n">other</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;firstlast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">notmasked_edges</span><span class="p">(</span>
                <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;index_of_last_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;firstlast&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;index_of_last_deactivated_other&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">cd</span><span class="p">[</span><span class="s1">&#39;index_of_last_other&#39;</span><span class="p">][</span><span class="n">other</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">ID</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">compare_list</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.plot"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compare</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span>
             <span class="n">lvmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lvmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">show_scalar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">contourlines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trajectory_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_particles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_initial</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">density_pixelsize_m</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">bgalpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">surface_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">submerged_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">lscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hide_landmask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Basic built-in plotting function intended for developing/debugging.</span>

<span class="sd">        Plots trajectories of all particles.</span>
<span class="sd">        Positions marked with colored stars:</span>
<span class="sd">        - green: all start positions</span>
<span class="sd">        - red: deactivated particles</span>
<span class="sd">        - blue: particles still active at end of simulation</span>

<span class="sd">        Requires availability of Cartopy.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            background: string, name of variable (standard_name) which will</span>
<span class="sd">                be plotted as background of trajectories, provided that it</span>
<span class="sd">                can be read with one of the available readers.</span>

<span class="sd">            buffer: float; spatial buffer of plot in degrees of</span>
<span class="sd">                longitude/latitude around particle collection.</span>

<span class="sd">            background: name of variable to be plotted as background field.</span>
<span class="sd">            Use two element list for vector fields, e.g. [&#39;x_wind&#39;, &#39;y_wind&#39;]</span>

<span class="sd">            vmin, vmax: minimum and maximum values for colors of background.</span>

<span class="sd">            linecolor: name of variable to be used for coloring trajectories, or matplotlib color string.</span>

<span class="sd">            lvmin, lvmax: minimum and maximum values for colors of trajectories.</span>

<span class="sd">            lscale (string): resolution of land feature (&#39;c&#39;, &#39;l&#39;, &#39;i&#39;, &#39;h&#39;, &#39;f&#39;, &#39;auto&#39;). default is &#39;auto&#39;.</span>

<span class="sd">            fast (bool): use some optimizations to speed up plotting at the cost of accuracy</span>

<span class="sd">            :param hide_landmask: do not plot landmask (default False).</span>
<span class="sd">            :type hide_landmask: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">mappable</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please run simulation before plotting&#39;</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># x, y are longitude, latitude -&gt; i.e. in a PlateCarree CRS</span>
        <span class="n">gcrs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">index_of_first</span><span class="p">,</span> <span class="n">index_of_last</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">set_up_map</span><span class="p">(</span><span class="n">buffer</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span> <span class="n">corners</span><span class="o">=</span><span class="n">corners</span><span class="p">,</span> <span class="n">lscale</span><span class="o">=</span><span class="n">lscale</span><span class="p">,</span> <span class="n">fast</span><span class="o">=</span><span class="n">fast</span><span class="p">,</span> <span class="n">hide_landmask</span><span class="o">=</span><span class="n">hide_landmask</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">markercolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_comparison_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># The more elements, the more transparent we make the lines</span>
        <span class="n">min_alpha</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">max_elements</span> <span class="o">=</span> <span class="mf">5000.0</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">min_alpha</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_total</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">min_alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">linewidth</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Plot trajectories</span>
            <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">is_color_like</span>
            <span class="k">if</span> <span class="n">linecolor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">is_color_like</span><span class="p">(</span><span class="n">linecolor</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_color_like</span><span class="p">(</span><span class="n">linecolor</span><span class="p">):</span>
                    <span class="n">linecolor</span> <span class="o">=</span> <span class="n">linecolor</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">linecolor</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
                <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">legend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">compare</span><span class="p">,</span> <span class="s1">&#39;len&#39;</span><span class="p">):</span>
                            <span class="n">numleg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">numleg</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="n">legend</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Simulation </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                  <span class="nb">range</span><span class="p">(</span><span class="n">numleg</span><span class="p">)]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">linecolor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legend</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">linecolor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">linecolor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#colorbar = True</span>
                <span class="c1"># Color lines according to given parameter</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linecolor</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">linecolor</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">linecolor</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
                        <span class="n">param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">linecolor</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">param</span> <span class="o">=</span> <span class="n">linecolor</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Available parameters to be used for linecolors: &#39;</span> <span class="o">+</span>
                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>
                <span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">LineCollection</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">vind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">index_of_first</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">index_of_last</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">vind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">vind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span>
                                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lvmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">lvmin</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">lvmax</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">lc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span>
                                        <span class="c1">#cmap=plt.get_cmap(&#39;Spectral&#39;),</span>
                                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                                        <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">lvmin</span><span class="p">,</span> <span class="n">lvmax</span><span class="p">),</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                    <span class="c1">#lc.set_linewidth(3)</span>
                    <span class="n">lc</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">vind</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                    <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
                <span class="c1">#axcb = fig.colorbar(lc, ax = ax, orientation = &#39;horizontal&#39;)</span>
                <span class="c1">#try:  # Add unit to colorbar if available</span>
                <span class="c1">#    colorbarstring = linecolor + &#39;  [%s]&#39; % \</span>
                <span class="c1">#        (self.history_metadata[linecolor][&#39;units&#39;])</span>
                <span class="c1">#except:</span>
                <span class="c1">#    colorbarstring = linecolor</span>
                <span class="c1">##axcb.set_label(colorbarstring)</span>
                <span class="c1">#axcb.set_label(colorbarstring, size=14)</span>
                <span class="c1">#axcb.ax.tick_params(labelsize=14)</span>

        <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_initial</span> <span class="o">=</span> <span class="s1">&#39;initial (</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">label_active</span> <span class="o">=</span> <span class="s1">&#39;active (</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_deactivated</span><span class="p">())</span>
            <span class="n">color_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span><span class="p">[</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span>
            <span class="n">color_active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span><span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_initial</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">label_active</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">color_initial</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
            <span class="n">color_active</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
        <span class="k">if</span> <span class="n">show_particles</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show_initial</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">index_of_first</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                       <span class="n">y</span><span class="p">[</span><span class="n">index_of_first</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                       <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                       <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">markercolor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span>
                       <span class="n">c</span><span class="o">=</span><span class="n">color_initial</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_initial</span><span class="p">,</span>
                       <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">surface_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color_active</span> <span class="o">=</span> <span class="n">surface_color</span>
                <span class="n">label_active</span> <span class="o">=</span> <span class="s1">&#39;surface&#39;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">index_of_last</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                       <span class="n">y</span><span class="p">[</span><span class="n">index_of_last</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                       <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                       <span class="n">edgecolor</span><span class="o">=</span><span class="n">markercolor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span>
                       <span class="n">c</span><span class="o">=</span><span class="n">color_active</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_active</span><span class="p">,</span>
                       <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
            <span class="c1">#if submerged_color is not None:</span>
            <span class="c1">#    map.scatter(x[range(x.shape[0]), index_of_last],</span>
            <span class="c1">#                y[range(x.shape[0]), index_of_last], s=markersize,</span>
            <span class="c1">#                zorder=3, edgecolor=markercolor, linewidths=.2,</span>
            <span class="c1">#                c=submerged_color, label=&#39;submerged&#39;)</span>

            <span class="n">x_deactivated</span><span class="p">,</span> <span class="n">y_deactivated</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="c1"># Plot deactivated elements, labeled by deactivation reason</span>
            <span class="k">for</span> <span class="n">statusnum</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># plotted above</span>
                <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span><span class="p">:</span>
                    <span class="c1"># If no color specified, pick an unused one</span>
                    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;DarkSeaGreen&#39;</span><span class="p">,</span> <span class="s1">&#39;brown&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">color</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                            <span class="k">break</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">statusnum</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;seeded_on_land&#39;</span> <span class="ow">or</span>
                        <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;seeded_at_nodata_position&#39;</span><span class="p">):</span>
                        <span class="n">zorder</span> <span class="o">=</span> <span class="mi">11</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">zorder</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">legstr</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">legstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">color_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_colors</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color_status</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_deactivated</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">y_deactivated</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span>
                                <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                                <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">markercolor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
                                <span class="n">c</span><span class="o">=</span><span class="n">color_status</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legstr</span><span class="p">,</span>
                                <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comparison_xy_for_plots</span><span class="p">(</span><span class="n">compare</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cd</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">legend</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">legstr</span> <span class="o">=</span> <span class="n">legend</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">legstr</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;y_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_comparison_colors</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">legstr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;y_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_comparison_colors</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_nolegend_&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">][</span><span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;x_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;index_of_last_other&#39;</span><span class="p">]],</span>
                    <span class="n">c</span><span class="p">[</span><span class="s1">&#39;y_other&#39;</span><span class="p">][</span><span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;y_other&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;index_of_last_other&#39;</span><span class="p">]],</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">markersize</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">markercolor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_comparison_colors</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">legend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">handles</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">legend_loc</span><span class="p">,</span> <span class="n">markerscale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot plot legend, due to bug in matplotlib:&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;residence&#39;</span><span class="p">:</span>
                <span class="n">scalar</span><span class="p">,</span><span class="n">lon_res</span><span class="p">,</span><span class="n">lat_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_residence_time</span><span class="p">(</span>
                    <span class="n">pixelsize_m</span><span class="o">=</span><span class="n">density_pixelsize_m</span><span class="p">)</span>
                <span class="n">scalar</span><span class="p">[</span><span class="n">scalar</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">lon_res</span><span class="p">,</span> <span class="n">lat_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lon_res</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lat_res</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">lon_res</span> <span class="o">=</span> <span class="n">lon_res</span><span class="o">.</span><span class="n">T</span>
                <span class="n">lat_res</span> <span class="o">=</span> <span class="n">lat_res</span><span class="o">.</span><span class="n">T</span>
                <span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_res</span><span class="p">,</span> <span class="n">lat_res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">u_component</span><span class="p">,</span> <span class="n">v_component</span><span class="p">,</span> <span class="n">qmap_x</span><span class="p">,</span> <span class="n">qmap_y</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_map_background</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
                                        <span class="c1">#self.time_step_output)</span>

            <span class="k">if</span> <span class="n">show_scalar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">contourlines</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>
                    <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">bgalpha</span><span class="p">,</span>
                                   <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">contourlines</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span>
                                         <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># contourlines is an array of values</span>
                        <span class="n">CS</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">contourlines</span><span class="p">,</span>
                                         <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mappable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">colorbar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">drawedges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># TODO: need better control of colorbar content</span>
            <span class="k">if</span> <span class="n">clabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">clabel</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linecolor</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">linecolor</span> <span class="o">!=</span> <span class="s1">&#39;gray&#39;</span><span class="p">:</span>
                <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">linecolor</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">background</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">delta_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">map_x</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">delta_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">map_y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">qmap_x</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_x</span><span class="p">,</span> <span class="n">qmap_y</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_y</span><span class="p">,</span>
                      <span class="n">u_component</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">],</span>
                      <span class="n">v_component</span><span class="p">[::</span><span class="n">skip</span><span class="p">,</span> <span class="p">::</span><span class="n">skip</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">map_x_lcs</span><span class="p">,</span> <span class="n">map_y_lcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
                <span class="n">map_x_lcs</span><span class="p">,</span> <span class="n">map_y_lcs</span><span class="p">,</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> UTC (</span><span class="si">%i</span><span class="s1"> steps)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_figure_title</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%i</span><span class="s1"> elements seeded at </span><span class="si">%s</span><span class="s1"> UTC&#39;</span> <span class="o">%</span> <span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_figure_title</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">(),</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                              <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trajectory_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_trajectory_dict</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">trajectory_dict</span><span class="p">)</span>

        <span class="c1">#plt.gca().tick_params(labelsize=14)</span>

        <span class="c1">#fig.canvas.draw()</span>
        <span class="c1">#fig.set_tight_layout(True)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time to make plot: &#39;</span> <span class="o">+</span>
                         <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">plt</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._substance_name"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._substance_name">[docs]</a>    <span class="k">def</span> <span class="nf">_substance_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._figure_title"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._figure_title">[docs]</a>    <span class="k">def</span> <span class="nf">_figure_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substance_name</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;OpenDrift - &#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;OpenDrift - &#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substance_name</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._plot_trajectory_dict"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._plot_trajectory_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_plot_trajectory_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">trajectory_dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Plot provided trajectory along with simulated&#39;&#39;&#39;</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">trajectory_dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">time</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">trajectory_dict</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">trajectory_dict</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">])[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="n">trajectory_dict</span><span class="p">[</span><span class="s1">&#39;linestyle&#39;</span><span class="p">]</span>

        <span class="n">gcrs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;xk&#39;</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">gcrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_map_background"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_map_background">[docs]</a>    <span class="k">def</span> <span class="nf">get_map_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Get background field for plotting on map or animation</span>
        <span class="c1"># TODO: this method should be made more robust</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">background</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># A vector is requested</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">background</span>  <span class="c1"># A scalar is requested</span>
        <span class="k">for</span> <span class="n">readerName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">readerName</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">reader</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">time</span><span class="o">&gt;=</span> <span class="n">reader</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&lt;=</span> <span class="n">reader</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">reader</span><span class="o">.</span><span class="n">always_valid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;elements_scheduled_time&#39;</span><span class="p">):</span>
                <span class="c1"># Using time of first seeded element</span>
                <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements_scheduled_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get reader coordinates covering given map area</span>
        <span class="n">axisproj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">proj4_params</span><span class="p">)</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_extent</span><span class="p">(</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">cornerlons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">])</span>
        <span class="n">cornerlats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
        <span class="n">reader_x</span><span class="p">,</span> <span class="n">reader_y</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">lonlat2xy</span><span class="p">(</span><span class="n">cornerlons</span><span class="p">,</span> <span class="n">cornerlats</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">reader_x</span><span class="o">+</span><span class="n">reader_y</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Axis corner points are not within reader domain</span>
            <span class="n">reader_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reader</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">xmax</span><span class="p">])</span>
            <span class="n">reader_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reader</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">ymax</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reader_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">reader_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">reader_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">reader_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">reader_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">reader_y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get_variables</span><span class="p">(</span>
            <span class="n">background</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">reader_x</span><span class="p">,</span> <span class="n">reader_y</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">reader_x</span><span class="p">,</span> <span class="n">reader_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># Ensemble reader, using first member</span>
            <span class="n">u_component</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">background</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">v_component</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">background</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u_component</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">u_component</span> <span class="o">=</span> <span class="n">u_component</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v_component</span> <span class="o">=</span> <span class="n">v_component</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u_component</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v_component</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># NB: rotation not completed!</span>
            <span class="n">u_component</span><span class="p">,</span> <span class="n">v_component</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">rotate_vectors</span><span class="p">(</span>
                <span class="n">reader_x</span><span class="p">,</span> <span class="n">reader_y</span><span class="p">,</span> <span class="n">u_component</span><span class="p">,</span> <span class="n">v_component</span><span class="p">,</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(</span>
                <span class="n">globe</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">Globe</span><span class="p">(</span><span class="n">datum</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">,</span> <span class="n">ellipse</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">proj4_init</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scalar</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">background</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scalar</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># Ensemble reader, using first member</span>
                <span class="n">scalar</span> <span class="o">=</span> <span class="n">scalar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">u_component</span> <span class="o">=</span> <span class="n">v_component</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Shift one pixel for correct plotting</span>
        <span class="n">reader_x</span> <span class="o">=</span> <span class="n">reader_x</span> <span class="o">-</span> <span class="n">reader</span><span class="o">.</span><span class="n">delta_x</span>
        <span class="n">reader_y</span> <span class="o">=</span> <span class="n">reader_y</span> <span class="o">-</span> <span class="n">reader</span><span class="o">.</span><span class="n">delta_y</span>
        <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">projected</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">reader_y</span><span class="p">[</span><span class="n">reader_y</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">reader_x</span><span class="p">[</span><span class="n">reader_x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">rlons</span><span class="p">,</span> <span class="n">rlats</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">xy2lonlat</span><span class="p">(</span><span class="n">reader_x</span><span class="p">,</span> <span class="n">reader_y</span><span class="p">)</span>
        <span class="n">qrlons</span><span class="p">,</span> <span class="n">qrlats</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">xy2lonlat</span><span class="p">(</span><span class="n">reader_x</span><span class="o">+</span><span class="n">reader</span><span class="o">.</span><span class="n">delta_x</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">reader_y</span><span class="o">+</span><span class="n">reader</span><span class="o">.</span><span class="n">delta_y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rlons</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">:</span>
            <span class="n">rlons</span> <span class="o">=</span> <span class="n">rlons</span> <span class="o">-</span> <span class="mi">360</span>
            <span class="n">qrlons</span> <span class="o">=</span> <span class="n">qrlons</span> <span class="o">-</span> <span class="mi">360</span>
        <span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">rlons</span><span class="p">,</span> <span class="n">rlats</span><span class="p">)</span>
        <span class="n">qmap_x</span><span class="p">,</span> <span class="n">qmap_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">qrlons</span><span class="p">,</span> <span class="n">qrlats</span><span class="p">)</span>

        <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">map_x</span><span class="p">,</span> <span class="n">map_y</span><span class="p">,</span> <span class="n">scalar</span><span class="p">,</span> <span class="n">u_component</span><span class="p">,</span> <span class="n">v_component</span><span class="p">,</span> <span class="n">qmap_x</span><span class="p">,</span> <span class="n">qmap_y</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_density_timeseries"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_density_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">get_density_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get timeseries at a point from pre-calculated density field&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;analysis_file&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Density has to be calculated with get_density_array or animation&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">af</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_file</span><span class="p">)</span>
        <span class="n">lon_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">lon_bin</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lat_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">lat_bin</span><span class="o">.</span><span class="n">values</span>

        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;</span><span class="n">lon_bin</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="ow">or</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="n">lon_bin</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Longitude </span><span class="si">%s</span><span class="s1"> is outside range </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lon_bin</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon_bin</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">&lt;</span><span class="n">lat_bin</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="ow">or</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">&gt;</span><span class="n">lat_bin</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Latitude </span><span class="si">%s</span><span class="s1"> is outside range </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lat_bin</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat_bin</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">t_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon_bin</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat_bin</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="n">t_origin_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">density_origin_marker</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon_bin</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat_bin</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">t_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon_bin</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lat_bin</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">t_total</span> <span class="o">=</span> <span class="n">t_total</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="s1">&#39;lon_bin&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_bin&#39;</span><span class="p">))</span>
            <span class="n">t_origin_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">af</span><span class="o">.</span><span class="n">density_origin_marker</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon_bin</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">lat_bin</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">t_origin_marker</span> <span class="o">=</span> <span class="n">t_origin_marker</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="s1">&#39;lon_bin&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_bin&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lon and lat must have length 1 (point) or 2 (min, max)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">t_total</span><span class="p">,</span> <span class="n">t_origin_marker</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_density_xarray"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_density_xarray">[docs]</a>    <span class="k">def</span> <span class="nf">get_density_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">per_origin_marker</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">xhistogram.xarray</span> <span class="kn">import</span> <span class="n">histogram</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ads</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_file</span><span class="p">)</span>  <span class="c1"># Import from file</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Importing from saved analysis file&#39;</span><span class="p">)</span>
            <span class="n">lon_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">lon_bin</span><span class="o">.</span><span class="n">values</span>
            <span class="n">lat_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">lat_bin</span><span class="o">.</span><span class="n">values</span>
            <span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="s1">&#39;density_origin_marker&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="p">:</span>
                <span class="n">density_origin_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">density_origin_marker</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">density_origin_marker</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">density</span><span class="p">,</span> <span class="n">density_origin_marker</span><span class="p">,</span> <span class="n">lon_bin</span><span class="p">,</span> <span class="n">lat_bin</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Calculate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ads</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>  <span class="c1"># Dataset to store all data, to be saved to self.analysis_file</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating density array, this may take some time...&#39;</span><span class="p">)</span>
            <span class="n">deltalat</span> <span class="o">=</span> <span class="n">pixelsize_m</span><span class="o">/</span><span class="mf">111000.0</span>  <span class="c1"># m to degrees</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lonmin&#39;</span><span class="p">):</span>
                <span class="n">lonmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonmin</span>
                <span class="n">lonmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lonmax</span>
                <span class="n">latmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latmin</span>
                <span class="n">latmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latmax</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding min and max of lon and lat...&#39;</span><span class="p">)</span>
                <span class="n">lonmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
                <span class="n">lonmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
                <span class="n">latmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
                <span class="n">latmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lonmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmin</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lonmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lonmax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;latmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmin</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;latmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latmax</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>

            <span class="n">deltalon</span> <span class="o">=</span> <span class="n">deltalat</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">((</span><span class="n">latmin</span><span class="o">+</span><span class="n">latmax</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">latbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">latmin</span><span class="o">-</span><span class="n">deltalat</span><span class="p">,</span> <span class="n">latmax</span><span class="o">+</span><span class="n">deltalat</span><span class="p">,</span> <span class="n">deltalat</span><span class="p">)</span>
            <span class="n">lonbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lonmin</span><span class="o">-</span><span class="n">deltalon</span><span class="p">,</span> <span class="n">lonmax</span><span class="o">+</span><span class="n">deltalon</span><span class="p">,</span> <span class="n">deltalon</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># element property</span>
                    <span class="c1"># We do not add 2D weights to analysis file, to save space</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>  <span class="c1"># scalar</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">xr</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trajectory&#39;</span><span class="p">],</span>
                                           <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;trajectory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;trajectory&#39;</span><span class="p">]})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># provided array</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trajectory&#39;</span><span class="p">],</span>
                                           <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;trajectory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;trajectory&#39;</span><span class="p">]})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>

            <span class="k">if</span> <span class="n">per_origin_marker</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">max_om</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">origin_marker</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                <span class="n">origin_marker</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_om</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;origin_marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin_marker</span>
                <span class="n">density_om</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span>
                                                   <span class="nb">len</span><span class="p">(</span><span class="n">lonbin</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">latbin</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">origin_marker</span><span class="p">))),</span>
                                          <span class="n">name</span><span class="o">=</span><span class="s1">&#39;density_origin_marker&#39;</span><span class="p">,</span>
                                          <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lon_bin&#39;</span><span class="p">,</span> <span class="s1">&#39;lat_bin&#39;</span><span class="p">,</span> <span class="s1">&#39;origin_marker&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">om</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_om</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">calculating for origin_marker </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">om</span><span class="p">)</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">origin_marker</span><span class="o">==</span><span class="n">om</span><span class="p">),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">origin_marker</span><span class="o">==</span><span class="n">om</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">lonbin</span><span class="p">,</span> <span class="n">latbin</span><span class="p">],</span>
                                  <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                                  <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trajectory&#39;</span><span class="p">])</span>
                    <span class="n">lon_bin</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lon_bin&#39;</span><span class="p">]</span>
                    <span class="n">lat_bin</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lat_bin&#39;</span><span class="p">]</span>
                    <span class="n">density_om</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">om</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="p">[</span><span class="s1">&#39;density_origin_marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">density_om</span>
                <span class="c1"># Computing total density historgram from om-components</span>
                <span class="n">density</span> <span class="o">=</span> <span class="n">density_om</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;origin_marker&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">density</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Adding total density historgram</span>
                <span class="n">density</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">lonbin</span><span class="p">,</span> <span class="n">latbin</span><span class="p">],</span>
                              <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                              <span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trajectory&#39;</span><span class="p">])</span>
                <span class="n">lon_bin</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lon_bin&#39;</span><span class="p">]</span>
                <span class="n">lat_bin</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lat_bin&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">density</span>
                <span class="n">density_om</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lon_bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_bin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;lat_bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_bin</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ads</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_file</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Time to calculate density array: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">density</span><span class="p">,</span> <span class="n">density_om</span><span class="p">,</span> <span class="n">lonbin</span><span class="p">,</span> <span class="n">latbin</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_density_array"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_density_array">[docs]</a>    <span class="k">def</span> <span class="nf">get_density_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">deltalat</span> <span class="o">=</span> <span class="n">pixelsize_m</span><span class="o">/</span><span class="mf">111000.0</span>  <span class="c1"># m to degrees</span>
        <span class="n">deltalon</span> <span class="o">=</span> <span class="n">deltalat</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span>
                                               <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">lat_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">-</span><span class="n">deltalat</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span><span class="o">+</span><span class="n">deltalat</span><span class="p">,</span> <span class="n">deltalat</span><span class="p">)</span>
        <span class="n">lon_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">-</span><span class="n">deltalat</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span><span class="o">+</span><span class="n">deltalon</span><span class="p">,</span> <span class="n">deltalon</span><span class="p">)</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">weight</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lon_submerged</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lat_submerged</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lon_stranded</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lat_stranded</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lon_submerged</span><span class="p">[</span><span class="n">z</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">lat_submerged</span><span class="p">[</span><span class="n">z</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">lon</span><span class="p">[</span><span class="n">z</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">lat</span><span class="p">[</span><span class="n">z</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">lat_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="c1">#.astype(int)</span>
        <span class="n">H_submerged</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">H_stranded</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">strandnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;stranded&#39;</span><span class="p">)</span>
            <span class="n">lon_stranded</span><span class="p">[</span><span class="n">status</span><span class="o">!=</span><span class="n">strandnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">lat_stranded</span><span class="p">[</span><span class="n">status</span><span class="o">!=</span><span class="n">strandnum</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">contains_stranded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">contains_stranded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">weight_array</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">lat</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">H_submerged</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">lon_submerged</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">lat_submerged</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">contains_stranded</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">H_stranded</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">lon_stranded</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">lat_stranded</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">H_submerged</span><span class="p">,</span> <span class="n">H_stranded</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span></div>


<div class="viewcode-block" id="OpenDriftSimulation.get_density_array_proj"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_density_array_proj">[docs]</a>    <span class="k">def</span> <span class="nf">get_density_array_proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="p">,</span> <span class="n">density_proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">llcrnrlon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">llcrnrlat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">urcrnrlon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">urcrnrlat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: should be merged with get_density_array</span>
        <span class="c1"># KFD Jan 2021</span>
        <span class="c1">#</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#deltalat = pixelsize_m/111000.0  # m to degrees</span>
        <span class="c1">#deltalon = deltalat/np.cos(np.radians((np.nanmin(lat) +</span>
        <span class="c1">#                                       np.nanmax(lat))/2))</span>
        <span class="c1">#lat_array = np.arange(np.nanmin(lat)-deltalat,</span>
        <span class="c1">#                      np.nanmax(lat)+deltalat, deltalat)</span>
        <span class="c1">#lon_array = np.arange(np.nanmin(lon)-deltalat,</span>
        <span class="c1">#                      np.nanmax(lon)+deltalon, deltalon)</span>
        <span class="c1">#bins=(lon_array, lat_array)</span>
        <span class="k">if</span> <span class="n">density_proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># add default projection with equal-area property</span>
            <span class="n">density_proj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="s1">&#39;+proj=moll +ellps=WGS84 +lon_0=0.0&#39;</span><span class="p">)</span>
            <span class="n">density_proj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="s1">&#39;+proj=longlat +a=6371229 +no_defs&#39;</span><span class="p">)</span>

        <span class="c1"># create a grid in the specified projection</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">density_proj</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">llcrnrlon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">llcrnrx</span><span class="p">,</span><span class="n">llcrnry</span> <span class="o">=</span> <span class="n">density_proj</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="p">,</span><span class="n">llcrnrlat</span><span class="p">)</span>
            <span class="n">urcrnrx</span><span class="p">,</span><span class="n">urcrnry</span> <span class="o">=</span> <span class="n">density_proj</span><span class="p">(</span><span class="n">urcrnrlon</span><span class="p">,</span><span class="n">urcrnrlat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">llcrnrx</span><span class="p">,</span><span class="n">llcrnry</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">pixelsize_m</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">pixelsize_m</span>
            <span class="n">urcrnrx</span><span class="p">,</span><span class="n">urcrnry</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pixelsize_m</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pixelsize_m</span>

        <span class="n">x_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">llcrnrx</span><span class="p">,</span><span class="n">urcrnrx</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="p">)</span>
        <span class="n">y_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">llcrnry</span><span class="p">,</span><span class="n">urcrnry</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="p">)</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">y_array</span><span class="p">)</span>
        <span class="n">outsidex</span><span class="p">,</span> <span class="n">outsidey</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_array</span><span class="p">)</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_array</span><span class="p">)</span><span class="o">*</span><span class="mf">1.5</span>

        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="n">weight</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#lon_submerged = lon.copy()</span>
        <span class="c1">#lat_submerged = lat.copy()</span>
        <span class="c1">#lon_stranded = lon.copy()</span>
        <span class="c1">#lat_stranded = lat.copy()</span>
        <span class="c1">#lon_submerged[z&gt;=0] = 1000</span>
        <span class="c1">#lat_submerged[z&gt;=0] = 1000</span>
        <span class="c1">#lon[z&lt;0] = 1000</span>
        <span class="c1">#lat[z&lt;0] = 1000</span>
        <span class="c1">#H = np.zeros((len(times), len(lon_array) - 1,</span>
        <span class="c1">#              len(lat_array) - 1))#.astype(int)</span>
        <span class="n">x_submerged</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_submerged</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x_stranded</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_stranded</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x_submerged</span><span class="p">[</span><span class="n">z</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">outsidex</span>
        <span class="n">y_submerged</span><span class="p">[</span><span class="n">z</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">outsidey</span>
        <span class="n">x</span><span class="p">[</span><span class="n">z</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">outsidex</span>
        <span class="n">y</span><span class="p">[</span><span class="n">z</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">outsidey</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="nb">len</span><span class="p">(</span><span class="n">y_array</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="c1">#.astype(int)</span>
        <span class="n">H_submerged</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">H_stranded</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">strandnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;stranded&#39;</span><span class="p">)</span>
            <span class="c1">#lon_stranded[status!=strandnum] = 1000</span>
            <span class="c1">#lat_stranded[status!=strandnum] = 1000</span>
            <span class="n">x_stranded</span><span class="p">[</span><span class="n">status</span><span class="o">!=</span><span class="n">strandnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">outsidex</span>
            <span class="n">y_stranded</span><span class="p">[</span><span class="n">status</span><span class="o">!=</span><span class="n">strandnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">outsidey</span>
            <span class="n">contains_stranded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">contains_stranded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">weight_array</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">H_submerged</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x_submerged</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">y_submerged</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">contains_stranded</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">H_stranded</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:],</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x_stranded</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">y_stranded</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">density_proj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Y</span><span class="p">,</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y_array</span><span class="p">,</span> <span class="n">x_array</span><span class="p">)</span>
            <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span> <span class="o">=</span> <span class="n">density_proj</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">H_submerged</span><span class="p">,</span> <span class="n">H_stranded</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_residence_time"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_residence_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_residence_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="p">):</span>
        <span class="n">H</span><span class="p">,</span><span class="n">H_sub</span><span class="p">,</span> <span class="n">H_str</span><span class="p">,</span><span class="n">lon_array</span><span class="p">,</span><span class="n">lat_array</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_density_array</span><span class="p">(</span><span class="n">pixelsize_m</span><span class="p">)</span>
        <span class="n">residence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">residence</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.write_netcdf_density_map"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.write_netcdf_density_map">[docs]</a>    <span class="k">def</span> <span class="nf">write_netcdf_density_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write netCDF file with map of particles densities&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">pixelsize_m</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>
            <span class="n">latspan</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">pixelsize_m</span><span class="o">=</span><span class="mi">30</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.05</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.1</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">300</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.3</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.7</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">2000</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">4000</span>

        <span class="n">H</span><span class="p">,</span> <span class="n">H_submerged</span><span class="p">,</span> <span class="n">H_stranded</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_density_array</span><span class="p">(</span><span class="n">pixelsize_m</span><span class="p">)</span>
        <span class="n">lon_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lon_array</span><span class="p">[</span><span class="mi">1</span><span class="p">::])</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">lat_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_array</span><span class="p">[</span><span class="mi">1</span><span class="p">::])</span><span class="o">/</span><span class="mi">2</span>

        <span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_array</span><span class="p">))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_array</span><span class="p">))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="s1">&#39;seconds since 1970-01-01 00:00:00&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">timestr</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">timestr</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
        <span class="c1"># Projection</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;projection_lonlat&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;projection_lonlat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">grid_mapping_name</span> <span class="o">=</span> \
            <span class="s1">&#39;latitude_longitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;projection_lonlat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">earth_radius</span> <span class="o">=</span> <span class="mf">6371229.</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;projection_lonlat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">proj4</span> <span class="o">=</span> \
            <span class="s1">&#39;+proj=longlat +a=6371229 +no_defs&#39;</span>
        <span class="c1"># Coordinates</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">lon_array</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">short_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">lat_array</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">short_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span>
        <span class="c1"># Density</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;density_surface&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">H</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">H</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Detection probability&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">grid_mapping</span> <span class="o">=</span> <span class="s1">&#39;projection_lonlat&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="c1"># Density submerged</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">))</span>
        <span class="n">H_sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">H_submerged</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">H_sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">H_sub</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">H_sub</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">H_sub</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Detection probability submerged&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">grid_mapping</span> <span class="o">=</span> <span class="s1">&#39;projection_lonlat&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="c1"># Density stranded</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">))</span>
        <span class="n">H_stranded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">H_stranded</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">H_stranded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">H_stranded</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">H_stranded</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">H_stranded</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Detection probability stranded&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">grid_mapping</span> <span class="o">=</span> <span class="s1">&#39;projection_lonlat&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

        <span class="n">nc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.write_netcdf_density_map_proj"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.write_netcdf_density_map_proj">[docs]</a>    <span class="k">def</span> <span class="nf">write_netcdf_density_map_proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pixelsize_m</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">density_proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">llcrnrlon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">urcrnrlon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write netCDF file with map of particles densities for a given projection or area&#39;&#39;&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: should be merged with write_netcdf_density_map_proj</span>
        <span class="c1"># KFD Jan 2021</span>
        <span class="c1">#</span>

        <span class="k">if</span> <span class="n">pixelsize_m</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>
            <span class="n">latspan</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">pixelsize_m</span><span class="o">=</span><span class="mi">30</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.05</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.1</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">300</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.3</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">500</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mf">.7</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">2000</span>
            <span class="k">if</span> <span class="n">latspan</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">pixelsize_m</span> <span class="o">=</span> <span class="mi">4000</span>

        <span class="k">if</span> <span class="n">density_proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># add default projection with equal-area property</span>
            <span class="n">density_proj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="s1">&#39;+proj=moll +ellps=WGS84 +lon_0=0.0&#39;</span><span class="p">)</span>


        <span class="n">H</span><span class="p">,</span> <span class="n">H_submerged</span><span class="p">,</span> <span class="n">H_stranded</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">,</span> <span class="n">lat_array</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_density_array_proj</span><span class="p">(</span><span class="n">pixelsize_m</span><span class="o">=</span><span class="n">pixelsize_m</span><span class="p">,</span>
                                       <span class="n">density_proj</span><span class="o">=</span><span class="n">density_proj</span><span class="p">,</span>
                                       <span class="n">llcrnrlon</span><span class="o">=</span><span class="n">llcrnrlon</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">llcrnrlat</span><span class="p">,</span>
                                       <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">urcrnrlon</span><span class="p">,</span> <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">urcrnrlat</span><span class="p">)</span>
        <span class="c1"># calculate center coordinates</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lon_array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">lat_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">lon_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lon_array</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">lat_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_array</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.</span>

        <span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">date2num</span>
        <span class="n">nc</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">lon_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">lon_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="s1">&#39;seconds since 1970-01-01 00:00:00&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">timestr</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">timestr</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
        <span class="c1"># Projection</span>

        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;projection&#39;</span><span class="p">,</span> <span class="s1">&#39;i8&#39;</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">proj4</span> <span class="o">=</span> <span class="n">density_proj</span><span class="o">.</span><span class="n">definition_string</span><span class="p">()</span>
        <span class="c1"># Coordinates</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">lon_array</span><span class="o">.</span><span class="n">T</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">short_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">lat_array</span><span class="o">.</span><span class="n">T</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">short_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span>

        <span class="c1"># Density</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;density_surface&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">H</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">H</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Detection probability&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">grid_mapping</span> <span class="o">=</span> <span class="s1">&#39;projection&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_surface&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="c1"># Density submerged</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">H_sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">H_submerged</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">H_sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">H_sub</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">H_sub</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">H_sub</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Detection probability submerged&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">grid_mapping</span> <span class="o">=</span> <span class="s1">&#39;projection&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_submerged&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="c1"># Density stranded</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">,</span> <span class="s1">&#39;u1&#39;</span><span class="p">,</span>
                          <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">))</span>
        <span class="n">H_stranded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">H_stranded</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">H_stranded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">H_stranded</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span> <span class="n">H_stranded</span><span class="p">)</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">H_stranded</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Detection probability stranded&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">grid_mapping</span> <span class="o">=</span> <span class="s1">&#39;projection&#39;</span>
        <span class="n">nc</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;density_stranded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

        <span class="n">nc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.write_geotiff"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.write_geotiff">[docs]</a>    <span class="k">def</span> <span class="nf">write_geotiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">pixelsize_km</span><span class="o">=</span><span class="mf">.2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write one GeoTiff image per timestep.</span>

<span class="sd">        filename should contain date identifiers, e.g. &#39;img_%Y%m%d_%H%M.tif&#39;</span>
<span class="sd">        https://docs.python.org/2/library/datetime.html#strftime-and-strptime-behavior</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">osr</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;GDAL is needed to write geotiff images.&#39;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromEPSG</span><span class="p">(</span><span class="mi">4326</span><span class="p">)</span>
        <span class="n">colortable</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">ColorTable</span><span class="p">()</span>
        <span class="n">colortable</span><span class="o">.</span><span class="n">SetColorEntry</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">colortable</span><span class="o">.</span><span class="n">SetColorEntry</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">colortable</span><span class="o">.</span><span class="n">SetColorEntry</span><span class="p">(</span><span class="mi">2</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">colortable</span><span class="o">.</span><span class="n">SetColorEntry</span><span class="p">(</span><span class="mi">3</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
        <span class="n">colortable</span><span class="o">.</span><span class="n">SetColorEntry</span><span class="p">(</span><span class="mi">4</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

        <span class="n">lon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">deltalat</span> <span class="o">=</span> <span class="n">pixelsize_km</span><span class="o">/</span><span class="mf">111.0</span>  <span class="c1"># km to degrees</span>
        <span class="n">deltalon</span> <span class="o">=</span> <span class="n">deltalat</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">((</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">lat_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">deltalat</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">deltalat</span><span class="p">,</span> <span class="n">deltalat</span><span class="p">)</span>
        <span class="n">lon_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">deltalat</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">deltalon</span><span class="p">,</span> <span class="n">deltalon</span><span class="p">)</span>
        <span class="n">ilon</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">lon</span><span class="o">-</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">deltalon</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ilat</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">lat</span><span class="o">-</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">deltalat</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># Setting masked values to zero, for use as indices</span>
        <span class="n">ilon</span><span class="p">[</span><span class="n">ilon</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ilat</span><span class="p">[</span><span class="n">ilat</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">status</span><span class="p">[</span><span class="n">ilon</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_array</span><span class="p">),</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">lat_array</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">geotransform</span> <span class="o">=</span> <span class="p">[</span><span class="n">lon_array</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">deltalon</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">lat_array</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">deltalat</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ilon</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">ilat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]]</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">filename_i</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">filename_i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_array</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_array</span><span class="p">),</span>
                               <span class="mi">1</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Byte</span><span class="p">,</span> <span class="p">)</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">srs</span><span class="o">.</span><span class="n">ExportToWkt</span><span class="p">())</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geotransform</span><span class="p">)</span>
            <span class="n">outband</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outband</span><span class="o">.</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">outband</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="n">outband</span><span class="o">.</span><span class="n">SetColorTable</span><span class="p">(</span><span class="n">colortable</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_time_array"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_time_array">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of output times of last run.&quot;&quot;&quot;</span>

        <span class="c1"># Making sure start_time is datetime, and not cftime object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="n">td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span>
        <span class="n">time_array</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">td</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                      <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">)]</span>
        <span class="n">time_array_relative</span> <span class="o">=</span> <span class="p">[</span><span class="n">td</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">time_array</span><span class="p">,</span> <span class="n">time_array_relative</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.plot_environment"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.plot_environment">[docs]</a>    <span class="k">def</span> <span class="nf">plot_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot mean wind and current velocities of element of last run.&quot;&quot;&quot;</span>
        <span class="n">x_wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;x_wind&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;y_wind&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_wind</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_wind</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x_sea_water_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;x_sea_water_velocity&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_sea_water_velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;y_sea_water_velocity&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_sea_water_velocity</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_sea_water_velocity</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time</span><span class="p">,</span> <span class="n">time_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_array</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">3600.</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_relative</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">wind</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Wind speed&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Wind speed  [m/s]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">wind</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.1</span><span class="p">])</span>

        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Current speed&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Current speed  [m/s]&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">current</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tl</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time  [hours]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.plot_property"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.plot_property">[docs]</a>    <span class="k">def</span> <span class="nf">plot_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Basic function to plot time series of any element properties.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">dates</span>

        <span class="n">hfmt</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %Y %H:%M&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">hfmt</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="c1"># In case start_time is unsupported cftime</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">start_time</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">start_time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">start_time</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                              <span class="n">start_time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">start_time</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">start_time</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span>
                 <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">)]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">mean</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># Taking average over elements</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time  [UTC]&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">  [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_property"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">propname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get property from history, sorted by status.&quot;&quot;&quot;</span>
        <span class="n">index_of_first</span><span class="p">,</span> <span class="n">index_of_last</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">index_of_activation_and_deactivation</span><span class="p">()</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">propname</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Fill arrays with last value before deactivation</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">index_of_last</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">index_of_last</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">prop</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">index_of_last</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">index_of_last</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_trajectory_lengths"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_trajectory_lengths">[docs]</a>    <span class="k">def</span> <span class="nf">get_trajectory_lengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate lengths and speeds along trajectories.&quot;&quot;&quot;</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>
        <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">distances</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">lons</span><span class="p">[</span><span class="mi">1</span><span class="p">::,:],</span> <span class="n">lats</span><span class="p">[</span><span class="mi">1</span><span class="p">::,:])</span>
        <span class="n">distances</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">distances</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">speeds</span> <span class="o">=</span> <span class="n">distances</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">distances</span><span class="p">[</span><span class="n">speeds</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># TODO: need better way to mask invalid distances</span>
        <span class="n">speeds</span><span class="p">[</span><span class="n">speeds</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1">#       due to masked lons/lats arrays</span>
        <span class="n">total_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>

        <span class="k">return</span> <span class="n">total_length</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">speeds</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.update_positions"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.update_positions">[docs]</a>    <span class="k">def</span> <span class="nf">update_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_vel</span><span class="p">,</span> <span class="n">y_vel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move particles according to given velocity components.</span>

<span class="sd">        This method shall account for projection metrics (a distance</span>
<span class="sd">        on a map projection does not necessarily correspond to the same</span>
<span class="sd">        distance over true ground (not yet implemented).</span>

<span class="sd">        Arguments:</span>
<span class="sd">            x_vel and v_vel: floats, velocities in m/s of particle along</span>
<span class="sd">                             x- and y-axes of the inherit SRS (proj4).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">geod</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>

        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x_vel</span><span class="p">,</span> <span class="n">y_vel</span><span class="p">))</span>  <span class="c1"># Direction of motion</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_vel</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y_vel</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Velocity in m/s</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">moving</span>  <span class="c1"># Do not move frosen elements</span>

        <span class="c1"># Calculate new positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">back_az</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">fwd</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
            <span class="n">azimuth</span><span class="p">,</span> <span class="n">velocity</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

        <span class="c1"># Check that new positions are valid</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Invalid new coordinates:&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Quitting&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.__repr__"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.__repr__">[docs]</a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation providing overview of model status.&quot;&quot;&quot;</span>
        <span class="n">outStr</span> <span class="o">=</span> <span class="s1">&#39;===========================</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">):</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">performance</span><span class="p">()</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;===========================</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;Model:</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> \
            <span class="s1">&#39;     (OpenDrift version </span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">opendrift</span><span class="o">.</span><span class="n">__version__</span>
        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1"> active </span><span class="si">%s</span><span class="s1"> particles  (</span><span class="si">%s</span><span class="s1"> deactivated, </span><span class="si">%s</span><span class="s1"> scheduled)</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_elements_active</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_deactivated</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_elements_scheduled</span><span class="p">())</span>
        <span class="n">variable_groups</span><span class="p">,</span> <span class="n">reader_groups</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reader_groups</span><span class="p">()</span>
        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;-------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;Environment variables:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">variableGroup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variable_groups</span><span class="p">):</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;  -----</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">readerGroup</span> <span class="o">=</span> <span class="n">reader_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">variableGroup</span><span class="p">):</span>
                <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">variable</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reader</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">readerGroup</span><span class="p">):</span>
                <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;     &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span> <span class="o">+</span> <span class="n">reader</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_variables</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;  -----</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;Readers not added for the following variables:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">missing_variables</span><span class="p">()):</span>
                <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">variable</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">lazy_readers</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">is_lazy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lazy_readers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;---</span><span class="se">\n</span><span class="s1">Lazy readers:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">lr</span> <span class="ow">in</span> <span class="n">lazy_readers</span><span class="p">:</span>
                <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">lr</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;discarded_readers&#39;</span><span class="p">):</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Discarded readers:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discarded_readers</span><span class="p">:</span>
                <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">dr</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Time:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Start: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Present: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;time_step&#39;</span><span class="p">):</span>
                <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calculation steps: </span><span class="si">%i</span><span class="s1"> * </span><span class="si">%s</span><span class="s1"> - total time: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">steps_calculation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
                <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Output steps: </span><span class="si">%i</span><span class="s1"> * </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">steps_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step_output</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;messages&#39;</span><span class="p">):</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;-------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">outStr</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_messages</span><span class="p">()</span>
        <span class="n">outStr</span> <span class="o">+=</span> <span class="s1">&#39;===========================</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">outStr</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.store_message"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.store_message">[docs]</a>    <span class="k">def</span> <span class="nf">store_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store important messages to be displayed to user at end.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;messages&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.get_messages"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.get_messages">[docs]</a>    <span class="k">def</span> <span class="nf">get_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Report any messages stored during simulation.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;messages&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.add_halo_readers"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.add_halo_readers">[docs]</a>    <span class="k">def</span> <span class="nf">add_halo_readers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adding some Thredds and file readers in prioritised order&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_readers_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_data_folder</span><span class="p">()</span> <span class="o">+</span>
            <span class="s1">&#39;../../opendrift/scripts/data_sources.txt&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OpenDriftSimulation._save_animation"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation._save_animation">[docs]</a>    <span class="k">def</span> <span class="nf">_save_animation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anim</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;sphinx_gallery&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="c1"># This assumes that the calling script is two frames up in the stack. If</span>
            <span class="c1"># _save_animation is called through a more deeply nested method, it will</span>
            <span class="c1"># not give the correct result.</span>
            <span class="n">caller</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">caller</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">caller</span><span class="o">.</span><span class="n">filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Calling script is string input (e.g. from ..plot::)</span>
            <span class="k">if</span> <span class="n">caller</span> <span class="o">==</span> <span class="s1">&#39;&lt;string&gt;&#39;</span><span class="p">:</span>
                <span class="n">caller</span> <span class="o">=</span> <span class="s1">&#39;plot_directive&#39;</span>
                <span class="n">adir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s1">&#39;../source/gallery/animations&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="s1">&#39;../docs/source/gallery/animations&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">OpenDriftSimulation</span><span class="p">,</span> <span class="s1">&#39;__anim_no__&#39;</span><span class="p">):</span>
                <span class="n">OpenDriftSimulation</span><span class="o">.</span><span class="n">__anim_no__</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>

            <span class="k">if</span> <span class="n">caller</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="n">OpenDriftSimulation</span><span class="o">.</span><span class="n">__anim_no__</span><span class="p">:</span>
                <span class="n">OpenDriftSimulation</span><span class="o">.</span><span class="n">__anim_no__</span><span class="p">[</span><span class="n">caller</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">adir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.gif&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">OpenDriftSimulation</span><span class="o">.</span><span class="n">__anim_no__</span><span class="p">[</span><span class="n">caller</span><span class="p">])</span>
            <span class="n">OpenDriftSimulation</span><span class="o">.</span><span class="n">__anim_no__</span><span class="p">[</span><span class="n">caller</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">adir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving animation to &#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gif&#39;</span><span class="p">:</span>  <span class="c1"># GIF</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Making animated gif...&#39;</span><span class="p">)</span>
                <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;imagemagick&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># MP4</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">FFwriter</span><span class="o">=</span><span class="n">animation</span><span class="o">.</span><span class="n">FFMpegWriter</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                        <span class="n">codec</span><span class="o">=</span><span class="s1">&#39;libx264&#39;</span><span class="p">,</span> <span class="n">bitrate</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span>
                        <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-profile:v&#39;</span><span class="p">,</span> <span class="s1">&#39;baseline&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;-vf&#39;</span><span class="p">,</span> <span class="s1">&#39;crop=trunc(iw/2)*2:trunc(ih/2)*2&#39;</span><span class="p">,</span>  <span class="c1"># cropping 1 pixel if not even</span>
                                    <span class="s1">&#39;-pix_fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;yuv420p&#39;</span><span class="p">,</span> <span class="s1">&#39;-an&#39;</span><span class="p">])</span>
                    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">FFwriter</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Animation might not be HTML5 compatible.&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not save animation:&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

        <span class="k">if</span> <span class="s1">&#39;sphinx_gallery&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.calculate_ftle"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.calculate_ftle">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_ftle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">RLCS</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ALCS</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No reader provided, using first available:&#39;</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readers</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">):</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">reader</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Proj</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">proj</span>

        <span class="kn">from</span> <span class="nn">opendrift.models.physics_methods</span> <span class="kn">import</span> <span class="n">ftle</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">domain</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="n">reader</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">domain</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">start_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="p">]</span>
        <span class="c1"># dictionary to hold LCS calculation</span>
        <span class="n">lcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">lons</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span><span class="n">lats</span><span class="p">}</span>
        <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;RLCS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)))</span>
        <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating LCS for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="c1"># Forwards</span>
            <span class="k">if</span> <span class="n">RLCS</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                   <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">time_step</span><span class="o">=</span><span class="n">time_step</span><span class="p">)</span>
                <span class="n">f_x1</span><span class="p">,</span> <span class="n">f_y1</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;RLCS&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">ftle</span><span class="p">(</span><span class="n">f_x1</span><span class="o">-</span><span class="n">X</span><span class="p">,</span> <span class="n">f_y1</span><span class="o">-</span><span class="n">Y</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
            <span class="c1"># Backwards</span>
            <span class="k">if</span> <span class="n">ALCS</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seed_elements</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                   <span class="n">time</span><span class="o">=</span><span class="n">t</span><span class="o">+</span><span class="n">duration</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">time_step</span><span class="o">=-</span><span class="n">time_step</span><span class="p">)</span>
                <span class="n">b_x1</span><span class="p">,</span> <span class="n">b_y1</span> <span class="o">=</span> <span class="n">proj</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">ftle</span><span class="p">(</span><span class="n">b_x1</span><span class="o">-</span><span class="n">X</span><span class="p">,</span> <span class="n">b_y1</span><span class="o">-</span><span class="n">Y</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;RLCS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;RLCS&#39;</span><span class="p">])</span>
        <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">])</span>
        <span class="c1"># Flipping ALCS left-right. Not sure why this is needed</span>
        <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcs</span><span class="p">[</span><span class="s1">&#39;ALCS&#39;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">lcs</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.center_of_gravity"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.center_of_gravity">[docs]</a>    <span class="k">def</span> <span class="nf">center_of_gravity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onlysurface</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate center of mass and variance of all elements</span>
<span class="sd">        returns  (lon,lat), variance</span>
<span class="sd">        where (lon,lat) are the coordinates of the center of mass as</span>
<span class="sd">        function of time&quot;&quot;&quot;</span>
        <span class="c1">#lon,lat = self.get_property(&#39;lon&#39;)[0], self.get_property(&#39;lat&#39;)[0]</span>
        <span class="n">lon</span><span class="p">,</span><span class="n">lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_latlon</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">onlysurface</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">submerged</span> <span class="o">=</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">submerged</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">submerged</span><span class="p">)</span>
        <span class="c1"># center of gravity:</span>
        <span class="n">x_m</span><span class="p">,</span> <span class="n">y_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">proj_latlon</span><span class="p">(</span><span class="n">x_m</span><span class="p">,</span> <span class="n">y_m</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1"># variance:</span>
        <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">x_m</span><span class="o">*</span><span class="n">one</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">y_m</span><span class="o">*</span><span class="n">one</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">center</span><span class="p">,</span><span class="n">variance</span></div>

<div class="viewcode-block" id="OpenDriftSimulation.reset"><a class="viewcode-back" href="../../../autoapi/opendrift/models/basemodel/index.html#opendrift.models.basemodel.OpenDriftSimulation.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Preparing OpenDrift object for new run&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Nothing to reset&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="s1">&#39;elements&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="c1">#del self.start_time</span>
        <span class="c1">#del self.history</span>
        <span class="c1">#del self.elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements_deactivated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="p">()</span>  <span class="c1"># Empty array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ElementType</span><span class="p">()</span>  <span class="c1"># Empty array</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Knut-Frode Dagestad (knutfd@met.no) and Gaute Hope (gauteh@met.no)..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>