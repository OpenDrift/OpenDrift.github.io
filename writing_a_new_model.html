

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to write a new module &mdash; OpenDrift  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/gallery.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Gallery" href="gallery_gen/index.html" />
    <link rel="prev" title="How to choose which model to use" href="choosing_a_model.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> OpenDrift
          

          
            
            <img src="_static/opendrift_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction to OpenDrift</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing OpenDrift</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="theory/index.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="choosing_a_model.html">How to choose which model to use</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to write a new module</a></li>
<li class="toctree-l1"><a class="reference internal" href="gallery_gen/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="oil_types.html">Oil types</a></li>
<li class="toctree-l1"><a class="reference internal" href="interaction_with_coastline.html">Interaction with coastline</a></li>
<li class="toctree-l1"><a class="reference internal" href="autoapi/index.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">OpenDrift</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>How to write a new module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/writing_a_new_model.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-write-a-new-module">
<h1>How to write a new module<a class="headerlink" href="#how-to-write-a-new-module" title="Permalink to this headline">¶</a></h1>
<p>The best way to get started in developing a new model, is to copy and modify an existing working model/module (e.g. [oceandrift](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/oceandrift.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/oceandrift.py</a>)) or look at the [model_template](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/model_template.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/model_template.py</a>) which contains instructions/comments. A general explanation is given below.</p>
<p>The main class of the OpenDrift framework is the <strong>OpenDriftSimulation</strong> class in the module [basemodel.py](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/basemodel.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/basemodel.py</a>), stored in the folder [models](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/</a>).</p>
<p>A purpose specific trajectory model is made by subclassing <strong>OpenDriftSimulation</strong> (or any of its subclasses/models), mainly by:
* defining (or importing/reusing) a particle/element type (e.g. oil particle, larvae particle…), by specifying names and default values of the (additional) properties the elements shall have.
* defining which environment variables (wind, waves, current…) shall be needed by the model to update positions and properties of elements (below).</p>
<blockquote>
<div><ul class="simple">
<li><p>these environment variables are obtained by [Readers](<a class="reference external" href="https://github.com/knutfrode/opendrift/wiki/Data-model">https://github.com/knutfrode/opendrift/wiki/Data-model</a>); however, when writing a model/module one do not need to worry about how environment variables are obtained.</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>defining a class method <strong>update()</strong> to be called at each model time step.</p></li>
</ul>
<p>The method <strong>update()</strong> will in principle do three different things, regardless of the specific application:</p>
<p>### 1. Moving elements</p>
<p>The positions of elements are stored as the element properties <code class="docutils literal notranslate"><span class="pre">`longitude`</span></code> and <code class="docutils literal notranslate"><span class="pre">`latitude`</span></code> with units of degrees, as well as the vertical coordinate <code class="docutils literal notranslate"><span class="pre">`z`</span></code> with units of meters, negative in the ocean. These properties might in principle be modified directly within the update() method, however, it is both safer and simpler to rather use the built in convenience methods, such as</p>
<blockquote>
<div><p>self.update_positions(x_velocity, y_velocity)</p>
</div></blockquote>
<p>This method takes care of e.g. rotation of vectors from the specific x-y coordinate system of the simulation (Pyproj projection) to determine the correct update of the position (longitude and latitude), also taking the simulation time_step into account.
The <code class="docutils literal notranslate"><span class="pre">`x_velocity`</span></code> and <code class="docutils literal notranslate"><span class="pre">`y_velocity`</span></code> might be any velocity provided by the readers (currents, wind, stokes drift…) possibly scaled by the model application (e.g. 0.02 times the wind, which is often used for wind drift at ocean surface).</p>
<p>By inheritance, models may also reuse higher level advection methods inherited from their superclasses. E.g. the model [OceanDrift](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/oceandrift.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/oceandrift.py</a>) uses very simple methods which takes care of everything needed for a correct and efficient advection:</p>
<blockquote>
<div><p># Simply move particles with ambient current
self.advect_ocean_current()</p>
<p># Advect particles due to wind drag (according to specified wind_drift_factor)
self.advect_wind()</p>
</div></blockquote>
<p>Notice that these (convenience) methods are inherited in the specific model [OceanDrift](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/oceandrift.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/oceandrift.py</a>) from the generic model [OpenDrift](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/opendrift.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/opendrift.py</a>), which again inherits them from the helper class [PhysicsMethods](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/physics_methods.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/physics_methods.py</a>).
Reusing functionality by inheritance makes it simpler and faster to develop and maintain new models and functionality.
The vertical coordinate (z) is modified e.g. by turbulence scheme [in 3D models](<a class="reference external" href="https://github.com/knutfrode/opendrift/wiki/How-to-choose-which-model-to-use">https://github.com/knutfrode/opendrift/wiki/How-to-choose-which-model-to-use</a>).</p>
<p>### 2. Modifying element properties</p>
<dl class="simple">
<dt>Element properties may be modified freely and directly within the method <strong>update()</strong>. The main “resources” available are the Python recarrays:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">`self.elements`</span></code> which has any element properties (mass, length, orientation, age…) as attributes, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">`self.environment`</span></code> which has any environment variables (x_wind, y_wind, sea_water_temperature) as attributes.</p></li>
</ul>
</dd>
</dl>
<p>E.g. if one (for some reason) would like to set the length of the elements equal to half of the seawater temperature:</p>
<blockquote>
<div><p>self.elements.length = self.environment.sea_water_temperature / 2</p>
</div></blockquote>
<p>Inheritance is also used for modifying properties, e.g. [OpenOil3D](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/openoil3D.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/openoil3D.py</a>) which inherits the full oil weathering from [OpenOil](<a class="reference external" href="https://github.com/knutfrode/opendrift/blob/master/opendrift/models/openoil.py">https://github.com/knutfrode/opendrift/blob/master/opendrift/models/openoil.py</a>), and simply calls the method self.oil_weathering() within its own <strong>update()</strong> method (in addition to the vertical advection not found in the 3D version OpenOil).</p>
<p>### 3. Deactivating elements</p>
<p>Deactivation of elements must always be done with the special class method <code class="docutils literal notranslate"><span class="pre">`deactivate_elements(indices,</span> <span class="pre">reason)`</span></code>
Elements may be deactivated for any reason as determined by the model developer, and an arbitrary text string is provided as explanation. E.g. if one want to deactivate all elements whose mass is below, say 0.5 kg:</p>
<blockquote>
<div><p>self.deactivate_elements(self.elements.mass &lt; 0.5, reason=’vanished’)</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">`self.elements.mass`</span></code> is a numpy array with one value per element/particle, and thus <code class="docutils literal notranslate"><span class="pre">`self.elements.mass</span> <span class="pre">&lt;</span> <span class="pre">0.5`</span></code> returns the indices of the elements for which the mass is below 0.5 kg (units are specified in element type declaration above).
The text string <code class="docutils literal notranslate"><span class="pre">`reason`</span></code> serves as an explanation of why the element was deactivated, and is used e.g. for labeling figures and when analysing results. The element property <code class="docutils literal notranslate"><span class="pre">`status`</span></code> will be updated accordingly, as the element is deactivated. All elements have status 0 (integer) as default, meaning <code class="docutils literal notranslate"><span class="pre">`active`</span></code>. Each time (in method <strong>update()</strong>) a new deactivation reason is used, the string (reason) is added to the list <code class="docutils literal notranslate"><span class="pre">`status_categories`</span></code>. The list of deactivation reason is also added to the metadata in exported netCDF files, e.g:</p>
<blockquote>
<div><dl class="simple">
<dt>int status(trajectory, time) ;</dt><dd><p>status:flag_values = 0, 1, 2 ;
status:flag_meanings = “active evaporated stranded” ;</p>
</dd>
</dl>
</div></blockquote>
<p>where one can see that elements have been deactivated for two different reasons (‘evaporated’ <strong>1</strong>, and ‘stranded’ <strong>2</strong>).</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gallery_gen/index.html" class="btn btn-neutral float-right" title="Gallery" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="choosing_a_model.html" class="btn btn-neutral float-left" title="How to choose which model to use" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Knut-Frode Dagestad et. al.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>